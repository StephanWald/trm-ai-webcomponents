---
phase: 04-markdown-editor-component
plan: 04
type: execute
wave: 4
depends_on: ["04-03"]
files_modified:
  - src/components/sp-markdown-editor/utils/history-manager.spec.ts
  - src/components/sp-markdown-editor/utils/toolbar-actions.spec.ts
  - src/components/sp-markdown-editor/utils/markdown-renderer.spec.ts
  - src/components/sp-markdown-editor/utils/file-handler.spec.ts
  - src/components/sp-markdown-editor/utils/speech-recognizer.spec.ts
  - src/components/sp-markdown-editor/sp-markdown-editor.spec.ts
  - src/components/sp-markdown-editor/sp-markdown-editor.e2e.ts
autonomous: true

must_haves:
  truths:
    - "All utility classes have unit tests covering core behavior and edge cases"
    - "Component spec tests cover props, state, events, methods, and mode switching"
    - "E2E tests cover rendering, toolbar interactions, keyboard shortcuts, and mode switching"
    - "All tests pass with zero failures"
    - "No regressions in existing test suites (sp-example, sp-org-chart, sp-walkthrough)"
  artifacts:
    - path: "src/components/sp-markdown-editor/utils/history-manager.spec.ts"
      provides: "Unit tests for undo/redo stack"
      contains: "describe.*HistoryManager"
    - path: "src/components/sp-markdown-editor/utils/toolbar-actions.spec.ts"
      provides: "Unit tests for all formatting operations"
      contains: "describe.*ToolbarActions"
    - path: "src/components/sp-markdown-editor/utils/markdown-renderer.spec.ts"
      provides: "Unit tests for markdown rendering pipeline"
      contains: "describe.*MarkdownRenderer"
    - path: "src/components/sp-markdown-editor/utils/file-handler.spec.ts"
      provides: "Unit tests for import/export"
      contains: "describe.*FileHandler"
    - path: "src/components/sp-markdown-editor/utils/speech-recognizer.spec.ts"
      provides: "Unit tests for speech API wrapper"
      contains: "describe.*SpeechRecognizer"
    - path: "src/components/sp-markdown-editor/sp-markdown-editor.spec.ts"
      provides: "Component spec tests for props, state, events, methods"
      contains: "describe.*sp-markdown-editor"
    - path: "src/components/sp-markdown-editor/sp-markdown-editor.e2e.ts"
      provides: "E2E tests for rendering and interactions"
      contains: "describe.*sp-markdown-editor"
  key_links:
    - from: "sp-markdown-editor.spec.ts"
      to: "sp-markdown-editor.tsx"
      via: "newSpecPage imports and tests component"
      pattern: "newSpecPage"
    - from: "sp-markdown-editor.e2e.ts"
      to: "sp-markdown-editor.tsx"
      via: "page.setContent renders component for E2E testing"
      pattern: "page\\.setContent"
---

<objective>
Create comprehensive test suite for sp-markdown-editor: unit tests for all 5 utility classes, Jest spec tests for the component, and Playwright E2E tests for rendering and interactions. Follow established testing patterns from sp-org-chart and sp-walkthrough.

Purpose: Satisfies TEST-01 and TEST-02 for the markdown editor. Validates all MDED requirements through automated testing.
Output: Full test coverage with all tests passing, no regressions.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-markdown-editor-component/04-01-SUMMARY.md
@.planning/phases/04-markdown-editor-component/04-02-SUMMARY.md
@.planning/phases/04-markdown-editor-component/04-03-SUMMARY.md
@src/components/sp-markdown-editor/sp-markdown-editor.tsx
@src/components/sp-markdown-editor/utils/history-manager.ts
@src/components/sp-markdown-editor/utils/toolbar-actions.ts
@src/components/sp-markdown-editor/utils/markdown-renderer.ts
@src/components/sp-markdown-editor/utils/file-handler.ts
@src/components/sp-markdown-editor/utils/speech-recognizer.ts
@src/components/sp-org-chart/sp-org-chart.spec.ts (spec test patterns)
@src/components/sp-org-chart/sp-org-chart.e2e.ts (E2E test patterns)
@src/components/sp-walkthrough/sp-walkthrough.spec.ts (spec test patterns)
@src/components/sp-walkthrough/sp-walkthrough.e2e.ts (E2E test patterns)
@src/components/sp-walkthrough/utils/timeline-engine.spec.ts (utility test patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unit tests for all utility classes</name>
  <files>
    src/components/sp-markdown-editor/utils/history-manager.spec.ts
    src/components/sp-markdown-editor/utils/toolbar-actions.spec.ts
    src/components/sp-markdown-editor/utils/markdown-renderer.spec.ts
    src/components/sp-markdown-editor/utils/file-handler.spec.ts
    src/components/sp-markdown-editor/utils/speech-recognizer.spec.ts
  </files>
  <action>
    Follow the utility testing patterns established in sp-walkthrough (timeline-engine.spec.ts, overlay-manager.spec.ts, selector-generator.spec.ts).

    **history-manager.spec.ts** (~15 tests):
    - push(): adds state to history
    - push(): truncates forward history when not at end
    - push(): enforces maxStates limit (shifts oldest)
    - undo(): returns previous state
    - undo(): returns null at beginning of history
    - redo(): returns next state
    - redo(): returns null at end of history
    - undo then redo: round-trips correctly
    - push after undo: clears redo history
    - canUndo(): returns correct boolean
    - canRedo(): returns correct boolean
    - clear(): resets history
    - getCurrent(): returns current state
    - Custom maxStates: respects constructor parameter
    - Edge case: empty history undo/redo return null

    **toolbar-actions.spec.ts** (~20 tests):
    - bold(): wraps selection with **
    - bold(): wraps at cursor (no selection) with ** and positions cursor
    - italic(): wraps selection with _
    - strikethrough(): wraps selection with ~~
    - inlineCode(): wraps selection with `
    - clearFormatting(): removes markdown syntax
    - heading(): adds # prefix to line
    - heading(): toggles heading off when same level
    - heading(): replaces heading level
    - blockquote(): toggles > prefix
    - codeBlock(): wraps in ``` fences
    - link(): inserts [text](url) pattern
    - link(): uses selected text in link
    - bulletList(): adds - prefix to lines
    - numberedList(): adds 1. 2. prefix
    - taskList(): adds - [ ] prefix
    - image(): inserts ![alt](url) pattern
    - table(): generates correct markdown table structure
    - horizontalRule(): inserts --- on new lines
    - Edge case: empty content operations

    **markdown-renderer.spec.ts** (~10 tests):
    Mock marked and DOMPurify as they're peer dependencies (use jest.mock):
    - render(): calls marked.parse with input
    - render(): calls DOMPurify.sanitize on marked output
    - render(): returns sanitized HTML
    - render(): handles empty string
    - render(): handles special characters
    - Graceful fallback when marked unavailable
    - Graceful fallback when DOMPurify unavailable
    - GFM features: renders tables, task lists, strikethrough
    - Code blocks: applies Prism highlighting when available
    - Code blocks: falls back to unstyled when Prism unavailable

    **file-handler.spec.ts** (~8 tests):
    Mock FileReader and Blob/URL APIs:
    - importFile(): reads file as UTF-8 text
    - importFile(): returns file content as string
    - importFile(): handles empty file
    - exportFile(): creates Blob with correct MIME type
    - exportFile(): creates anchor with correct download attribute
    - exportFile(): returns filename and size
    - exportFile(): uses custom filename when provided
    - exportFile(): generates default filename with timestamp

    **speech-recognizer.spec.ts** (~8 tests):
    Mock SpeechRecognition API:
    - isSupported(): returns true when API available
    - isSupported(): returns false when API unavailable
    - start(): calls recognition.start()
    - start(): warns when not supported
    - stop(): calls recognition.stop()
    - isActive(): returns listening state
    - destroy(): stops and nullifies recognition
    - onresult callback: passes transcribed text to handler
  </action>
  <verify>
    Run `npx stencil test --spec -- --testPathPattern="sp-markdown-editor/utils"` — all utility tests pass. Count total: ~60 utility tests.
  </verify>
  <done>
    All 5 utility classes have comprehensive unit tests. HistoryManager (15 tests), ToolbarActions (20 tests), MarkdownRenderer (10 tests), FileHandler (8 tests), SpeechRecognizer (8 tests). All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create component spec tests and E2E tests</name>
  <files>
    src/components/sp-markdown-editor/sp-markdown-editor.spec.ts
    src/components/sp-markdown-editor/sp-markdown-editor.e2e.ts
  </files>
  <action>
    **sp-markdown-editor.spec.ts** (~25 tests):
    Follow patterns from sp-walkthrough.spec.ts and sp-org-chart.spec.ts using newSpecPage.

    Rendering:
    - renders with default props
    - renders source textarea in source mode
    - renders with custom placeholder
    - renders toolbar with button groups
    - renders footer with character/word count
    - renders mode switcher tabs

    Props:
    - value prop sets initial content
    - mode prop sets initial editing mode
    - autoSave prop enables/disables auto-save
    - placeholder prop sets textarea placeholder

    State:
    - content updates on input
    - isDirtyState becomes true on edit
    - stats update (chars/words) on content change
    - currentMode changes on mode switch

    Events:
    - emits contentChange on input
    - emits save on auto-save (use fake timers)
    - emits modeChange on mode switch
    - emits save on Ctrl+S

    Methods:
    - getContent() returns current content
    - setContent() updates content
    - clear() empties content and history
    - getMode() returns current mode
    - setMode() changes mode and emits event
    - isDirty() returns dirty state
    - focus() focuses textarea

    Mode switching:
    - switching to wysiwyg renders preview
    - switching to split renders both panes
    - switching back to source preserves content

    Note: For spec tests, mock peer dependencies (marked, DOMPurify) since they won't be available in the Jest test environment. Mock them at the module level.

    **sp-markdown-editor.e2e.ts** (~20 tests):
    Follow patterns from sp-walkthrough.e2e.ts using Playwright with shadow DOM querying.

    Rendering:
    - component renders on page
    - source textarea is visible in default mode
    - toolbar buttons render
    - footer renders with stats
    - mode switcher tabs render

    Interactions:
    - typing in textarea updates content (query shadow DOM for textarea, type text, verify via getContent method)
    - clicking bold button wraps selection (select text, click bold, verify content)
    - clicking mode tab switches view (click Preview tab, verify wysiwyg-editor visible)
    - undo button restores previous state
    - keyboard shortcut Ctrl+B applies bold
    - keyboard shortcut Ctrl+Z undoes
    - export button triggers download (verify via event listener)

    Mode switching:
    - source mode shows textarea
    - preview mode shows rendered HTML
    - split mode shows both panes
    - content preserved across mode switches

    Accessibility:
    - toolbar buttons have title attributes
    - textarea has placeholder
    - mode tabs indicate active state
    - component has proper ARIA roles where applicable

    API methods:
    - setContent() updates displayed content
    - clear() empties the editor
    - getContent() returns what was typed

    Note: For E2E tests, peer dependencies need to be available. Either mock them in the test HTML page or include them via script tags in the test setup. Follow the pattern from sp-walkthrough.e2e.ts for shadow DOM access via page.evaluate.
  </action>
  <verify>
    Run `npx stencil test --spec` — ALL spec tests pass (existing + new). Count new markdown editor spec tests.
    Run `npx stencil test --e2e` — ALL E2E tests pass (existing + new). Count new markdown editor E2E tests.
    Verify zero regressions in sp-example, sp-org-chart, sp-walkthrough test suites.
  </verify>
  <done>
    Complete test suite: ~25 spec tests + ~20 E2E tests for the component, plus ~60 utility tests. All tests pass with zero regressions. TEST-01 and TEST-02 requirements satisfied for sp-markdown-editor.
  </done>
</task>

</tasks>

<verification>
1. `npx stencil test --spec` — all spec tests pass (total count increases by ~85+)
2. `npx stencil test --e2e` — all E2E tests pass (total count increases by ~20+)
3. Zero regressions in existing test suites
4. Utility tests cover edge cases (empty input, boundary conditions)
5. Component spec tests cover all public API methods
6. E2E tests validate user interactions through shadow DOM
</verification>

<success_criteria>
- ~60 utility unit tests all passing
- ~25 component spec tests all passing
- ~20 E2E tests all passing
- Zero regressions in sp-example, sp-org-chart, sp-walkthrough tests
- Full `npx stencil test --spec` and `npx stencil test --e2e` green
- TEST-01 and TEST-02 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04-markdown-editor-component/04-04-SUMMARY.md`
</output>
