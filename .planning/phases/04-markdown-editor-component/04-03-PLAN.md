---
phase: 04-markdown-editor-component
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - src/components/sp-markdown-editor/sp-markdown-editor.tsx
  - src/components/sp-markdown-editor/sp-markdown-editor.css
autonomous: true

must_haves:
  truths:
    - "User can switch to WYSIWYG mode and see rendered HTML preview of markdown content"
    - "User can switch to split mode and see source textarea and preview side by side"
    - "Switching between modes preserves content without data loss"
    - "User can import a .md file via file input and see its content loaded in the editor"
    - "User can export current content as a .md file download"
    - "User can activate voice dictation (Chrome/Edge) and see transcribed text appended to content"
    - "User can print and see formatted markdown in print-friendly layout"
    - "Component emits content-change, save, mode-change, import, export, image-paste events"
  artifacts:
    - path: "src/components/sp-markdown-editor/sp-markdown-editor.tsx"
      provides: "WYSIWYG/split rendering, mode switching, import/export, voice dictation, print, image paste"
      contains: "renderWysiwyg"
    - path: "src/components/sp-markdown-editor/sp-markdown-editor.css"
      provides: "WYSIWYG preview styles, split mode layout, mode switcher tabs, voice/import/export button styles"
      contains: ".wysiwyg-editor"
  key_links:
    - from: "sp-markdown-editor.tsx"
      to: "markdown-renderer.ts"
      via: "render() for WYSIWYG preview using markdownRenderer.render()"
      pattern: "markdownRenderer\\.render"
    - from: "sp-markdown-editor.tsx"
      to: "file-handler.ts"
      via: "import/export button handlers call FileHandler methods"
      pattern: "FileHandler\\.(import|export)"
    - from: "sp-markdown-editor.tsx"
      to: "speech-recognizer.ts"
      via: "voice button toggles speechRecognizer.start/stop"
      pattern: "speechRecognizer\\.(start|stop)"
---

<objective>
Complete the sp-markdown-editor with WYSIWYG preview mode, split mode, mode switching UI, file import/export, voice dictation toggle, print support, and image paste handling. Wire all remaining events.

Purpose: Satisfies MDED-02, MDED-03, MDED-11, MDED-12, MDED-13, MDED-14, MDED-18 — completing all editor features before testing. After this plan, the component is feature-complete.
Output: Feature-complete markdown editor with all 3 modes, import/export, voice dictation, print, and all events.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-markdown-editor-component/04-RESEARCH.md
@.planning/phases/04-markdown-editor-component/04-01-SUMMARY.md
@.planning/phases/04-markdown-editor-component/04-02-SUMMARY.md
@src/components/sp-markdown-editor/sp-markdown-editor.tsx
@src/components/sp-markdown-editor/sp-markdown-editor.css
@src/components/sp-markdown-editor/utils/markdown-renderer.ts
@src/components/sp-markdown-editor/utils/file-handler.ts
@src/components/sp-markdown-editor/utils/speech-recognizer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add WYSIWYG/split modes, mode switcher UI, and remaining toolbar actions</name>
  <files>
    src/components/sp-markdown-editor/sp-markdown-editor.tsx
    src/components/sp-markdown-editor/sp-markdown-editor.css
  </files>
  <action>
    **Mode Switcher UI (add to toolbar area):**
    Add mode switcher tabs above or at the right end of the toolbar:
    - Three tab buttons: "Source", "Preview", "Split" with active state styling
    - Clicking a tab calls handleModeSwitch(newMode)
    - handleModeSwitch: emit modeChange event (with oldMode, newMode), update currentMode state
    - When switching TO wysiwyg or split: render HTML preview from current content via markdownRenderer.render()
    - Content is ALWAYS stored as markdown string (single source of truth)

    **WYSIWYG Preview Rendering:**
    Add renderWysiwyg() private method:
    - Renders a div.wysiwyg-editor with contenteditable="false" (preview-only per research recommendation: start with preview-only, simpler and fewer edge cases)
    - Set innerHTML via markdownRenderer.render(this.content)
    - Style with prose-like formatting: max-width readable, proper heading sizes, list styling, code block backgrounds, blockquote left border, table borders, link colors
    - Add ::part(wysiwyg-editor) for external styling

    **Split Mode Rendering:**
    Add renderSplit() private method:
    - Renders editor-body with two panes side by side (flex: display flex)
    - Left pane: source textarea (50% width)
    - Right pane: WYSIWYG preview (50% width) with border-left separator
    - Basic scroll sync: on textarea scroll, set preview scrollTop proportionally (percentage-based as recommended in research)

    **Update render() method:**
    Replace the editor-body section with conditional rendering:
    - mode === 'source': render source textarea only (full width)
    - mode === 'wysiwyg': render WYSIWYG preview only (full width)
    - mode === 'split': render split view with both

    The source textarea should remain in DOM (hidden) even in wysiwyg mode to preserve selection state, OR re-sync cursor when switching back.
  </action>
  <verify>
    Run `npx stencil build` — zero errors. Verify that switching modes via handleModeSwitch updates currentMode state and re-renders appropriate views.
  </verify>
  <done>
    Mode switcher tabs render and switch between source/wysiwyg/split. WYSIWYG mode shows rendered markdown preview. Split mode shows source and preview side-by-side. Content preserves across mode switches.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add import/export, voice dictation, print, and image paste</name>
  <files>
    src/components/sp-markdown-editor/sp-markdown-editor.tsx
    src/components/sp-markdown-editor/sp-markdown-editor.css
  </files>
  <action>
    **Import/Export (MDED-11, MDED-12):**
    Add to toolbar (rightmost group or secondary toolbar row):
    - Import button: triggers hidden <input type="file" accept=".md,.markdown,.txt"> click
    - On file selected: call FileHandler.importFile(file), set content, push to history, emit importFile event
    - Export button: call FileHandler.exportFile(content), emit exportFile event
    - Style import/export buttons consistently with toolbar

    **Voice Dictation (MDED-13):**
    Add microphone toggle button to toolbar:
    - Only render if speechRecognizer.isSupported() returns true (graceful degradation)
    - On click: toggle voice dictation
      - If not listening: call speechRecognizer.start(onResult, onError), set isListening=true, button gets "active" class (pulsing animation)
      - If listening: call speechRecognizer.stop(), set isListening=false
    - onResult callback: append transcribed text to content at cursor position (or end if no cursor), push to history, emit contentChange
    - onError callback: set isListening=false, console.warn
    - Cleanup in disconnectedCallback already handled (Plan 01)

    **Print Support (MDED-18):**
    Add print button to toolbar:
    - On click: call handlePrint()
    - handlePrint follows Pattern from research: open new window, write rendered HTML with basic styles, call print(), close
    - Use DWC font variables in print stylesheet for consistency
    - Alternative simpler approach: Use CSS @media print rules on the component itself — hide toolbar and footer, show only rendered preview. Call window.print(). This is simpler and avoids popup blockers. Choose the simpler approach.
    - For @media print in shadow DOM: add print-specific styles that hide .toolbar and .editor-footer, show .wysiwyg-editor (or render preview inline for print). Actually use the window.open approach since shadow DOM @media print is unreliable across browsers.

    **Image Paste (MDED-14 partial):**
    Add paste event handler on the source textarea:
    - Listen for 'paste' event
    - Check clipboardData for image files (items with type starting with 'image/')
    - If image found: prevent default, read as dataURL, emit imagePaste event with { file, dataUrl }
    - Insert markdown image placeholder at cursor: ![pasted image](data:...)  or just ![image]() and let consumer handle upload
    - Actually: emit the event and insert ![image](paste) placeholder. The consumer is responsible for uploading and replacing the URL.

    **Event Wiring (MDED-14):**
    Verify all 6 events are properly emitted:
    - contentChange: on every content modification (typing, toolbar, import, voice)
    - save: on auto-save timer fire AND Ctrl+S
    - modeChange: on mode switch tab click
    - importFile: after successful file import
    - exportFile: after successful file export
    - imagePaste: after image detected in paste event

    **CSS additions:**
    - .wysiwyg-editor { padding: 12px 16px; overflow-y: auto; color: var(--dwc-color, #333); background: var(--dwc-background-color, #fff); line-height: 1.6; }
    - .wysiwyg-editor h1 { font-size: 2em; margin: 0.67em 0; border-bottom: 1px solid var(--dwc-border-color, #eee); padding-bottom: 0.3em; }
    - .wysiwyg-editor h2 { font-size: 1.5em; margin: 0.75em 0; border-bottom: 1px solid var(--dwc-border-color, #eee); padding-bottom: 0.3em; }
    - .wysiwyg-editor h3 { font-size: 1.25em; margin: 0.83em 0; }
    - .wysiwyg-editor code { background: var(--dwc-surface-color, #f5f5f5); padding: 2px 4px; border-radius: 3px; font-family: var(--dwc-font-family-mono, monospace); font-size: 0.9em; }
    - .wysiwyg-editor pre { background: var(--dwc-surface-color, #f5f5f5); padding: 12px 16px; border-radius: 4px; overflow-x: auto; }
    - .wysiwyg-editor pre code { background: transparent; padding: 0; }
    - .wysiwyg-editor blockquote { border-left: 4px solid var(--dwc-color-primary, #1976d2); margin: 8px 0; padding: 8px 16px; color: var(--dwc-color-secondary, #666); background: var(--dwc-surface-color, #f9f9f9); }
    - .wysiwyg-editor table { border-collapse: collapse; width: 100%; margin: 8px 0; }
    - .wysiwyg-editor th, .wysiwyg-editor td { border: 1px solid var(--dwc-border-color, #ddd); padding: 6px 12px; text-align: left; }
    - .wysiwyg-editor th { background: var(--dwc-surface-color, #f5f5f5); font-weight: 600; }
    - .wysiwyg-editor img { max-width: 100%; }
    - .wysiwyg-editor a { color: var(--dwc-color-primary, #1976d2); }
    - .wysiwyg-editor ul, .wysiwyg-editor ol { padding-left: 24px; }
    - .wysiwyg-editor hr { border: none; border-top: 1px solid var(--dwc-border-color, #ddd); margin: 16px 0; }
    - .wysiwyg-editor input[type="checkbox"] { margin-right: 6px; }
    - .split-view { display: flex; }
    - .split-view .source-editor { width: 50%; border-right: 1px solid var(--dwc-border-color, #ddd); }
    - .split-view .wysiwyg-editor { width: 50%; }
    - .mode-switcher { display: flex; gap: 0; margin-left: auto; }
    - .mode-tab { padding: 4px 12px; border: 1px solid var(--dwc-border-color, #ddd); background: transparent; cursor: pointer; font-size: 12px; color: var(--dwc-color-secondary, #666); }
    - .mode-tab:first-child { border-radius: 3px 0 0 3px; }
    - .mode-tab:last-child { border-radius: 0 3px 3px 0; }
    - .mode-tab.active { background: var(--dwc-color-primary, #1976d2); color: #fff; border-color: var(--dwc-color-primary, #1976d2); }
    - .toolbar-btn.listening { color: var(--dwc-color-danger, #d32f2f); animation: pulse 1.5s infinite; }
    - @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    - Dark mode overrides for WYSIWYG content
  </action>
  <verify>
    Run `npx stencil build` — zero errors. Run `npx stencil test --spec` — all existing tests pass. Verify all 3 modes render, import/export buttons exist, voice button conditionally renders, print button exists. Verify all 6 events are defined as @Event() decorators.
  </verify>
  <done>
    Component is feature-complete. WYSIWYG mode renders HTML preview. Split mode shows side-by-side. Mode switcher tabs work. Import loads .md files. Export downloads .md. Voice dictation toggles with feature detection. Print opens rendered preview. Image paste emits event. All 6 custom events properly wired. MDED-02, MDED-03, MDED-11, MDED-12, MDED-13, MDED-14, MDED-18 satisfied.
  </done>
</task>

</tasks>

<verification>
1. `npx stencil build` completes with zero errors
2. `npx stencil test --spec` passes all existing tests
3. Mode switcher shows Source/Preview/Split tabs
4. WYSIWYG mode renders markdown as formatted HTML
5. Split mode shows textarea and preview side by side
6. Import button opens file picker for .md files
7. Export button triggers .md file download
8. Voice button only appears in supported browsers
9. Print generates formatted preview
10. All 6 events emit with correct payloads
</verification>

<success_criteria>
- Three editing modes (source, wysiwyg, split) all functional
- Mode switching preserves content without data loss
- Import/export file operations work
- Voice dictation toggles with feature detection
- Print support renders formatted output
- All events (content-change, save, mode-change, import, export, image-paste) emit correctly
- MDED-02, MDED-03, MDED-11, MDED-12, MDED-13, MDED-14, MDED-18 complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-markdown-editor-component/04-03-SUMMARY.md`
</output>
