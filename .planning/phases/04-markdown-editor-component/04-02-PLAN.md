---
phase: 04-markdown-editor-component
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/sp-markdown-editor/utils/toolbar-actions.ts
  - src/components/sp-markdown-editor/sp-markdown-editor.tsx
  - src/components/sp-markdown-editor/sp-markdown-editor.css
autonomous: true

must_haves:
  truths:
    - "User can click toolbar buttons to apply bold, italic, strikethrough, inline code, and clear formatting"
    - "User can click toolbar buttons to insert H1, H2, H3 headings"
    - "User can click toolbar buttons to insert blockquote, code block, and link"
    - "User can click toolbar buttons to insert bullet list, numbered list, and task list"
    - "User can click toolbar buttons to insert image placeholder, 3x3 table, and horizontal rule"
    - "User can press Ctrl+B for bold, Ctrl+I for italic, Ctrl+K for link, Ctrl+S to save, Ctrl+Z to undo, Ctrl+Y to redo"
    - "Undo/redo via toolbar buttons restores previous content states"
  artifacts:
    - path: "src/components/sp-markdown-editor/utils/toolbar-actions.ts"
      provides: "All toolbar formatting functions using Selection API on textarea"
      exports: ["ToolbarActions"]
    - path: "src/components/sp-markdown-editor/sp-markdown-editor.tsx"
      provides: "Toolbar rendering with grouped buttons, keyboard shortcut handler"
      contains: "renderToolbar"
    - path: "src/components/sp-markdown-editor/sp-markdown-editor.css"
      provides: "Toolbar button styles, group separators, active/hover states"
      contains: ".toolbar-btn"
  key_links:
    - from: "sp-markdown-editor.tsx"
      to: "toolbar-actions.ts"
      via: "import and delegation from toolbar button click handlers"
      pattern: "ToolbarActions"
    - from: "sp-markdown-editor.tsx"
      to: "history-manager.ts"
      via: "undo/redo toolbar buttons call historyManager.undo/redo"
      pattern: "historyManager\\.(undo|redo)"
---

<objective>
Add the complete formatting toolbar and keyboard shortcuts to sp-markdown-editor. Implement all toolbar action functions (inline formatting, headings, block formatting, lists, insertions) and wire them to toolbar buttons with proper grouping. Add keyboard shortcut handling for Ctrl+B, Ctrl+I, Ctrl+K, Ctrl+S, Ctrl+Z, Ctrl+Y.

Purpose: Satisfies MDED-04 through MDED-10 — the core editing experience. After this plan, users can format text via both toolbar and keyboard.
Output: Fully functional toolbar with all formatting options and keyboard shortcuts.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-markdown-editor-component/04-RESEARCH.md
@.planning/phases/04-markdown-editor-component/04-01-SUMMARY.md
@src/components/sp-markdown-editor/sp-markdown-editor.tsx
@src/components/sp-markdown-editor/sp-markdown-editor.css
@src/components/sp-markdown-editor/types/editor.types.ts
@src/components/sp-markdown-editor/utils/history-manager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create toolbar actions utility and integrate toolbar with keyboard shortcuts</name>
  <files>
    src/components/sp-markdown-editor/utils/toolbar-actions.ts
    src/components/sp-markdown-editor/sp-markdown-editor.tsx
    src/components/sp-markdown-editor/sp-markdown-editor.css
  </files>
  <action>
    **toolbar-actions.ts** — Static utility class for all formatting operations:

    All methods operate on a textarea element reference and return `{ content: string, selectionStart: number, selectionEnd: number }` so the component can update state and cursor position.

    **Inline formatting (wrap selection with syntax):**
    - `wrapSelection(content: string, start: number, end: number, prefix: string, suffix?: string)`: Wraps selected text with prefix/suffix. If no selection, inserts prefix+suffix and places cursor between. If selection is already wrapped, unwrap (toggle behavior). Returns new content + cursor positions.
    - `bold(content, start, end)`: calls wrapSelection with '**'
    - `italic(content, start, end)`: calls wrapSelection with '_'
    - `strikethrough(content, start, end)`: calls wrapSelection with '~~'
    - `inlineCode(content, start, end)`: calls wrapSelection with '`'
    - `clearFormatting(content, start, end)`: Remove markdown syntax around selection (strip **, _, ~~, `, etc.)

    **Heading formatting (line-level prefix):**
    - `heading(content, start, end, level: 1|2|3)`: Find the line containing cursor, toggle heading prefix (# , ## , ### ). If line already has that heading level, remove it. If different level, replace.

    **Block formatting (line-level):**
    - `blockquote(content, start, end)`: Toggle '> ' prefix on each line in selection
    - `codeBlock(content, start, end)`: Wrap selection in ``` fences on new lines. If already in code block, unwrap.
    - `link(content, start, end)`: Insert [selected text](https://) or [link text](https://) if no selection. Position cursor in URL portion.

    **List formatting (line-level prefix):**
    - `bulletList(content, start, end)`: Toggle '- ' prefix on each line in selection
    - `numberedList(content, start, end)`: Toggle '1. ', '2. ', etc. prefix on each line
    - `taskList(content, start, end)`: Toggle '- [ ] ' prefix on each line

    **Insert actions:**
    - `image(content, start, end)`: Insert ![alt text](url) at cursor position
    - `table(content, start, end, rows=3, cols=3)`: Insert markdown table with header, separator, and data rows (following Pattern from research)
    - `horizontalRule(content, start, end)`: Insert '\n---\n' at cursor

    **Component updates (sp-markdown-editor.tsx):**

    Add `import { ToolbarActions } from './utils/toolbar-actions';`

    **Add renderToolbar() private method** returning JSX with toolbar buttons grouped by function:
    - Group 1 (History): Undo, Redo buttons with disabled state based on historyManager.canUndo()/canRedo()
    - Separator (div.toolbar-separator)
    - Group 2 (Inline): Bold (B), Italic (I), Strikethrough (S), Code (`), Clear formatting (Tx)
    - Separator
    - Group 3 (Headings): H1, H2, H3 buttons
    - Separator
    - Group 4 (Block): Quote ("), Code Block ({}), Link (chain icon text)
    - Separator
    - Group 5 (Lists): Bullet, Numbered, Task list
    - Separator
    - Group 6 (Insert): Image, Table, HR
    - Each button: <button class="toolbar-btn" title="Bold (Ctrl+B)" onClick={handler}>B</button>
    - Use text labels for buttons (B, I, S, `, Tx, H1, H2, H3, etc.) — no icon library dependency

    **Add toolbar button click handlers:**
    Each handler calls the corresponding ToolbarActions method, updates content state, updates cursor position on the textarea, pushes to historyManager, and emits contentChange.

    Helper method `applyToolbarAction(actionFn)`:
    1. Get current selectionStart/End from textarea ref
    2. Call actionFn(content, start, end)
    3. Set this.content = result.content
    4. After next render tick (requestAnimationFrame), set textarea.selectionStart/End = result positions
    5. Push to historyManager
    6. Emit contentChange
    7. Focus textarea

    **Add keyboard shortcut handler** using @Listen('keydown') on the host:
    - Check isCtrlOrCmd = event.ctrlKey || event.metaKey (Mac support)
    - Ctrl+B: event.preventDefault(), apply bold
    - Ctrl+I: event.preventDefault(), apply italic
    - Ctrl+K: event.preventDefault(), apply link
    - Ctrl+S: event.preventDefault(), emit save event immediately (flush auto-save)
    - Ctrl+Z: event.preventDefault(), undo from historyManager, update content
    - Ctrl+Y (or Ctrl+Shift+Z): event.preventDefault(), redo from historyManager, update content

    **Update render() method:**
    Replace the toolbar placeholder div with {this.renderToolbar()}

    **CSS additions (sp-markdown-editor.css):**
    - .toolbar-btn { display: inline-flex; align-items: center; justify-content: center; min-width: 28px; height: 28px; padding: 2px 6px; border: 1px solid transparent; border-radius: var(--dwc-border-radius, 3px); background: transparent; color: var(--dwc-color, #333); font-size: 13px; font-weight: 600; cursor: pointer; transition: background 0.15s, border-color 0.15s; }
    - .toolbar-btn:hover { background: var(--dwc-color-primary-lightest, #e3f2fd); border-color: var(--dwc-border-color, #ddd); }
    - .toolbar-btn:active { background: var(--dwc-color-primary-lighter, #bbdefb); }
    - .toolbar-btn.active { background: var(--dwc-color-primary-lightest, #e3f2fd); border-color: var(--dwc-color-primary, #1976d2); color: var(--dwc-color-primary, #1976d2); }
    - .toolbar-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    - .toolbar-separator { width: 1px; height: 20px; background: var(--dwc-border-color, #ddd); margin: 4px 4px; align-self: center; }
    - .toolbar-group { display: flex; gap: 1px; align-items: center; }
    - Dark mode overrides for toolbar buttons
  </action>
  <verify>
    Run `npx stencil build` — zero errors. Run `npx stencil test --spec` — all existing tests pass. Verify toolbar renders with button groups and separators. Verify keyboard shortcut handler is registered.
  </verify>
  <done>
    Toolbar renders with all formatting buttons organized in 6 groups (History, Inline, Headings, Block, Lists, Insert). Each button triggers corresponding markdown formatting via ToolbarActions utility. Keyboard shortcuts Ctrl+B/I/K/S/Z/Y all work. Undo/redo buttons reflect canUndo/canRedo state. All formatting operations update content, cursor position, and history.
  </done>
</task>

</tasks>

<verification>
1. `npx stencil build` completes with zero errors
2. `npx stencil test --spec` passes all existing tests
3. Toolbar buttons render for all formatting categories
4. Bold wraps selection with ** markers
5. Ctrl+B/I/K shortcuts work
6. Ctrl+Z undoes, Ctrl+Y redoes
7. Undo/Redo toolbar buttons disabled when at history boundaries
</verification>

<success_criteria>
- ToolbarActions utility handles all 15+ formatting operations
- Toolbar renders with 6 grouped sections and visual separators
- All toolbar buttons trigger correct markdown insertion/wrapping
- Keyboard shortcuts (Ctrl+B, Ctrl+I, Ctrl+K, Ctrl+S, Ctrl+Z, Ctrl+Y) work
- Undo/redo operates through toolbar and keyboard
- MDED-04 through MDED-10 requirements addressed
</success_criteria>

<output>
After completion, create `.planning/phases/04-markdown-editor-component/04-02-SUMMARY.md`
</output>
