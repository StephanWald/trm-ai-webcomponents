---
phase: 09-popover-utility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/sp-popover/types.ts
  - src/components/sp-popover/utils/position.ts
  - src/components/sp-popover/sp-popover.css
  - src/components/sp-popover/sp-popover.tsx
autonomous: true
requirements:
  - POPV-01
  - POPV-02
  - POPV-03
  - POPV-04
  - POPV-05
  - POPV-06

must_haves:
  truths:
    - "sp-popover positions slotted content relative to an anchor element in any of 6 placements"
    - "When a popover would overflow the viewport, it auto-repositions to stay within a 10px margin"
    - "Close-on-outside-click and close-on-escape behaviors can be toggled independently via boolean props"
    - "showPopover, hidePopover, togglePopover, and updatePosition methods work correctly"
    - "The component emits popover-open and popover-close events"
    - "Content enters with a fade+slide animation"
  artifacts:
    - path: "src/components/sp-popover/types.ts"
      provides: "Placement type, PopoverPosition interface"
      contains: "Placement"
    - path: "src/components/sp-popover/utils/position.ts"
      provides: "Positioning algorithm with viewport boundary detection"
      exports: ["calculatePosition"]
    - path: "src/components/sp-popover/sp-popover.css"
      provides: "Popover styling with DWC tokens, fade+slide animation"
      contains: "@keyframes"
    - path: "src/components/sp-popover/sp-popover.tsx"
      provides: "Complete sp-popover Stencil component"
      exports: ["SpPopover"]
  key_links:
    - from: "src/components/sp-popover/sp-popover.tsx"
      to: "src/components/sp-popover/utils/position.ts"
      via: "import calculatePosition"
      pattern: "calculatePosition"
    - from: "src/components/sp-popover/sp-popover.tsx"
      to: "src/components/sp-popover/types.ts"
      via: "import Placement type"
      pattern: "Placement"
    - from: "sp-popover.tsx events"
      to: "consumer components"
      via: "popover-open and popover-close CustomEvents"
      pattern: "@Event.*popoverOpen|popoverClose"
---

<objective>
Build the complete sp-popover component -- a reusable viewport-aware positioning utility that serves as the foundation for dropdowns in Phases 10 and 11.

Purpose: Phases 10 (Language & Voice) and 11 (Communication & Splash) need a shared popover primitive for their dropdown UIs. This component delivers all 6 POPV requirements in a single implementation plan.

Output: A fully functional sp-popover Stencil web component with positioning engine, dismiss behaviors, public API, animation, and DWC theming.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-popover-utility/09-CONTEXT.md
@src/components/sp-example/sp-example.tsx
@src/components/sp-example/sp-example.css
@src/global/dwc-theme.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create types, positioning utility, and CSS with animation</name>
  <files>
    src/components/sp-popover/types.ts
    src/components/sp-popover/utils/position.ts
    src/components/sp-popover/sp-popover.css
  </files>
  <action>
**types.ts** -- Define the popover type system:
- `Placement` type union: `'bottom-start' | 'bottom-end' | 'top-start' | 'top-end' | 'right-start' | 'left-start'` (exactly these 6 per POPV-01)
- `PopoverPosition` interface: `{ top: number; left: number; actualPlacement: Placement }` -- the calculated CSS position plus which placement was actually used (may differ from requested if viewport-flipped)
- `PositionOptions` interface: `{ anchorRect: DOMRect; popoverRect: { width: number; height: number }; placement: Placement; margin?: number }` -- inputs to the positioning function

**utils/position.ts** -- Pure positioning algorithm:
- Export `calculatePosition(options: PositionOptions): PopoverPosition`
- For each of the 6 placements, calculate the `top` and `left` CSS position relative to the viewport:
  - `bottom-start`: below anchor, left-aligned (top = anchor.bottom + gap, left = anchor.left)
  - `bottom-end`: below anchor, right-aligned (top = anchor.bottom + gap, left = anchor.right - popoverWidth)
  - `top-start`: above anchor, left-aligned (top = anchor.top - popoverHeight - gap, left = anchor.left)
  - `top-end`: above anchor, right-aligned (top = anchor.top - popoverHeight - gap, left = anchor.right - popoverWidth)
  - `right-start`: right of anchor, top-aligned (top = anchor.top, left = anchor.right + gap)
  - `left-start`: left of anchor, top-aligned (top = anchor.top, left = anchor.left - popoverWidth - gap)
- Use a gap of 4px between anchor and popover
- Viewport boundary detection (POPV-02): After initial calculation, check if the popover overflows the viewport (window.innerWidth / window.innerHeight) with a 10px margin. If it does:
  - Vertical overflow: flip top <-> bottom (e.g., bottom-start that overflows below becomes top-start)
  - Horizontal overflow: flip start <-> end (e.g., bottom-start that overflows right becomes bottom-end)
  - Left/right overflow: flip left <-> right
  - After flipping, clamp final position to ensure it stays within the 10px viewport margin
- The function must be pure (takes DOMRect + dimensions, returns position) -- no DOM access inside the function. The component will pass in the rects.
- Export a helper `getFlippedPlacement(placement: Placement, axis: 'vertical' | 'horizontal'): Placement` for the flip logic

**sp-popover.css** -- Component styling with DWC tokens and animation:
- `:host` -- `display: contents` (popover should not affect layout flow of its anchor)
- `.popover-container` -- The positioned wrapper: `position: fixed; z-index: var(--dwc-z-dropdown); pointer-events: none; opacity: 0; visibility: hidden;` (hidden by default)
- `.popover-container.open` -- `pointer-events: auto; opacity: 1; visibility: visible; animation: sp-popover-enter var(--dwc-transition-base) ease forwards;`
- `@keyframes sp-popover-enter` -- fade+slide animation (POPV-05):
  - `from { opacity: 0; transform: translateY(-4px); }` (for bottom placements -- slides down into place)
  - `to { opacity: 1; transform: translateY(0); }`
- `.popover-content` -- The visual panel: `background: var(--dwc-color-surface); border: 1px solid var(--dwc-color-border); border-radius: var(--dwc-border-radius); box-shadow: var(--dwc-shadow-lg); overflow: auto;`
- Theme overrides following the `:host(.theme-light)` / `:host(.theme-dark)` pattern from sp-example
- No arrow/caret (per Claude's discretion -- keep it simple for Phase 10/11 consumers)
  </action>
  <verify>
- `npx stencil build` succeeds (types resolve, CSS compiles)
- types.ts exports `Placement`, `PopoverPosition`, `PositionOptions`
- position.ts exports `calculatePosition`, `getFlippedPlacement`
- CSS contains `@keyframes sp-popover-enter`, `.popover-container`, `.open` class
  </verify>
  <done>
Types define the 6-placement union and position interfaces. Positioning utility correctly calculates position for all 6 placements and flips when viewport overflows with 10px margin. CSS provides DWC-themed panel with fade+slide enter animation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement sp-popover component with anchor, dismiss, methods, and events</name>
  <files>
    src/components/sp-popover/sp-popover.tsx
  </files>
  <action>
Create the sp-popover Stencil component with shadow DOM.

**Props:**
- `placement: Placement = 'bottom-start'` -- preferred placement (POPV-01)
- `open: boolean = false` -- controls visibility (reflects to attribute)
- `closeOnClick: boolean = true` -- close when clicking outside (POPV-03)
- `closeOnEscape: boolean = true` -- close when pressing Escape (POPV-03)
- `anchor: string | HTMLElement = null` -- CSS selector string or direct element reference for the anchor. If string, resolved via `document.querySelector()`. If null/omitted, use the previous sibling element as anchor.
- `theme: 'light' | 'dark' | 'auto' = 'auto'` -- DWC theme override

**State:**
- `isOpen: boolean = false` -- internal open state
- `positionStyle: { top: string; left: string } = null` -- computed CSS position

**Events (POPV-06):**
- `@Event() popoverOpen: EventEmitter<void>` -- emitted when popover opens
- `@Event() popoverClose: EventEmitter<void>` -- emitted when popover closes

**Methods (POPV-04):**
- `@Method() async showPopover(): Promise<void>` -- opens the popover, calculates position, emits popover-open
- `@Method() async hidePopover(): Promise<void>` -- closes the popover, emits popover-close
- `@Method() async togglePopover(): Promise<void>` -- toggles open/close
- `@Method() async updatePosition(): Promise<void>` -- recalculates position without changing open state (useful after scroll/resize)

**Anchor resolution:**
- Private `resolveAnchor(): HTMLElement | null` method:
  - If `this.anchor` is an HTMLElement, return it directly
  - If `this.anchor` is a string, return `document.querySelector(this.anchor)`
  - If `this.anchor` is null, return `this.el.previousElementSibling as HTMLElement`
- `@Element() el: HTMLElement` for host element reference

**Positioning logic:**
- Private `computePosition()` method:
  - Call `resolveAnchor()` to get anchor element
  - Get anchor's `getBoundingClientRect()`
  - Get popover container's width/height (from the shadow DOM `.popover-container` element). If not yet rendered, use `{ width: 0, height: 0 }`.
  - Call `calculatePosition()` from position utility
  - Set `this.positionStyle = { top: \`\${pos.top}px\`, left: \`\${pos.left}px\` }`

**Open/close lifecycle:**
- `@Watch('open')` handler: sync `isOpen` state, call `computePosition()` when opening, attach/detach dismiss listeners
- When opening: `computePosition()`, then `this.isOpen = true`, emit `popoverOpen`
- When closing: `this.isOpen = false`, emit `popoverClose`

**Dismiss behaviors (POPV-03):**
- Outside click: `document.addEventListener('click', handler, true)` (capture phase) -- if click target is outside host element AND outside anchor, close. Only attach when open AND `closeOnClick` is true. Detach on close.
- Escape key: `document.addEventListener('keydown', handler)` -- if key is 'Escape', close. Only attach when open AND `closeOnEscape` is true. Detach on close.
- Use arrow functions stored as class properties for stable references (attach/detach pattern).

**Cleanup:**
- `disconnectedCallback()`: remove all document listeners, clear any pending RAF

**Render:**
```tsx
render() {
  const hostClass = {
    'theme-light': this.theme === 'light',
    'theme-dark': this.theme === 'dark',
  };
  return (
    <Host class={hostClass}>
      <div
        class={{ 'popover-container': true, 'open': this.isOpen }}
        part="container"
        style={this.positionStyle ? { top: this.positionStyle.top, left: this.positionStyle.left } : {}}
        role="dialog"
        aria-hidden={(!this.isOpen).toString()}
      >
        <div class="popover-content" part="content">
          <slot />
        </div>
      </div>
    </Host>
  );
}
```

**Important implementation notes:**
- The `.popover-container` uses `position: fixed` so positions are relative to viewport (matching the DOMRect values from `getBoundingClientRect()`)
- `@Watch('open')` must trigger the full open/close flow so consumers can control via prop binding OR methods
- The outside-click handler must use `setTimeout(() => document.addEventListener(...), 0)` to avoid catching the click that opened the popover
- Use `requestAnimationFrame` in `computePosition()` to ensure the popover DOM is rendered before measuring its dimensions
  </action>
  <verify>
- `npx stencil build` succeeds with no errors
- The generated `docs.json` includes sp-popover with all props, events, and methods
- Manual check: `src/components/sp-popover/sp-popover.tsx` contains `@Method()` decorators for showPopover, hidePopover, togglePopover, updatePosition
- Manual check: `@Event() popoverOpen` and `@Event() popoverClose` are declared
- Manual check: `closeOnClick` and `closeOnEscape` props exist with boolean type
  </verify>
  <done>
sp-popover component renders a positioned container via named slot, resolves its anchor element, calculates viewport-aware position for all 6 placements, flips on overflow, supports configurable dismiss behaviors (outside-click and escape independently), exposes 4 public methods, emits open/close events, and enters with a fade+slide animation. Build passes cleanly.
  </done>
</task>

</tasks>

<verification>
1. `npx stencil build` completes with zero errors
2. Component appears in generated `docs.json` with correct props, events, methods
3. `src/components/sp-popover/` directory contains: types.ts, utils/position.ts, sp-popover.css, sp-popover.tsx
4. Position utility handles all 6 placements and flips correctly (verified via build type-checking)
5. CSS includes `@keyframes sp-popover-enter` animation and DWC token usage
</verification>

<success_criteria>
- sp-popover builds successfully as part of the Stencil project
- All 6 POPV requirements are addressed: 6 placements (POPV-01), viewport boundary detection (POPV-02), configurable dismiss (POPV-03), public methods (POPV-04), slot + animation (POPV-05), events (POPV-06)
- Component follows established project patterns: shadow DOM, DWC tokens, ::part() exposure, theme prop
- Positioning utility is a pure function testable in isolation
</success_criteria>

<output>
After completion, create `.planning/phases/09-popover-utility/09-01-SUMMARY.md`
</output>
