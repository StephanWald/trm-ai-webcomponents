---
phase: 09-popover-utility
plan: 01
subsystem: ui
tags: [stencil, web-components, popover, positioning, animation, dwc-tokens]

# Dependency graph
requires: []
provides:
  - sp-popover Stencil web component with shadow DOM
  - calculatePosition() pure positioning utility with viewport boundary detection
  - getFlippedPlacement() helper for placement axis flipping
  - Placement type union (6 placements) and PopoverPosition/PositionOptions interfaces
  - DWC-themed CSS with fade+slide @keyframes animation
affects:
  - 10-language-voice (will consume sp-popover for dropdowns)
  - 11-communication-splash (will consume sp-popover for dropdowns)

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Pure positioning function receiving DOMRect + dimensions, returning coordinates (no DOM access inside)
    - rAF-deferred position compute ensures DOM rendered before measuring shadow DOM element dimensions
    - Capture-phase document.addEventListener('click', ..., true) for outside-click dismiss
    - setTimeout(() => document.addEventListener(...), 0) avoids catching the triggering click
    - Arrow function class properties for stable handler references (attach/detach pattern)

key-files:
  created:
    - src/components/sp-popover/types.ts
    - src/components/sp-popover/utils/position.ts
    - src/components/sp-popover/sp-popover.css
    - src/components/sp-popover/sp-popover.tsx
  modified:
    - src/components.d.ts (auto-generated by Stencil)
    - docs.json (auto-generated by Stencil)

key-decisions:
  - "anchor prop accepts string (CSS selector), HTMLElement, or null (falls back to previousElementSibling)"
  - "No arrow/caret visual treatment — clean panel for Phase 10/11 consumers"
  - "position: fixed (not absolute) so positions are relative to viewport matching getBoundingClientRect() values"
  - "rAF defers position compute so shadow DOM container has rendered dimensions before measurement"
  - "Placement flips use best-effort logic — only flip if new position is actually better, then clamp to 10px margin"

patterns-established:
  - "Pure positioning function: calculatePosition(options) — all inputs as params, no side effects"
  - "Stable dismiss handler references: arrow function class props detached in disconnectedCallback()"

requirements-completed: [POPV-01, POPV-02, POPV-03, POPV-04, POPV-05, POPV-06]

# Metrics
duration: 3min
completed: 2026-02-21
---

# Phase 9 Plan 01: sp-popover Utility Summary

**Viewport-aware positioning Stencil component with 6 placements, boundary-detection flip logic, configurable dismiss behaviors, 4 public methods, and fade+slide animation using DWC tokens**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-21T16:41:49Z
- **Completed:** 2026-02-21T16:44:45Z
- **Tasks:** 2
- **Files modified:** 4 created + 2 auto-generated

## Accomplishments
- Pure calculatePosition() utility handles all 6 placements and viewport boundary flipping with 10px margin clamping
- sp-popover Stencil component with shadow DOM, slot, DWC theming, and all 6 POPV requirements
- Dismiss behaviors independently toggleable: outside-click via capture-phase listener, escape via keydown
- All 4 public methods (showPopover, hidePopover, togglePopover, updatePosition) exposed via @Method()
- Build passes cleanly; docs.json confirms correct props, events, methods, shadow encapsulation

## Task Commits

Each task was committed atomically:

1. **Task 1: Create types, positioning utility, and CSS with animation** - `bad9f80` (feat)
2. **Task 2: Implement sp-popover component with anchor, dismiss, methods, and events** - `58f4a39` (feat)

**Plan metadata:** (pending docs commit)

## Files Created/Modified
- `src/components/sp-popover/types.ts` - Placement type union (6 options), PopoverPosition, PositionOptions interfaces
- `src/components/sp-popover/utils/position.ts` - Pure calculatePosition() with flip logic and viewport clamping; getFlippedPlacement() helper
- `src/components/sp-popover/sp-popover.css` - display:contents host, position:fixed container, .open state, @keyframes sp-popover-enter fade+slide, DWC token usage, theme overrides
- `src/components/sp-popover/sp-popover.tsx` - Complete SpPopover component: 6 props, 2 events, 4 methods, anchor resolution, rAF positioning, capture-phase dismiss listeners, disconnectedCallback cleanup

## Decisions Made
- anchor prop: string selector | HTMLElement | null (falls back to previousElementSibling) — flexible for Phase 10/11 consumers
- No arrow/caret — keeps the popover as a clean, minimal primitive
- position: fixed for positioned container — matches getBoundingClientRect() viewport coordinates
- rAF defers position compute in openInternal() so shadow DOM has rendered before measuring container dimensions
- Placement flip logic only flips when new position is actually better (avoids thrashing when both sides overflow)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- sp-popover is ready for consumption by Phase 10 (Language & Voice) and Phase 11 (Communication & Splash) dropdowns
- Consumer pattern: place sp-popover after anchor element and call showPopover() / togglePopover() on anchor click
- All 6 POPV requirements satisfied

---
*Phase: 09-popover-utility*
*Completed: 2026-02-21*
