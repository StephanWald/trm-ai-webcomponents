---
phase: 03-walkthrough-component
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - src/components/sp-walkthrough/sp-walkthrough.spec.ts
  - src/components/sp-walkthrough/sp-walkthrough.e2e.ts
  - src/components/sp-walkthrough/utils/overlay-manager.spec.ts
  - src/components/sp-walkthrough/utils/timeline-engine.spec.ts
  - src/components/sp-walkthrough/utils/youtube-wrapper.spec.ts
  - src/components/sp-walkthrough/utils/selector-generator.spec.ts
autonomous: true

must_haves:
  truths:
    - "Jest spec tests cover component props, state, events, and public methods"
    - "Jest spec tests cover utility functions (overlay-manager, timeline-engine, youtube-wrapper, selector-generator)"
    - "E2E tests cover rendering of walkthrough panel and video container"
    - "E2E tests cover manual scene navigation (prev/next, dropdown)"
    - "E2E tests cover ESC key abort and cleanup behavior"
    - "E2E tests cover author mode (scene editor, pointer tool activation)"
    - "E2E tests validate accessibility attributes (role, aria-label)"
    - "All tests pass: npm test (spec) and npm run test.e2e (E2E)"
  artifacts:
    - path: "src/components/sp-walkthrough/utils/timeline-engine.spec.ts"
      provides: "Unit tests for TimelineEngine class"
      contains: "describe.*TimelineEngine"
    - path: "src/components/sp-walkthrough/utils/overlay-manager.spec.ts"
      provides: "Unit tests for OverlayManager class"
      contains: "describe.*OverlayManager"
    - path: "src/components/sp-walkthrough/utils/youtube-wrapper.spec.ts"
      provides: "Unit tests for YouTubePlayerWrapper and helper functions"
      contains: "describe.*YouTube"
    - path: "src/components/sp-walkthrough/utils/selector-generator.spec.ts"
      provides: "Unit tests for generateSelector and validateSelector"
      contains: "describe.*generateSelector"
    - path: "src/components/sp-walkthrough/sp-walkthrough.spec.ts"
      provides: "Stencil spec tests for component behavior"
      contains: "describe.*sp-walkthrough"
    - path: "src/components/sp-walkthrough/sp-walkthrough.e2e.ts"
      provides: "Playwright E2E tests for rendering and interactions"
      contains: "describe.*sp-walkthrough"
  key_links:
    - from: "sp-walkthrough.spec.ts"
      to: "sp-walkthrough.tsx"
      via: "newSpecPage import"
      pattern: "import.*newSpecPage"
    - from: "sp-walkthrough.e2e.ts"
      to: "sp-walkthrough.tsx"
      via: "Playwright page.goto and component rendering"
      pattern: "page\\.goto|sp-walkthrough"
    - from: "timeline-engine.spec.ts"
      to: "utils/timeline-engine.ts"
      via: "import { TimelineEngine }"
      pattern: "import.*TimelineEngine"
---

<objective>
Create comprehensive test suite for the sp-walkthrough component covering both unit/spec tests and E2E tests.

Purpose: Validate all WALK requirements through tests, proving the video timeline sync, DOM overlay highlighting, author mode, and cross-boundary interaction patterns work correctly (TEST-01, TEST-02). Establishes testing patterns for the walkthrough's unique concerns (video mocking, overlay DOM assertions, global event listeners).

Output: Passing Jest spec tests covering props/state/events/methods/utilities, passing Playwright E2E tests covering rendering/interactions/accessibility.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-walkthrough-component/03-RESEARCH.md
@.planning/phases/03-walkthrough-component/03-01-SUMMARY.md
@.planning/phases/03-walkthrough-component/03-02-SUMMARY.md
@src/components/sp-org-chart/sp-org-chart.spec.ts
@src/components/sp-org-chart/sp-org-chart.e2e.ts
@src/components/sp-org-chart/utils/tree-builder.spec.ts
@src/components/sp-walkthrough/sp-walkthrough.tsx
@src/components/sp-walkthrough/sp-walkthrough.css
@src/components/sp-walkthrough/types/walkthrough.types.ts
@src/components/sp-walkthrough/utils/overlay-manager.ts
@src/components/sp-walkthrough/utils/timeline-engine.ts
@src/components/sp-walkthrough/utils/youtube-wrapper.ts
@src/components/sp-walkthrough/utils/selector-generator.ts
@playwright.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Jest spec tests for utility modules and component</name>
  <files>
    src/components/sp-walkthrough/utils/timeline-engine.spec.ts
    src/components/sp-walkthrough/utils/overlay-manager.spec.ts
    src/components/sp-walkthrough/utils/youtube-wrapper.spec.ts
    src/components/sp-walkthrough/utils/selector-generator.spec.ts
    src/components/sp-walkthrough/sp-walkthrough.spec.ts
  </files>
  <action>
    Create unit tests for the four utility modules and Stencil spec tests for the component. Follow established patterns from sp-org-chart spec tests (use newSpecPage from @stencil/core/testing).

    **timeline-engine.spec.ts** — Test TimelineEngine class:
    - Constructor with empty scenes array: getSceneCount() returns 0
    - Constructor sorts scenes by timestamp ascending
    - getCurrentSceneIndex with time before first scene returns -1
    - getCurrentSceneIndex with time at exactly first scene timestamp returns 0
    - getCurrentSceneIndex with time between two scenes returns earlier scene index
    - getCurrentSceneIndex with time after last scene returns last scene index
    - getCurrentSceneIndex handles seeking backward (time earlier than current scene)
    - getScene with valid index returns scene object
    - getScene with invalid index returns null
    - getNextScene from middle scene returns correct next scene
    - getNextScene from last scene returns null
    - getPreviousScene from middle scene returns correct previous scene
    - getPreviousScene from first scene returns null
    - setScenes updates and re-sorts scenes

    **overlay-manager.spec.ts** — Test OverlayManager class:
    NOTE: OverlayManager interacts with DOM (document.body.appendChild, document.querySelector, getBoundingClientRect). In Jest/JSDOM environment, mock getBoundingClientRect to return known values.

    - highlightElement appends overlay div to document.body
    - highlightElement sets correct position from getBoundingClientRect
    - highlightElement with non-existent selector logs warning and does not create overlay
    - clearHighlights removes all overlay elements from document.body
    - clearHighlights called before highlightElement does nothing (no errors)
    - Multiple sequential highlightElement calls: each clears previous overlay first
    - cleanup removes all overlays and can be called multiple times safely
    - Overlay has correct CSS classes and styles (position: fixed, pointer-events: none)

    **youtube-wrapper.spec.ts** — Test helper functions (not the player itself, since it requires YT.Player runtime):
    - isYouTubeUrl returns true for youtube.com/watch?v=xxx
    - isYouTubeUrl returns true for youtu.be/xxx
    - isYouTubeUrl returns true for youtube.com/embed/xxx
    - isYouTubeUrl returns false for vimeo.com URLs
    - isYouTubeUrl returns false for regular website URLs
    - isYouTubeUrl returns false for empty string
    - extractVideoId extracts ID from youtube.com/watch?v=dQw4w9WgXcQ
    - extractVideoId extracts ID from youtu.be/dQw4w9WgXcQ
    - extractVideoId extracts ID from youtube.com/embed/dQw4w9WgXcQ
    - extractVideoId returns null for non-YouTube URLs
    - extractVideoId handles URLs with extra query parameters (e.g., &t=120)

    **selector-generator.spec.ts** — Test generateSelector and validateSelector:
    NOTE: Create test DOM elements in beforeEach/afterEach for selector testing.

    - generateSelector returns #id for element with ID attribute
    - generateSelector returns class selector for element with unique class
    - generateSelector returns nth-child path as fallback for element without ID or unique class
    - generateSelector prefers ID over class selector
    - generateSelector handles elements with multiple classes
    - generateSelector handles elements with special characters in ID (CSS.escape)
    - validateSelector returns valid:true, matchCount:1 for unique selector
    - validateSelector returns valid:true, matchCount:N for non-unique selector
    - validateSelector returns valid:false, matchCount:0 for selector matching nothing

    **sp-walkthrough.spec.ts** — Stencil component spec tests:
    Use `newSpecPage({ components: [SpWalkthrough], html: '<sp-walkthrough></sp-walkthrough>' })`.

    Test cases:
    1. **Renders with defaults:** Component renders but panel is hidden (isVisible=false by default, render returns null or hidden)
    2. **Show method:** Calling show() makes panel visible (isVisible state changes)
    3. **Hide method:** Calling hide() after show() hides panel
    4. **Abort method:** Calling abort() hides panel and emits walkthrough-aborted event
    5. **Scene prop:** Setting scenes prop updates timeline engine scene count
    6. **Theme prop:** Setting theme='dark' adds theme-dark class to host
    7. **Video source types:** Setting videoSrc with .mp4 URL does not set isYouTube flag; YouTube URL does
    8. **Manual navigation mode:** Without videoSrc, prev/next buttons render
    9. **Scene dropdown renders:** Scene dropdown contains option for each scene
    10. **Author mode hidden by default:** When authorMode=false, no author toolbar renders
    11. **Author mode visible:** When authorMode=true, author toolbar with Add Scene button renders
    12. **Events emitted:** walkthroughShown event fires on show(), walkthroughHidden on hide()
    13. **Public methods exist:** Component exposes play, pause, restart, abort, show, hide methods
    14. **Scene change event:** Advancing scene emits sceneChanged event with correct detail
    15. **Caption toggle:** When captionsSrc provided, caption toggle button renders

    Follow sp-org-chart.spec.ts patterns:
    - Use functional assertions (textContent, querySelector, class checks)
    - Test rendered output and observable behavior
    - Use page.rootInstance to access methods
    - Use page.waitForChanges() after state mutations
  </action>
  <verify>
    Run `npm test` — all spec tests pass (no failures, no skipped).
    Verify test count: at minimum 40 test cases across the 5 spec files.
  </verify>
  <done>
    timeline-engine.spec.ts: 14+ tests covering scene lookup, navigation, sorting, edge cases.
    overlay-manager.spec.ts: 8+ tests covering overlay creation, positioning, cleanup, error handling.
    youtube-wrapper.spec.ts: 11+ tests covering URL detection and video ID extraction.
    selector-generator.spec.ts: 9+ tests covering selector generation strategies and validation.
    sp-walkthrough.spec.ts: 15+ tests covering props, state, events, methods, rendering, author mode.
    All tests pass with `npm test`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Playwright E2E tests for rendering, interactions, and author mode</name>
  <files>
    src/components/sp-walkthrough/sp-walkthrough.e2e.ts
  </files>
  <action>
    Create Playwright E2E tests following sp-org-chart.e2e.ts patterns. Use @stencil/playwright helpers.

    **Sample data** (use in all tests):
    ```typescript
    const sampleScenes = [
      { id: 'scene-1', title: 'Welcome', description: 'Introduction to the app', timestamp: 0 },
      { id: 'scene-2', title: 'Navigation', description: 'Learn the sidebar', timestamp: 5, highlightSelector: '#target-1' },
      { id: 'scene-3', title: 'Features', description: 'Key features overview', timestamp: 10, highlightSelector: '#target-2' },
    ];
    ```

    Set scenes on component via page.evaluate:
    ```typescript
    await page.evaluate((scenes) => {
      const el = document.querySelector('sp-walkthrough');
      el.scenes = scenes;
    }, sampleScenes);
    ```

    **Rendering tests:**
    1. **Component exists in DOM:** sp-walkthrough element is present on page
    2. **Panel hidden by default:** Walkthrough panel is not visible initially
    3. **Panel shows on show():** Call show() method, panel becomes visible
    4. **Panel hides on hide():** After showing, call hide(), panel disappears
    5. **Video container renders:** When videoSrc set, video container is present
    6. **Manual mode renders nav buttons:** Without videoSrc, prev/next buttons visible

    **Navigation tests:**
    7. **Scene dropdown contains all scenes:** Dropdown has options matching scene count
    8. **Scene dropdown navigates:** Select different scene from dropdown, verify scene info updates
    9. **Next button advances scene:** Click next, scene counter updates
    10. **Previous button goes back:** After advancing, click previous, counter decrements
    11. **Next disabled at last scene:** At final scene, next button is disabled
    12. **Previous disabled at first scene:** At first scene, previous button is disabled

    **Interaction tests:**
    13. **ESC key aborts walkthrough:** Show walkthrough, press ESC, panel hides
    14. **Close button hides walkthrough:** Click close button (X), panel hides
    15. **Walkthrough-shown event fires:** Listen for event, call show(), verify event received
    16. **Walkthrough-aborted event fires on ESC:** Listen for event, press ESC after show, verify fired
    17. **Scene-changed event fires on navigation:** Listen for event, click next, verify scene detail
    18. **Panel is draggable:** Verify drag handle element exists with correct cursor style

    **Author mode tests:**
    19. **Author toolbar hidden when authorMode=false:** Verify no author toolbar in DOM
    20. **Author toolbar visible when authorMode=true:** Set authorMode=true, toolbar with Add Scene button appears
    21. **Add Scene opens editor:** Click Add Scene, scene editor form becomes visible
    22. **Scene list shows edit/delete buttons:** In author mode, each scene item has edit and delete buttons
    23. **Delete scene removes from list:** Click delete on a scene, verify scene count decreases
    24. **Timeline-updated event fires on delete:** Listen for event, delete scene, verify changeType is 'delete'

    **Accessibility tests:**
    25. **Close button has aria-label:** Close button has aria-label="Close walkthrough"
    26. **Navigation buttons have labels:** Prev/next buttons have text content or aria-labels
    27. **Volume controls have aria-label:** Volume slider and mute button have accessible labels

    For shadow DOM queries, use Playwright's locator piercing:
    ```typescript
    const panel = page.locator('sp-walkthrough').locator('.walkthrough-panel');
    ```

    For event testing, use page.evaluate to attach listeners before triggering:
    ```typescript
    const eventPromise = page.evaluate(() => {
      return new Promise(resolve => {
        document.querySelector('sp-walkthrough')
          .addEventListener('walkthrough-shown', () => resolve(true), { once: true });
      });
    });
    await page.evaluate(() => document.querySelector('sp-walkthrough').show());
    const fired = await eventPromise;
    expect(fired).toBe(true);
    ```

    Ensure src/index.html has the walkthrough demo with sample scenes and target elements for E2E tests to work against.
  </action>
  <verify>
    Run `npm run test.e2e` — all E2E tests pass.
    Verify test count: at minimum 20 E2E test cases.
    Run `npm run test.all` — both spec and E2E tests pass together (including sp-org-chart tests from Phase 2).
  </verify>
  <done>
    E2E tests validate: panel show/hide, video container rendering, manual navigation, scene dropdown, ESC abort, close button, event emissions, draggable panel, author mode visibility, scene CRUD via UI, and accessibility attributes.
    All E2E tests pass with `npm run test.e2e`.
    Combined test suite passes with `npm run test.all`.
    TEST-01 and TEST-02 requirements satisfied for sp-walkthrough.
  </done>
</task>

</tasks>

<verification>
1. `npm test` passes — all Jest spec tests green (including sp-org-chart tests from Phase 2)
2. `npm run test.e2e` passes — all Playwright E2E tests green
3. `npm run test.all` passes — combined suite green
4. Spec tests cover: utility functions, component props, state, events, methods, rendering, author mode
5. E2E tests cover: panel lifecycle, navigation, interactions, ESC abort, author mode, accessibility
6. Test count: 40+ spec tests, 20+ E2E tests for walkthrough component
7. No regressions: existing sp-org-chart and sp-example tests still pass
</verification>

<success_criteria>
- All spec tests pass covering props, state, events, methods (TEST-01)
- All E2E tests pass covering rendering, interactions, accessibility (TEST-02)
- Utility modules have dedicated unit tests with edge cases
- Tests follow established sp-org-chart/sp-example patterns
- No skipped or pending tests
- No regressions in existing test suites
</success_criteria>

<output>
After completion, create `.planning/phases/03-walkthrough-component/03-03-SUMMARY.md`
</output>
