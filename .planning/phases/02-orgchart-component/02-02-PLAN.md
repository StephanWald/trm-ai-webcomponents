---
phase: 02-orgchart-component
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/components/sp-org-chart/sp-org-chart.spec.ts
  - src/components/sp-org-chart/sp-org-chart.e2e.ts
  - src/components/sp-org-chart/utils/tree-builder.spec.ts
  - src/components/sp-org-chart/utils/tree-filter.spec.ts
  - src/components/sp-org-chart/utils/tree-sorter.spec.ts
autonomous: true

must_haves:
  truths:
    - "Jest spec tests cover component props, state, events, and public methods"
    - "Jest spec tests cover utility functions (tree-builder, tree-filter, tree-sorter)"
    - "E2E tests cover rendering of hierarchical tree from flat data"
    - "E2E tests cover drag-and-drop interaction and hierarchy-change event"
    - "E2E tests cover filter input with dimming of non-matching nodes"
    - "E2E tests cover click selection and double-click event emission"
    - "E2E tests validate accessibility attributes (role, aria-label)"
    - "All tests pass: npm test (spec) and npm run test.e2e (E2E)"
  artifacts:
    - path: "src/components/sp-org-chart/utils/tree-builder.spec.ts"
      provides: "Unit tests for buildTree function"
      contains: "describe.*buildTree"
    - path: "src/components/sp-org-chart/utils/tree-filter.spec.ts"
      provides: "Unit tests for filterTree function"
      contains: "describe.*filterTree"
    - path: "src/components/sp-org-chart/utils/tree-sorter.spec.ts"
      provides: "Unit tests for sortTree function"
      contains: "describe.*sortTree"
    - path: "src/components/sp-org-chart/sp-org-chart.spec.ts"
      provides: "Stencil spec tests for component behavior"
      contains: "describe.*sp-org-chart"
    - path: "src/components/sp-org-chart/sp-org-chart.e2e.ts"
      provides: "Playwright E2E tests for rendering and interactions"
      contains: "describe.*sp-org-chart"
  key_links:
    - from: "sp-org-chart.spec.ts"
      to: "sp-org-chart.tsx"
      via: "newSpecPage import"
      pattern: "import.*newSpecPage"
    - from: "sp-org-chart.e2e.ts"
      to: "sp-org-chart.tsx"
      via: "Playwright page.goto and component rendering"
      pattern: "page\\.goto|sp-org-chart"
    - from: "tree-builder.spec.ts"
      to: "utils/tree-builder.ts"
      via: "import { buildTree }"
      pattern: "import.*buildTree"
---

<objective>
Create comprehensive test suite for the sp-org-chart component covering both unit/spec tests and E2E tests.

Purpose: Validate all ORGC requirements through tests, proving the component patterns work correctly and establishing testing patterns for future components (TEST-01, TEST-02).

Output: Passing Jest spec tests covering props/state/events/methods, passing Playwright E2E tests covering rendering/interactions/accessibility, and utility function unit tests.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-orgchart-component/02-RESEARCH.md
@.planning/phases/02-orgchart-component/02-01-SUMMARY.md
@src/components/sp-example/sp-example.spec.ts
@src/components/sp-example/sp-example.e2e.ts
@src/components/sp-org-chart/sp-org-chart.tsx
@src/components/sp-org-chart/sp-org-chart.css
@src/components/sp-org-chart/types/org-chart.types.ts
@src/components/sp-org-chart/utils/tree-builder.ts
@src/components/sp-org-chart/utils/tree-filter.ts
@src/components/sp-org-chart/utils/tree-sorter.ts
@playwright.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Jest spec tests for utility functions and component</name>
  <files>
    src/components/sp-org-chart/utils/tree-builder.spec.ts
    src/components/sp-org-chart/utils/tree-filter.spec.ts
    src/components/sp-org-chart/utils/tree-sorter.spec.ts
    src/components/sp-org-chart/sp-org-chart.spec.ts
  </files>
  <action>
    Create unit tests for the three utility functions and Stencil spec tests for the component. Follow sp-example.spec.ts patterns (use newSpecPage from @stencil/core/testing).

    **tree-builder.spec.ts** — Test buildTree function:
    - Empty array returns empty roots array
    - Single user with no reportsTo becomes root
    - Two users with reportsTo creates parent-child relationship
    - Multiple roots (users with no reportsTo) all appear in returned array
    - User with reportsTo referencing non-existent parent becomes root (orphan handling)
    - Circular reference detection: A reports to B, B reports to A — both treated as roots, console.warn emitted
    - Level calculation: root is level 0, direct report is level 1, nested report is level 2
    - Larger dataset (5-6 users, 3 levels deep) produces correct tree structure

    **tree-filter.spec.ts** — Test filterTree function:
    - Empty predicate matches nothing — all nodes marked as not matched
    - Name match: filter "Alice" marks Alice as matched, marks Alice's parent chain as isAncestorOfMatch, marks Alice's children as hasMatchingDescendant=false but they should still be visible (matched user's subtree)
    - Role match: filter by role "Engineer" marks all engineers as matched
    - Ancestor chain preservation: matched node's parent (not matching) has isAncestorOfMatch=true
    - Descendant marking: matched node's children have parent marked with hasMatchingDescendant
    - Multiple matches at different levels: filter returns correct results for each
    - No matches: all nodes have matched=false, hasMatchingDescendant=false, isAncestorOfMatch=false

    **tree-sorter.spec.ts** — Test sortTree function:
    - Empty array returns empty array
    - Single node returns same node
    - Two nodes sorted alphabetically by name
    - Case-insensitive sorting: "alice" before "Bob"
    - Children are recursively sorted
    - Original array is not mutated (returns new array)
    - Nested 3-level tree: each level sorted independently

    **sp-org-chart.spec.ts** — Stencil component spec tests:
    Use `newSpecPage({ components: [SpOrgChart], html: '<sp-org-chart></sp-org-chart>' })` and set props programmatically.

    Test cases:
    1. **Renders with defaults:** Component renders, shows no-data message when users=[]
    2. **Custom no-data message:** Setting noDataMessage prop changes displayed text
    3. **Renders user tiles:** Setting users prop renders user-tile elements with correct names/roles
    4. **Hierarchical rendering:** Users with reportsTo render as children (nested tree-node elements)
    5. **Alphabetical sorting:** Siblings rendered in alphabetical order by name
    6. **Theme prop:** Setting theme='light' adds theme-light class to host, 'dark' adds theme-dark
    7. **Editable prop:** Setting editable=true makes tiles draggable, editable=false makes them not draggable
    8. **Selected state:** After setting selectedUserId via click handler simulation, selected user tile has 'selected' class
    9. **Events emitted:** userClick event fires with correct UserEventDetail when tile clicked
    10. **Public methods:** getSelected() returns null when nothing selected; highlightUser() sets highlighted state; clearHighlight() removes it
    11. **Filter input:** Verify filter input element exists in rendered output
    12. **Editable drop zones:** When editable and dragging, drop zone elements are present

    Follow sp-example.spec.ts patterns:
    - Use functional assertions (textContent, querySelector, class checks) not toEqualHtml
    - Test rendered output and observable behavior, not implementation details
    - Use `page.rootInstance` to access component methods if needed
    - Use `page.waitForChanges()` after state mutations
  </action>
  <verify>
    Run `npm test` — all spec tests pass (no failures, no skipped).
    Verify test count: at minimum 30 test cases across the 4 spec files.
  </verify>
  <done>
    tree-builder.spec.ts: 8+ tests covering normal paths, edge cases, cycle detection.
    tree-filter.spec.ts: 7+ tests covering matching, ancestor chain, descendants.
    tree-sorter.spec.ts: 7+ tests covering sorting, case-insensitivity, immutability.
    sp-org-chart.spec.ts: 12+ tests covering props, state, events, methods, rendering.
    All tests pass with `npm test`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Playwright E2E tests for rendering and interactions</name>
  <files>
    src/components/sp-org-chart/sp-org-chart.e2e.ts
  </files>
  <action>
    Create Playwright E2E tests following sp-example.e2e.ts patterns. Use @stencil/playwright helpers for page setup.

    Follow the established pattern from sp-example.e2e.ts:
    - Import from @stencil/playwright
    - Use page.goto for test page navigation
    - Use page.locator for element selection
    - Use page.waitForChanges() where needed

    **E2E Test Cases:**

    **Rendering tests:**
    1. **Component renders:** sp-org-chart element is visible on page
    2. **Hierarchical tree renders:** Given sample data with 3 levels, verify correct number of user tiles rendered
    3. **User tile content:** Each tile displays user name and role text
    4. **Visual connectors present:** Verify connector CSS elements exist (tree-children elements with proper structure)
    5. **No-data message:** Component with empty users shows no-data message text
    6. **Custom no-data message:** Setting no-data-message attribute changes displayed text

    **Interaction tests:**
    7. **Single-click selects tile:** Click on user tile, verify it gains 'selected' class (blue border visible)
    8. **Click different tile deselects previous:** Click tile A then tile B, only B has 'selected' class
    9. **Double-click emits event:** Double-click a tile, verify userDblclick event fired (use page.evaluate to listen for event)
    10. **Filter by name:** Type in filter input, verify matching tiles remain visible and non-matching tiles have 'dimmed' class
    11. **Filter by role:** Type role text in filter input, verify correct tiles are dimmed/visible
    12. **Clear filter:** Type text then clear input, verify all tiles return to normal (no dimmed class)
    13. **Drag-and-drop (if feasible):** In editable mode, verify drop zones appear during drag. NOTE: HTML5 drag-and-drop is notoriously difficult to test in Playwright. If drag simulation is unreliable, test that drop zones render when component is in editable mode and verify the drag attribute is set on tiles.

    **Accessibility tests:**
    14. **Role attributes:** Component has appropriate ARIA roles (role="list" on tree container, role="listitem" on user tiles)
    15. **Filter input has label:** Filter input has aria-label or associated label element
    16. **User tiles are focusable:** User tiles can receive focus (tabindex or native interactive element)

    **Sample test data** (use in all tests that need users):
    ```typescript
    const sampleUsers = [
      { id: '1', name: 'Alice Johnson', role: 'CEO', reportsTo: undefined },
      { id: '2', name: 'Bob Smith', role: 'CTO', reportsTo: '1' },
      { id: '3', name: 'Carol White', role: 'Engineer', reportsTo: '2' },
      { id: '4', name: 'Dave Brown', role: 'CFO', reportsTo: '1' },
      { id: '5', name: 'Eve Davis', role: 'Analyst', reportsTo: '4' },
    ];
    ```

    Set users on the component via page.evaluate:
    ```typescript
    await page.evaluate((users) => {
      const el = document.querySelector('sp-org-chart');
      el.users = users;
    }, sampleUsers);
    ```

    For event testing, use page.evaluate to attach event listeners before triggering actions:
    ```typescript
    const eventPromise = page.evaluate(() => {
      return new Promise(resolve => {
        document.querySelector('sp-org-chart')
          .addEventListener('user-click', (e) => resolve(e.detail), { once: true });
      });
    });
    // ... trigger click ...
    const detail = await eventPromise;
    expect(detail.userId).toBe('1');
    ```

    For shadow DOM queries, use Playwright's shadow DOM piercing:
    ```typescript
    const tile = page.locator('sp-org-chart').locator('.user-tile').first();
    ```
    Or use the component's `>>>` shadow DOM piercing selector if available in the Stencil Playwright adapter.

    Update src/index.html to include the sp-org-chart demo section with sample data (if not already added in Plan 01) so E2E tests have a page to navigate to.
  </action>
  <verify>
    Run `npm run test.e2e` — all E2E tests pass.
    Verify test count: at minimum 14 E2E test cases.
    Run `npm run test.all` — both spec and E2E tests pass together.
  </verify>
  <done>
    E2E tests validate: component rendering, hierarchical structure, user tile content, no-data message, single-click selection, double-click events, filter by name/role, clear filter, editable mode, and accessibility attributes.
    All E2E tests pass with `npm run test.e2e`.
    Combined test suite passes with `npm run test.all`.
    TEST-01 and TEST-02 requirements satisfied for the sp-org-chart component.
  </done>
</task>

</tasks>

<verification>
1. `npm test` passes — all Jest spec tests green
2. `npm run test.e2e` passes — all Playwright E2E tests green
3. `npm run test.all` passes — combined suite green
4. Spec tests cover: props, state, events, methods, rendering, utility functions
5. E2E tests cover: rendering, interactions (click, filter, drag attributes), accessibility
6. Test count: 30+ spec tests, 14+ E2E tests
</verification>

<success_criteria>
- All spec tests pass covering props, state, events, methods (TEST-01)
- All E2E tests pass covering rendering, interactions, accessibility (TEST-02)
- Utility functions have dedicated unit tests with edge cases
- Tests follow established sp-example patterns
- No skipped or pending tests — all assertions active
</success_criteria>

<output>
After completion, create `.planning/phases/02-orgchart-component/02-02-SUMMARY.md`
</output>
