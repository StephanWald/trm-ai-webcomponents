---
phase: 07-org-chart-parity
plan: 03
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - src/components/sp-org-chart/sp-org-chart.tsx
  - src/components/sp-org-chart/sp-org-chart.css
  - src/components/sp-org-chart/sp-org-chart.spec.ts
  - src/components/sp-org-chart/sp-org-chart.e2e.ts
autonomous: true
requirements:
  - ORGC-05
  - ORGC-06
  - ORGC-07
  - ORGC-08

must_haves:
  truths:
    - "Dragging a user node shows a custom floating preview (avatar + name) following the cursor, with native drag image hidden"
    - "Drop zones appear at bottom-right of the component with SVG icons for Unlink and Delete actions"
    - "Holding a dragged user over the Delete drop zone for 4 seconds triggers deletion with a circular countdown overlay that follows the cursor"
    - "Branch filtering with filterMode='highlight' dims non-matching users while keeping all branches visible"
    - "Branch filtering with filterMode='isolate' hides unrelated branches entirely and dims non-matching users"
  artifacts:
    - path: "src/components/sp-org-chart/sp-org-chart.tsx"
      provides: "Custom drag preview rendering, SVG drop zones, timed delete with cursor-following countdown, branch filter integration"
      contains: "dragPreview"
    - path: "src/components/sp-org-chart/sp-org-chart.css"
      provides: "Drag preview styles, bottom-right drop zones, countdown overlay, SVG icon sizing"
      contains: "drag-preview"
    - path: "src/components/sp-org-chart/sp-org-chart.spec.ts"
      provides: "Tests for custom drag preview, SVG drop zones, timed delete countdown, branch filtering"
      contains: "drag-preview"
    - path: "src/components/sp-org-chart/sp-org-chart.e2e.ts"
      provides: "Updated E2E tests for vertical layout, branch filtering, and interaction flows"
      contains: "firstName"
  key_links:
    - from: "src/components/sp-org-chart/sp-org-chart.tsx"
      to: "src/components/sp-org-chart/sp-org-chart.css"
      via: "drag-preview, drop-zone-container, countdown-overlay CSS classes"
      pattern: "drag-preview|drop-zone-container|countdown-overlay"
    - from: "src/components/sp-org-chart/sp-org-chart.tsx"
      to: "src/components/sp-org-chart/utils/tree-filter.ts"
      via: "filterByBranch for branch-based filtering"
      pattern: "filterByBranch"
---

<objective>
Implement the prototype-matching drag-and-drop UX (custom floating preview, SVG drop zones, timed delete with countdown overlay) and refine branch filtering behavior.

Purpose: The current drag-and-drop uses native browser drag images and emoji drop zone icons. The prototype requires a custom floating preview (avatar + name following the cursor), SVG-based drop zone icons positioned at bottom-right, and a 4-second timed delete with a cursor-following circular countdown. Branch filtering must dim/hide correctly.

Output: Prototype-matching drag-and-drop interactions, SVG drop zones, timed delete UX, refined branch filtering, and comprehensive tests.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-org-chart-parity/07-CONTEXT.md
@.planning/phases/07-org-chart-parity/07-01-SUMMARY.md
@.planning/phases/07-org-chart-parity/07-02-SUMMARY.md
@src/components/sp-org-chart/sp-org-chart.tsx
@src/components/sp-org-chart/sp-org-chart.css
@src/components/sp-org-chart/types/org-chart.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement custom drag preview and SVG drop zones with timed delete</name>
  <files>
    src/components/sp-org-chart/sp-org-chart.tsx
    src/components/sp-org-chart/sp-org-chart.css
  </files>
  <action>
**1. Custom floating drag preview (ORGC-06):**

Add state for tracking drag preview position and the dragged user data:
```typescript
@State() dragPreviewPos: { x: number; y: number } | null = null;
@State() draggedUser: User | null = null;
```

Modify `handleDragStart` to:
- Hide the native drag image using a 1x1 transparent canvas: `ev.dataTransfer!.setDragImage(transparentImg, 0, 0)`
- Store the dragged user object in state
- Create the transparent image once in componentWillLoad or as a class property:
  ```typescript
  private transparentImg: HTMLImageElement;
  // In componentWillLoad:
  this.transparentImg = new Image(1, 1);
  this.transparentImg.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
  ```

Add a document-level `dragover` listener (attached in handleDragStart, removed in cleanupDragState) that updates `dragPreviewPos`:
```typescript
private handleDocumentDragOver = (ev: DragEvent) => {
  ev.preventDefault();
  this.dragPreviewPos = { x: ev.clientX, y: ev.clientY };
};
```

Render the floating preview in the component's render():
```tsx
{this.draggedUser && this.dragPreviewPos && (
  <div class="drag-preview" style={{
    left: `${this.dragPreviewPos.x + 12}px`,
    top: `${this.dragPreviewPos.y + 12}px`,
  }}>
    <div class="drag-preview__avatar">
      {this.draggedUser.avatar ? (
        <img src={this.draggedUser.avatar} alt="" class="avatar-img" />
      ) : (
        <div class="avatar-initials">{this.getUserInitials(this.draggedUser as unknown as TreeNode)}</div>
      )}
    </div>
    <div class="drag-preview__name">{getDisplayName(this.draggedUser)}</div>
  </div>
)}
```

CSS for drag preview:
```css
.drag-preview {
  position: fixed;
  pointer-events: none;
  z-index: 1000;
  display: flex;
  align-items: center;
  gap: var(--dwc-spacing-sm, 8px);
  padding: var(--dwc-spacing-xs, 4px) var(--dwc-spacing-sm, 8px);
  background: var(--dwc-color-surface, #ffffff);
  border: 1px solid var(--dwc-color-primary, #0066cc);
  border-radius: var(--dwc-border-radius, 6px);
  box-shadow: var(--dwc-shadow-md, 0 4px 12px rgba(0,0,0,0.15));
  opacity: 0.9;
}

.drag-preview__avatar {
  width: 28px;
  height: 28px;
  min-width: 28px;
  border-radius: var(--dwc-border-radius-full, 50%);
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}

.drag-preview__name {
  font-size: var(--dwc-font-size-sm, 12px);
  font-weight: var(--dwc-font-weight-medium, 500);
  color: var(--dwc-color-text, #1a1a1a);
  white-space: nowrap;
}
```

Clean up in `cleanupDragState`:
```typescript
document.removeEventListener('dragover', this.handleDocumentDragOver);
this.dragPreviewPos = null;
this.draggedUser = null;
```

**2. SVG drop zones at bottom-right (ORGC-07):**

Replace the current centered drop zones with bottom-right positioned drop zones using SVG icons instead of emoji.

Update `renderDropZones()`:
```tsx
private renderDropZones() {
  if (!this.showDropZones) return null;

  return (
    <div class="drop-zone-container">
      <div
        class="drop-zone drop-zone--unlink"
        part="drop-zone"
        onDragOver={ev => this.handleDragOver(ev)}
        onDrop={ev => this.handleDrop(ev, null)}
        onDragLeave={ev => this.handleDragLeave(ev)}
      >
        <svg class="drop-zone__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12" />
        </svg>
        <span class="drop-zone__label">Unlink</span>
      </div>

      <div
        class={{ 'drop-zone': true, 'drop-zone--delete': true, 'delete-holding': this.deleteHoldActive }}
        part="drop-zone"
        onDragOver={ev => this.handleDeleteZoneDragOver(ev)}
        onDrop={ev => this.handleDeleteZoneRelease(ev)}
        onDragLeave={ev => this.handleDeleteZoneDragLeave(ev)}
      >
        <svg class="drop-zone__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" />
        </svg>
        <span class="drop-zone__label">Delete</span>
        {this.deleteHoldActive && this.renderDeleteCountdown()}
      </div>
    </div>
  );
}
```

CSS for bottom-right positioned drop zones:
```css
.drop-zone-container {
  position: fixed;
  bottom: var(--dwc-spacing-lg, 20px);
  right: var(--dwc-spacing-lg, 20px);
  display: flex;
  flex-direction: column;
  gap: var(--dwc-spacing-sm, 8px);
  z-index: 100;
}

.drop-zone__icon {
  width: 24px;
  height: 24px;
}
```

**3. Timed delete with cursor-following countdown overlay (ORGC-08):**

Replace the current long-press deletion with drag-hold-on-delete-zone behavior:

Add state:
```typescript
@State() deleteHoldActive: boolean = false;
@State() deleteHoldProgress: number = 0;
@State() deleteCountdownPos: { x: number; y: number } | null = null;
```

Add timer property:
```typescript
private deleteHoldTimer: number | null = null;
private deleteHoldStartTime: number = 0;
```

New handlers for the delete drop zone:
```typescript
private handleDeleteZoneDragOver = (ev: DragEvent) => {
  ev.preventDefault();
  ev.stopPropagation();
  ev.dataTransfer!.dropEffect = 'move';
  this.deleteCountdownPos = { x: ev.clientX, y: ev.clientY };

  if (!this.deleteHoldActive) {
    this.deleteHoldActive = true;
    this.deleteHoldStartTime = Date.now();
    this.deleteHoldProgress = 0;

    this.deleteHoldTimer = window.setInterval(() => {
      const elapsed = Date.now() - this.deleteHoldStartTime;
      this.deleteHoldProgress = Math.min(elapsed / this.LONG_PRESS_DURATION, 1);

      if (this.deleteHoldProgress >= 1) {
        // 4 seconds elapsed — execute delete
        this.cancelDeleteHold();
        const draggedId = this.draggedUserId;
        if (draggedId) {
          this.deleteUser(draggedId);
        }
        this.cleanupDragState();
      }
    }, 16);
  }
};

private handleDeleteZoneDragLeave = (ev: DragEvent) => {
  ev.stopPropagation();
  this.cancelDeleteHold();
  this.dropTargetId = null;
};

private handleDeleteZoneRelease = (ev: DragEvent) => {
  // If released before 4 seconds, cancel (no instant delete on drop)
  ev.preventDefault();
  ev.stopPropagation();
  this.cancelDeleteHold();
  this.cleanupDragState();
};

private cancelDeleteHold() {
  if (this.deleteHoldTimer) {
    window.clearInterval(this.deleteHoldTimer);
    this.deleteHoldTimer = null;
  }
  this.deleteHoldActive = false;
  this.deleteHoldProgress = 0;
  this.deleteCountdownPos = null;
}
```

Render the cursor-following countdown overlay:
```tsx
private renderDeleteCountdown() {
  if (!this.deleteCountdownPos) return null;

  const circumference = 2 * Math.PI * 20;
  const offset = circumference * (1 - this.deleteHoldProgress);
  const seconds = Math.ceil((1 - this.deleteHoldProgress) * 4);

  return (
    <div class="countdown-overlay" style={{
      left: `${this.deleteCountdownPos.x}px`,
      top: `${this.deleteCountdownPos.y - 60}px`,
    }}>
      <svg width="50" height="50" viewBox="0 0 50 50">
        <circle cx="25" cy="25" r="20" fill="rgba(0,0,0,0.7)" />
        <circle
          class="countdown-ring__circle"
          cx="25" cy="25" r="20"
          fill="transparent"
          stroke="var(--dwc-color-danger, #dc3545)"
          stroke-width="3"
          style={{
            strokeDasharray: `${circumference} ${circumference}`,
            strokeDashoffset: `${offset}`,
          }}
        />
        <text x="25" y="30" text-anchor="middle" fill="white" font-size="16" font-weight="bold">{seconds}</text>
      </svg>
    </div>
  );
}
```

CSS for countdown overlay:
```css
.countdown-overlay {
  position: fixed;
  pointer-events: none;
  z-index: 1001;
  transform: translate(-25px, 0);
}
```

**Remove the old long-press handlers** (handlePointerDown, handlePointerMove, handlePointerUp, cancelLongPress, handleLongPressComplete, longPressTimer, longPressStartTime, longPressStartPos, longPressUserId, longPressProgress) — the timed delete is now via the delete drop zone, not long-press on tiles. Remove the pointerdown/pointermove/pointerup event bindings from user tiles. Remove the old countdown ring rendering from inside user tiles.

Also remove the old `handleDeleteDrop` — deletion now happens via the timed hold, not an instant drop.

**4. Update cleanupTimers** to cancel deleteHoldTimer as well.

**5. Update disconnectedCallback** to clean up the document dragover listener if active.

**6. Branch filtering integration (ORGC-05):**
This was partially implemented in Plan 02. Verify and refine:
- `filterMode='highlight'` + `filterBranchId` set: dims non-matching users, keeps all branches visible
- `filterMode='isolate'` + `filterBranchId` set: hides unrelated branches (branches with no matching users), dims non-matching users in visible branches
- `filterMode='none'`: shows everything (default)

No additional code needed if Plan 02 implemented it correctly. Add integration verification here.
  </action>
  <verify>`npx stencil build --dev 2>&1 | tail -5` compiles without errors. Visual check: drag a tile and see floating preview following cursor; drop zones appear at bottom-right with SVG icons; holding over delete zone shows countdown.</verify>
  <done>Custom floating drag preview follows cursor with avatar+name. Native drag image hidden. Drop zones positioned at bottom-right with SVG trash/unlink icons. Delete zone requires 4-second hold with cursor-following circular countdown showing seconds remaining. Old long-press deletion removed. Branch filtering dims/hides correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Update spec and E2E tests for drag-drop and filtering</name>
  <files>
    src/components/sp-org-chart/sp-org-chart.spec.ts
    src/components/sp-org-chart/sp-org-chart.e2e.ts
  </files>
  <action>
**Spec test updates (sp-org-chart.spec.ts):**

Remove all old long-press tests (handlePointerDown, handlePointerMove, handlePointerUp, cancelLongPress, countdown ring on tile). These are replaced by:

Add new tests for:
1. **Custom drag preview rendering**: When draggedUser and dragPreviewPos state are set, a `.drag-preview` element renders with avatar and name.
2. **SVG drop zones**: When showDropZones is true, drop zones render with `<svg>` icons (not emoji), positioned via `.drop-zone-container` class.
3. **Delete hold countdown**: When deleteHoldActive is true and deleteCountdownPos is set, the `.countdown-overlay` element renders with SVG ring and countdown text.
4. **Delete hold cancel on leave**: Calling handleDeleteZoneDragLeave resets deleteHoldActive to false and deleteHoldProgress to 0.
5. **Branch filtering props**:
   - Setting filterMode='highlight' and filterBranchId applies dimmed class to non-matching user tiles
   - Setting filterMode='isolate' and filterBranchId hides unrelated branch tiles (not rendered)
   - Setting filterMode='none' shows all tiles

Update existing drag-and-drop tests:
- Remove `handleDeleteDrop` test (replaced by timed delete)
- Update assertions for `handleDragStart` to verify transparent drag image is set
- Keep hierarchy-change event tests (unlink drop still emits hierarchyChange)

**E2E test updates (sp-org-chart.e2e.ts):**

Rewrite E2E tests for the new component behavior. Update all test data to use new User interface (firstName, lastName, etc.).

Tests to include:
1. Component renders with vertical list layout (tree-node elements stacked vertically, not horizontally)
2. User tiles show expanded info (name, role, email, phone)
3. Branch tiles render with square avatar and branch styling
4. Editable prop defaults to true (tiles draggable)
5. Branch filtering via attribute: setting `filter-mode="highlight"` and `filter-branch-id="branch1"` dims non-matching tiles
6. Drop zones appear when drag starts (verify via attribute manipulation or page.evaluate)
7. Component emits custom events (basic smoke test for userClick)

Follow existing E2E patterns: use `page.evaluate` for shadow DOM interaction, use `page.waitForChanges()` for stability.

Run with: `npx stencil test --spec -- --testPathPattern="sp-org-chart"` for spec tests and `npx stencil test --e2e -- --testPathPattern="sp-org-chart"` for E2E tests.
  </action>
  <verify>
    `npx stencil test --spec -- --testPathPattern="sp-org-chart.spec"` — all spec tests pass with >= 70% coverage
    `npx stencil test --e2e -- --testPathPattern="sp-org-chart.e2e"` — all E2E tests pass
  </verify>
  <done>Spec tests cover custom drag preview, SVG drop zones, timed delete countdown, delete hold cancel, branch filtering via props. E2E tests cover vertical list rendering, expanded tile info, branch tiles, editable default, branch filtering attributes, event emission. All tests pass. Coverage >= 70%.</done>
</task>

</tasks>

<verification>
1. `npx stencil build --dev` compiles without errors
2. `npx stencil test --spec -- --testPathPattern="sp-org-chart"` — all spec tests pass with >= 70% coverage
3. `npx stencil test --e2e -- --testPathPattern="sp-org-chart"` — all E2E tests pass
4. Custom drag preview: floating element with avatar+name follows cursor during drag
5. Drop zones: positioned bottom-right with SVG icons (not emoji)
6. Timed delete: 4-second hold on delete zone with countdown overlay; releasing before 4s cancels
7. Branch filtering: highlight mode dims, isolate mode hides, none mode shows all
8. No old long-press code remains (no pointerdown/up/move on tiles for deletion)
</verification>

<success_criteria>
- Custom floating drag preview renders during drag with avatar and display name
- Native drag ghost image is hidden
- Drop zones appear at bottom-right with SVG trash and unlink icons
- Delete requires 4-second hold on delete drop zone with visible countdown
- Countdown overlay follows cursor position
- Releasing before 4 seconds cancels deletion
- Branch filtering dims non-matching users (highlight mode)
- Branch filtering hides unrelated branches (isolate mode)
- All spec and E2E tests pass
- Component coverage >= 70%
</success_criteria>

<output>
After completion, create `.planning/phases/07-org-chart-parity/07-03-SUMMARY.md`
</output>
