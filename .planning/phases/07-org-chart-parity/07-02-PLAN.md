---
phase: 07-org-chart-parity
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/components/sp-org-chart/sp-org-chart.tsx
  - src/components/sp-org-chart/sp-org-chart.css
  - src/components/sp-org-chart/sp-org-chart.spec.ts
autonomous: true
requirements:
  - ORGC-01
  - ORGC-03
  - ORGC-04
  - ORGC-09
  - ORGC-10
  - ORGC-11
  - ORGC-12

must_haves:
  truths:
    - "Org chart renders as a vertical indented list with subordinates nested below/right with left-margin indent and CSS border connectors"
    - "User tiles display horizontally — avatar on the left, name/role/email/phone/branch-badge on the right"
    - "Branch entities render with square logo avatar and branch-specific styling (no border-radius-full on avatar)"
    - "Editable prop defaults to true"
    - "Component emits user-click, user-dblclick, hierarchy-change, and user-delete events with correct detail shapes"
    - "highlightUser, scrollToUser, clearHighlight, and getSelected public methods work correctly"
    - "All colors and fonts use DWC CSS custom properties with sensible fallback defaults"
  artifacts:
    - path: "src/components/sp-org-chart/sp-org-chart.tsx"
      provides: "Rewritten component with vertical list layout, expanded tile rendering, events, methods"
      contains: "renderTreeNode"
    - path: "src/components/sp-org-chart/sp-org-chart.css"
      provides: "Vertical indented list CSS with border connectors, horizontal tile layout, branch tile styling, DWC theming"
      contains: "tree-children"
    - path: "src/components/sp-org-chart/sp-org-chart.spec.ts"
      provides: "Updated spec tests for new rendering, events, methods, and DWC theming"
      contains: "firstName"
  key_links:
    - from: "src/components/sp-org-chart/sp-org-chart.tsx"
      to: "src/components/sp-org-chart/types/org-chart.types.ts"
      via: "imports User, TreeNode, getDisplayName, isBranch, BranchFilterMode"
      pattern: "import.*getDisplayName.*isBranch.*from.*types"
    - from: "src/components/sp-org-chart/sp-org-chart.tsx"
      to: "src/components/sp-org-chart/utils/tree-builder.ts"
      via: "builds tree from users prop"
      pattern: "buildTree\\(this\\.users\\)"
    - from: "src/components/sp-org-chart/sp-org-chart.css"
      to: "DWC theme engine"
      via: "CSS custom properties with fallback defaults"
      pattern: "var\\(--dwc-"
---

<objective>
Rewrite the sp-org-chart component rendering from horizontal tree to vertical indented list layout with expanded tile content matching the original prototype.

Purpose: The current component renders a horizontal tree with centered card layout. The prototype uses a vertical indented list (subordinates nested below and indented right) with horizontal user tiles showing full contact info. This is a fundamental layout paradigm shift requiring a full rewrite of the TSX render methods and CSS.

Output: Rewritten sp-org-chart.tsx with vertical list layout and expanded tiles, rewritten sp-org-chart.css with indentation connectors and DWC theming, and updated spec tests.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-org-chart-parity/07-CONTEXT.md
@.planning/phases/07-org-chart-parity/07-01-SUMMARY.md
@src/components/sp-org-chart/sp-org-chart.tsx
@src/components/sp-org-chart/sp-org-chart.css
@src/components/sp-org-chart/types/org-chart.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite component TSX for vertical list layout and expanded tiles</name>
  <files>src/components/sp-org-chart/sp-org-chart.tsx</files>
  <action>
Rewrite sp-org-chart.tsx to match the prototype layout. Key changes:

**1. Imports**: Update imports to include `getDisplayName`, `isBranch`, `BranchFilterMode` from types. Import `filterByBranch` from tree-filter.

**2. Props changes**:
- Change `editable` default from `false` to `true` (ORGC-09)
- Remove the text-based filter input and `filterText` state (the prototype uses branch filtering, not text search)
- Add new props: `filterMode: BranchFilterMode = 'none'` and `filterBranchId: string = ''`
- Keep existing props: `users`, `noDataMessage`, `theme`

**3. State changes**:
- Remove `filterText` state
- Remove text-based `filterResults` state
- Add `branchFilterResults: Map<string, FilterResult> | null = null` state
- Keep: `treeData`, `selectedUserId`, `highlightedUserId`, `draggedUserId`, `showDropZones`, `dropTargetId`, `longPressUserId`, `longPressProgress`

**4. Watch handlers**:
- Add `@Watch('filterMode')` and `@Watch('filterBranchId')` that call a new `applyBranchFilter()` method
- `applyBranchFilter()`: if filterMode is 'none' or filterBranchId is empty, set branchFilterResults to null. Otherwise call `filterByBranch(this.treeData, this.filterBranchId, this.filterMode)`.

**5. Render — vertical indented list layout**:
Replace the horizontal tree render with a vertical indented list. The tree-container should be a vertical column. Each tree-node is a row (the tile) followed by an indented children container.

```tsx
private renderTreeNode = (node: TreeNode) => {
  const isSelected = this.selectedUserId === node.id;
  const isHighlighted = this.highlightedUserId === node.id;
  const isDimmed = this.shouldDimNode(node);
  const isHidden = this.shouldHideNode(node);
  const isDragOver = this.dropTargetId === node.id;
  const isLongPressing = this.longPressUserId === node.id;
  const branchEntity = isBranch(node);

  if (isHidden) return null;

  const tileClasses = {
    'user-tile': true,
    'branch-tile': branchEntity,
    selected: isSelected,
    highlighted: isHighlighted,
    dimmed: isDimmed,
    'drag-over': isDragOver,
  };

  return (
    <div class="tree-node">
      <div
        class={tileClasses}
        part="user-tile"
        data-user-id={node.id}
        draggable={this.editable}
        onClick={ev => this.handleUserClick(ev, node)}
        onDragStart={this.editable ? ev => this.handleDragStart(ev, node.id) : undefined}
        onDragOver={this.editable ? ev => this.handleDragOver(ev, node.id) : undefined}
        onDragLeave={this.editable ? ev => this.handleDragLeave(ev) : undefined}
        onDrop={this.editable ? ev => this.handleDrop(ev, node.id) : undefined}
        onDragEnd={this.editable ? ev => this.handleDragEnd(ev) : undefined}
        onPointerDown={this.editable ? ev => this.handlePointerDown(ev, node.id) : undefined}
        onPointerMove={this.editable ? ev => this.handlePointerMove(ev) : undefined}
        onPointerUp={this.editable ? ev => this.handlePointerUp(ev) : undefined}
      >
        {/* Avatar — circular for users, square for branches */}
        <div class={{ 'user-avatar': true, 'branch-avatar': branchEntity }}>
          {node.avatar || node.branchLogo ? (
            <img src={branchEntity ? (node.branchLogo || node.avatar) : node.avatar} alt={getDisplayName(node)} class="avatar-img" />
          ) : (
            <div class="avatar-initials">{this.getUserInitials(node)}</div>
          )}
        </div>

        {/* Info section — horizontal layout to the right of avatar */}
        <div class="user-info">
          <div class="user-name">{getDisplayName(node)}</div>
          <div class="user-role">{node.role}</div>
          {node.email && <div class="user-email">{node.email}</div>}
          {node.phone && <div class="user-phone">{node.phone}</div>}
          {node.branchName && !branchEntity && (
            <div class="user-branch-badge">{node.branchName}</div>
          )}
        </div>

        {isLongPressing && this.renderCountdownRing()}
      </div>

      {/* Children indented below */}
      {node.children.length > 0 && (
        <div class="tree-children">
          {node.children.map(child => this.renderTreeNode(child))}
        </div>
      )}
    </div>
  );
};
```

**6. Update getUserInitials** to work with the new data model:
```typescript
private getUserInitials(node: TreeNode): string {
  const parts = [node.firstName];
  if (node.lastName) parts.push(node.lastName);
  return parts.map(p => p.charAt(0)).join('').toUpperCase();
}
```

**7. Add shouldHideNode method** for 'isolate' filter mode:
```typescript
private shouldHideNode(node: TreeNode): boolean {
  if (!this.branchFilterResults || this.filterMode !== 'isolate') return false;
  const result = this.branchFilterResults.get(node.id);
  if (!result) return true;
  // Hide if branch entity and not matching and no matching descendants
  if (isBranch(node)) {
    return !(result.matched || result.hasMatchingDescendant);
  }
  return false;
}
```

**8. Update shouldDimNode** to use branchFilterResults:
```typescript
private shouldDimNode(node: TreeNode): boolean {
  if (!this.branchFilterResults) return false;
  const result = this.branchFilterResults.get(node.id);
  if (!result) return true;
  return !(result.matched || result.hasMatchingDescendant || result.isAncestorOfMatch);
}
```

**9. Remove the filter input** from the render() method. Remove the org-chart-toolbar entirely (prototype doesn't have one — filtering is done via props).

**10. Update event emissions**: Events should continue to work with the new User type. The `handleSingleClick` and `handleDoubleClick` methods need to find users using the new model. Since the User interface changed but `users.find(u => u.id === ...)` still works on `id`, no structural changes needed — just verify.

**11. Keep all existing public methods** (getSelected, highlightUser, clearHighlight, scrollToUser) — they work with `id` which hasn't changed.

**12. Keep all drag-and-drop handlers** — they'll be refined in Plan 03, but the basic structure stays for now. The drop zones and long-press handlers remain as-is. Plan 03 will add the custom floating preview and SVG drop zone icons.
  </action>
  <verify>`npx stencil build --dev 2>&1 | tail -5` compiles without type errors</verify>
  <done>Component renders a vertical indented list layout. User tiles show avatar (left) + name/role/email/phone/branch-badge (right). Branch entities render with square avatar. Editable defaults to true. Filter input removed; branch filtering via filterMode/filterBranchId props. All events and methods functional.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite CSS for vertical indented list with DWC theming</name>
  <files>src/components/sp-org-chart/sp-org-chart.css</files>
  <action>
Complete CSS rewrite to match the prototype's vertical indented list layout. The current horizontal tree layout CSS is entirely replaced.

**Layout structure — vertical indented list:**
```css
/* Tree renders as a vertical list. Each node is a row. */
.tree-container {
  display: flex;
  flex-direction: column;
  padding: var(--dwc-spacing-md, 12px);
}

/* Each tree node is a vertical stack: tile + children */
.tree-node {
  display: flex;
  flex-direction: column;
  position: relative;
}

/* Children are indented with left margin and border connectors */
.tree-children {
  display: flex;
  flex-direction: column;
  margin-left: var(--dwc-spacing-xl, 32px);
  padding-left: var(--dwc-spacing-md, 12px);
  border-left: 2px solid var(--dwc-color-border, #e0e0e0);
}
```

**Tile layout — horizontal (avatar left, info right):**
```css
.user-tile {
  display: flex;
  flex-direction: row;        /* Horizontal: avatar left, info right */
  align-items: center;
  padding: var(--dwc-spacing-sm, 8px) var(--dwc-spacing-md, 12px);
  margin: var(--dwc-spacing-xs, 4px) 0;
  background: var(--dwc-color-surface, #ffffff);
  border: 1px solid var(--dwc-color-border, #e0e0e0);
  border-radius: var(--dwc-border-radius, 6px);
  box-shadow: var(--dwc-shadow-sm, 0 1px 2px rgba(0,0,0,0.05));
  cursor: pointer;
  transition: box-shadow var(--dwc-transition-fast, 150ms) ease,
    border-color var(--dwc-transition-fast, 150ms) ease;
  position: relative;
  user-select: none;
  gap: var(--dwc-spacing-sm, 8px);
}
```

**CSS border connectors for indentation:**
Each child has a horizontal connector line from the left border to the tile:
```css
/* Horizontal connector from vertical line to child tile */
.tree-children > .tree-node::before {
  content: '';
  position: absolute;
  top: calc(var(--dwc-spacing-sm, 8px) + 20px); /* Center on avatar */
  left: calc(-1 * var(--dwc-spacing-md, 12px));
  width: var(--dwc-spacing-md, 12px);
  height: 2px;
  background: var(--dwc-color-border, #e0e0e0);
}
```

**Avatar styling:**
```css
.user-avatar {
  width: 40px;
  height: 40px;
  min-width: 40px;
  border-radius: var(--dwc-border-radius-full, 50%);
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Branch entities get square avatar */
.branch-avatar {
  border-radius: var(--dwc-border-radius, 6px);
}
```

**User info:**
```css
.user-info {
  display: flex;
  flex-direction: column;
  min-width: 0;  /* Allow text truncation */
}

.user-name {
  font-weight: var(--dwc-font-weight-semibold, 600);
  color: var(--dwc-color-text, #1a1a1a);
  font-size: var(--dwc-font-size-base, 14px);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.user-role {
  color: var(--dwc-color-text-secondary, #666666);
  font-size: var(--dwc-font-size-sm, 12px);
}

.user-email, .user-phone {
  color: var(--dwc-color-text-secondary, #666666);
  font-size: var(--dwc-font-size-sm, 12px);
}

.user-branch-badge {
  display: inline-block;
  padding: 1px 6px;
  margin-top: 2px;
  font-size: var(--dwc-font-size-xs, 11px);
  background: var(--dwc-color-primary-surface, rgba(0, 102, 204, 0.08));
  color: var(--dwc-color-primary, #0066cc);
  border-radius: var(--dwc-border-radius-sm, 3px);
  font-weight: var(--dwc-font-weight-medium, 500);
  white-space: nowrap;
}
```

**Branch tile styling:**
```css
.branch-tile {
  background: var(--dwc-color-surface-alt, #f8f9fa);
  border-color: var(--dwc-color-primary, #0066cc);
  border-left: 3px solid var(--dwc-color-primary, #0066cc);
}
```

**State classes** (selected, highlighted, dimmed, drag-over): keep same visual behavior as current, just adapt colors to DWC tokens with fallback defaults.

**EVERY var() must have a fallback default.** No bare `var(--dwc-*)` calls. Pattern: `var(--dwc-token-name, fallback-value)`.

**Remove the toolbar CSS** (.org-chart-toolbar, .filter-input) entirely since the filter input is removed.

**Keep drop-zone and countdown-ring CSS** largely as-is (Plan 03 will refine drop zones to bottom-right position with SVG icons).

**Theme overrides** (:host(.theme-light), :host(.theme-dark)): keep the pattern but update selectors to match new class names. Update connector colors in dark theme.
  </action>
  <verify>Build succeeds: `npx stencil build --dev 2>&1 | tail -5`. Visual inspection can be done in Plan 03's verification or via the dev server.</verify>
  <done>CSS renders a vertical indented list layout with left-border connectors. User tiles are horizontal (avatar left, info right). Branch tiles have square avatars and distinct border. All CSS values use DWC custom properties with fallback defaults. Theme light/dark overrides present.</done>
</task>

<task type="auto">
  <name>Task 3: Update component spec tests for new rendering and behavior</name>
  <files>src/components/sp-org-chart/sp-org-chart.spec.ts</files>
  <action>
Rewrite the spec test file to test the new component behavior. This is a substantial rewrite since the component layout and data model changed.

**Key changes in test data**: All User objects must use the new interface:
- Before: `{ id: '1', name: 'Alice Johnson', role: 'CEO' }`
- After: `{ id: '1', firstName: 'Alice', lastName: 'Johnson', role: 'CEO' }`

**Tests to update/rewrite:**

1. **Rendering tests**: Update assertions for vertical list layout:
   - tree-container exists with tree-node children in vertical list
   - User tiles show avatar + name + role + email + phone + branch badge
   - Branch entities render with `.branch-tile` class and `.branch-avatar` class
   - No filter input in the DOM (removed)

2. **Editable default**: Change test — editable should default to `true` now, not `false`. Tiles should be draggable by default.

3. **Branch filtering tests**: Replace text filter tests with branch filter prop tests:
   - Setting filterMode='highlight' and filterBranchId dims non-matching users
   - Setting filterMode='isolate' hides unrelated branches
   - Setting filterMode='none' shows all users

4. **Event tests**: Keep userClick, userDblclick, hierarchyChange, userDelete event tests but update User objects in assertions to match new interface shape.

5. **Method tests**: Keep getSelected, highlightUser, clearHighlight, scrollToUser tests — update User objects.

6. **Interaction tests**: Keep drag-and-drop, long-press, click/double-click handler tests — update User objects.

7. **Theme tests**: Keep theme-light/theme-dark class tests unchanged.

8. **DWC fallback test**: Add test that component renders without errors when no DWC tokens are loaded (keep existing pattern).

**Import changes**: Import User type from new location. Import the helpers if needed for test assertions.

Run with: `npx stencil test --spec -- --testPathPattern="sp-org-chart.spec"`
  </action>
  <verify>`npx stencil test --spec -- --testPathPattern="sp-org-chart.spec"` — all tests pass. Coverage for sp-org-chart.tsx remains at or above 70%.</verify>
  <done>All spec tests pass with new data model. Tests verify vertical list layout, horizontal tile rendering, branch entity styling, editable=true default, branch filtering via props, all events/methods, DWC theming fallbacks. Coverage >= 70%.</done>
</task>

</tasks>

<verification>
1. `npx stencil build --dev` compiles without errors
2. `npx stencil test --spec -- --testPathPattern="sp-org-chart"` — all spec tests pass
3. Component renders vertical indented list (not horizontal tree)
4. User tiles show full contact info horizontally (avatar left, info right)
5. Branch tiles have square avatars and distinct styling
6. Editable defaults to true
7. All events (user-click, user-dblclick, hierarchy-change, user-delete) emit with correct detail
8. All methods (getSelected, highlightUser, clearHighlight, scrollToUser) work
9. Branch filtering props (filterMode, filterBranchId) control visibility
</verification>

<success_criteria>
- Vertical indented list layout replaces horizontal tree
- User tiles show avatar, name, role, email, phone, branch badge in horizontal layout
- Branch entities render with square logo avatar and branch styling
- Editable defaults to true
- Events and methods work with expanded User model
- Branch filtering via filterMode/filterBranchId dims/hides appropriately
- All CSS uses DWC custom properties with fallback defaults
- Spec tests pass with >= 70% coverage
</success_criteria>

<output>
After completion, create `.planning/phases/07-org-chart-parity/07-02-SUMMARY.md`
</output>
