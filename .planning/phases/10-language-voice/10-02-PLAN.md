---
phase: 10-language-voice
plan: 02
type: execute
wave: 2
depends_on: [10-01]
files_modified:
  - src/components/sp-voice-input-button/types.ts
  - src/components/sp-voice-input-button/sp-voice-input-button.tsx
  - src/components/sp-voice-input-button/sp-voice-input-button.css
  - src/index.html
autonomous: true
requirements: [VOIC-01, VOIC-02, VOIC-03, VOIC-04, VOIC-05, VOIC-06]

must_haves:
  truths:
    - "sp-voice-input-button renders as a 44px circular button with a microphone SVG icon"
    - "Hovering the button triggers a 2-second progress bar cue, then the language dropdown appears"
    - "When listening, the button turns red with a pulse animation and a blinking recording indicator"
    - "Component emits start, stop, error, transcriptionUpdate, and languageChange events"
    - "Error state triggers a shake animation with an error message display"
    - "Mode indicator shows a globe icon (browser mode) or robot icon (AI mode) based on mode prop"
  artifacts:
    - path: "src/components/sp-voice-input-button/types.ts"
      provides: "VoiceInputMode type, VoiceInputState type, event detail interfaces"
    - path: "src/components/sp-voice-input-button/sp-voice-input-button.tsx"
      provides: "Circular button with microphone icon, hover language cue, listening/error states, mode indicator"
    - path: "src/components/sp-voice-input-button/sp-voice-input-button.css"
      provides: "44px circle, pulse animation, shake animation, progress bar, recording indicator"
  key_links:
    - from: "src/components/sp-voice-input-button/sp-voice-input-button.tsx"
      to: "sp-language-selector types"
      via: "Imports LanguageChangeEventDetail from sp-language-selector/types"
      pattern: "import.*LanguageChangeEventDetail"
    - from: "src/components/sp-voice-input-button/sp-voice-input-button.tsx"
      to: "sp-popover + sp-language-list"
      via: "Renders sp-popover containing sp-language-list for hover language dropdown"
      pattern: "<sp-popover"
    - from: "src/components/sp-voice-input-button/sp-voice-input-button.tsx"
      to: "voice events"
      via: "Emits start, stop, error, transcriptionUpdate events on state transitions"
      pattern: "this\\.(voiceStart|voiceStop|voiceError|transcriptionUpdate)\\.emit"
---

<objective>
Build sp-voice-input-button as a Stencil web component with microphone icon, hover-triggered language cue, listening/error visual states, pulse/shake animations, and mode indicator.

Purpose: Deliver the voice input trigger button that integrates with the language selection system built in Plan 01, providing visual feedback for recording state, errors, and AI/browser mode via DWC-themed animations.

Output: Working sp-voice-input-button Stencil component with types, CSS animations (pulse, shake, progress bar, blinking indicator), and full event API.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-language-voice/10-01-SUMMARY.md
@src/components/sp-language-selector/types.ts
@src/components/sp-language-selector/utils/icons.tsx
@src/components/sp-popover/sp-popover.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create voice input types and robot icon helper</name>
  <files>
    src/components/sp-voice-input-button/types.ts
    src/components/sp-language-selector/utils/icons.tsx
  </files>
  <action>
**types.ts** — Voice input type definitions:
- `VoiceInputMode` type: `'browser' | 'ai'` — determines whether speech recognition uses browser API or AI service
- `VoiceInputState` type: `'idle' | 'hover-cue' | 'language-select' | 'listening' | 'error'` — visual state machine
- `VoiceStartEventDetail` interface: `{ language: string; mode: VoiceInputMode }`
- `VoiceStopEventDetail` interface: `{ language: string; mode: VoiceInputMode }`
- `VoiceErrorEventDetail` interface: `{ message: string; language: string; mode: VoiceInputMode }`
- `TranscriptionUpdateEventDetail` interface: `{ text: string; isFinal: boolean; language: string; mode: VoiceInputMode }`

**utils/icons.tsx** — Add robot icon to existing icon helpers file (from Plan 01):
- `renderRobotIcon(size?: number)` — Tabler robot icon (24x24 viewBox, stroke-based, `currentColor`, `stroke-width="2"`). The Tabler robot icon is a rounded rectangle head with two circular eyes and antenna.
- This file already has renderGlobeIcon, renderChevronDownIcon, renderCheckIcon, renderMicrophoneIcon from Plan 01. Only ADD renderRobotIcon — do not modify existing icons.
  </action>
  <verify>
Build passes: `npx stencil build` exits 0. TypeScript compiles. types.ts exports all 6 type/interface definitions. icons.tsx exports 5 icon functions total (4 from Plan 01 + 1 new renderRobotIcon).
  </verify>
  <done>
Voice input types define the full state machine and event payloads. Robot icon helper added for mode indicator rendering.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build sp-voice-input-button component with all visual states and animations</name>
  <files>
    src/components/sp-voice-input-button/sp-voice-input-button.tsx
    src/components/sp-voice-input-button/sp-voice-input-button.css
    src/index.html
  </files>
  <action>
**sp-voice-input-button.tsx** — Stencil component with shadow DOM:

Props:
- `mode: VoiceInputMode` — 'browser' or 'ai' (default: 'browser') (VOIC-06)
- `selectedLanguage: string` — language code for voice input (default: 'en', mutable, reflect)
- `disabled: boolean` — disables the button (default: false)
- `compact: boolean` — compact display mode (default: false)
- `theme: 'light' | 'dark' | 'auto'` — DWC theme override (default: 'auto')
- `hoverCueDuration: number` — ms for hover progress bar before showing language dropdown (default: 2000) (VOIC-02)

Events (VOIC-04):
- `voiceStart: EventEmitter<VoiceStartEventDetail>` — emitted when listening begins
- `voiceStop: EventEmitter<VoiceStopEventDetail>` — emitted when listening ends
- `voiceError: EventEmitter<VoiceErrorEventDetail>` — emitted on error
- `transcriptionUpdate: EventEmitter<TranscriptionUpdateEventDetail>` — emitted on speech result
- `languageChange: EventEmitter<LanguageChangeEventDetail>` — bubbled from language list selection

State:
- `currentState: VoiceInputState` — visual state machine (default: 'idle')
- `errorMessage: string` — current error message text (default: '')
- `hoverProgress: number` — 0 to 100 progress during hover cue (default: 0)

Element ref: `@Element() el: HTMLElement`

Private members:
- `hoverTimer: ReturnType<typeof setInterval> | null` — interval for hover progress animation
- `popoverRef: HTMLSpPopoverElement | null` — ref to language popover
- `preferredLanguages: string[]` — cached from getBrowserPreferredLanguages() in componentWillLoad()

Lifecycle:
- `componentWillLoad()`: compute preferred languages via getBrowserPreferredLanguages()
- `disconnectedCallback()`: clear hoverTimer

State machine transitions:
- `idle → hover-cue`: on mouseenter (if not disabled, not listening). Start interval incrementing `hoverProgress` from 0 to 100 over `hoverCueDuration` ms (use ~50ms interval steps).
- `hover-cue → language-select`: when hoverProgress reaches 100. Clear interval. Open language popover.
- `hover-cue → idle`: on mouseleave before progress completes. Clear interval. Reset hoverProgress to 0.
- `language-select → idle`: on language selection or popover close. Close popover.
- `idle → listening`: when parent calls startListening() method. Emit voiceStart event.
- `listening → idle`: when parent calls stopListening() method. Emit voiceStop event.
- `listening → error` / `idle → error`: when parent calls setError(message) method. Emit voiceError event. Auto-clear error after 3 seconds back to idle.

Public methods:
- `async startListening()`: transition to listening state, emit voiceStart
- `async stopListening()`: transition to idle state, emit voiceStop
- `async setError(message: string)`: transition to error state with message, emit voiceError, auto-clear after 3s
- `async emitTranscription(text: string, isFinal: boolean)`: emit transcriptionUpdate event (called by parent during active listening)

Private methods:
- `handleMouseEnter()`: if idle, start hover cue progress
- `handleMouseLeave()`: if hover-cue state, cancel and reset to idle
- `handleButtonClick()`: if idle or language-select, toggle listening (emit start). If listening, stop listening (emit stop). If error, reset to idle.
- `handleLanguageSelected(event: CustomEvent)`: update selectedLanguage, close popover, set state to idle, emit languageChange
- `handlePopoverClose()`: if state is language-select, transition back to idle

Render:
- Host with theme class
- Main `<button class="voice-button">` (44px circle) with:
  - `renderMicrophoneIcon()` as primary icon
  - Conditional CSS classes: `.listening` (red pulse), `.error` (shake), `.hover-cue` (progress visible), `.disabled`
  - `onMouseEnter`, `onMouseLeave`, `onClick` handlers
- Progress bar overlay: `<div class="progress-bar">` with width driven by `hoverProgress`% — visible only during hover-cue state (VOIC-02)
- Recording indicator: `<div class="recording-indicator">` — a small blinking red dot, visible only during listening state (VOIC-03)
- Mode indicator: `<div class="mode-indicator">` — shows `renderGlobeIcon(12)` if mode='browser' or `renderRobotIcon(12)` if mode='ai', positioned bottom-right of button (VOIC-06)
- Error message: `<div class="error-message">` — text below button, visible only during error state (VOIC-05)
- Language dropdown: `<sp-popover ref={...} placement="bottom-start" close-on-click close-on-escape>` containing `<sp-language-list>` with selectedLanguage, preferredLanguages, compact, theme — visible when state is language-select

**sp-voice-input-button.css** — DWC-themed styles:

Core button:
- `:host` — display: inline-block; position: relative
- `.voice-button` — width: 44px; height: 44px; border-radius: var(--dwc-border-radius-full); border: 2px solid var(--dwc-color-border); background: var(--dwc-color-surface); color: var(--dwc-color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; position: relative; overflow: visible; transition: all var(--dwc-transition-base)
- `.voice-button:hover` — border-color: var(--dwc-color-primary); background: var(--dwc-color-surface-secondary)
- `.voice-button:disabled` — opacity: 0.5; cursor: not-allowed

Listening state (VOIC-03):
- `.voice-button.listening` — border-color: var(--dwc-color-danger); background: rgba(220, 53, 69, 0.1); color: var(--dwc-color-danger); animation: sp-voice-pulse 1.5s ease-in-out infinite
- `@keyframes sp-voice-pulse` — 0% box-shadow: 0 0 0 0 rgba(220,53,69,0.4); 70% box-shadow: 0 0 0 10px rgba(220,53,69,0); 100% box-shadow: 0 0 0 0 rgba(220,53,69,0)

Error state (VOIC-05):
- `.voice-button.error` — border-color: var(--dwc-color-danger); animation: sp-voice-shake 0.5s ease-in-out
- `@keyframes sp-voice-shake` — 0%,100% translateX(0); 10%,30%,50%,70%,90% translateX(-4px); 20%,40%,60%,80% translateX(4px)

Progress bar (VOIC-02):
- `.progress-bar` — position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%); width: 36px; height: 3px; border-radius: 2px; background: var(--dwc-color-border); overflow: hidden; opacity: 0; transition: opacity var(--dwc-transition-fast)
- `.progress-bar.visible` — opacity: 1
- `.progress-fill` — height: 100%; background: var(--dwc-color-primary); border-radius: 2px; transition: width 50ms linear

Recording indicator:
- `.recording-indicator` — position: absolute; top: 2px; right: 2px; width: 8px; height: 8px; border-radius: 50%; background: var(--dwc-color-danger); animation: sp-voice-blink 1s ease-in-out infinite; display: none
- `.recording-indicator.visible` — display: block
- `@keyframes sp-voice-blink` — 0%,100% opacity: 1; 50% opacity: 0.3

Mode indicator (VOIC-06):
- `.mode-indicator` — position: absolute; bottom: -2px; right: -2px; width: 18px; height: 18px; border-radius: 50%; background: var(--dwc-color-surface); border: 1px solid var(--dwc-color-border); display: flex; align-items: center; justify-content: center; font-size: 0

Error message:
- `.error-message` — position: absolute; top: calc(100% + var(--dwc-spacing-xs)); left: 50%; transform: translateX(-50%); white-space: nowrap; font-size: var(--dwc-font-size-xs); color: var(--dwc-color-danger); font-family: var(--dwc-font-family); padding: var(--dwc-spacing-xs) var(--dwc-spacing-sm); background: var(--dwc-color-surface); border: 1px solid var(--dwc-color-danger); border-radius: var(--dwc-border-radius-sm); display: none
- `.error-message.visible` — display: block

Compact mode: `.compact .voice-button` — width: 36px; height: 36px
Theme overrides: :host(.theme-light) / :host(.theme-dark) with appropriate colors

**src/index.html** — Add demo section for voice input button after language selector section:
- "Voice Input Button" header
- `<sp-voice-input-button id="voiceDemo"></sp-voice-input-button>` (default browser mode)
- `<sp-voice-input-button id="voiceDemoAI" mode="ai"></sp-voice-input-button>` (AI mode)
- Event log div
- Script: listen to voiceStart, voiceStop, voiceError, transcriptionUpdate events and log them. Add buttons to simulate startListening, stopListening, setError for testing.
  </action>
  <verify>
Build passes: `npx stencil build` exits 0. Component appears in docs.json with all props, events, methods. Open dev server: button renders as 44px circle with microphone icon. Hovering shows progress bar filling over 2 seconds then language dropdown appears. Mode indicator shows globe (browser) or robot (AI) based on mode prop. Call startListening() via console to verify red pulse state. Call setError('Test') to verify shake animation and error message.
  </verify>
  <done>
sp-voice-input-button renders as a 44px circular microphone button. Hover triggers 2-second progress cue then language dropdown. Listening state shows red pulse + blinking indicator. Error state shows shake animation + message. Mode indicator shows globe or robot. All VOIC-01 through VOIC-06 requirements are met.
  </done>
</task>

</tasks>

<verification>
1. `npx stencil build` completes without errors
2. sp-voice-input-button appears in docs.json with correct props (mode, selectedLanguage, disabled, compact, theme, hoverCueDuration), events (voiceStart, voiceStop, voiceError, transcriptionUpdate, languageChange), and methods (startListening, stopListening, setError, emitTranscription)
3. Dev server shows 44px circular button with microphone icon and mode indicator
4. Hovering triggers progress bar animation → language dropdown opens after 2 seconds
5. Language selection in dropdown updates selectedLanguage and emits languageChange
6. startListening() transitions to red pulse state with blinking indicator
7. setError() triggers shake animation with error message display
8. Disabled state prevents all interaction
</verification>

<success_criteria>
- 44px circular button with microphone SVG icon (VOIC-01)
- Hover triggers 2-second progress bar cue then language dropdown (VOIC-02)
- Listening state: red button, pulse animation, blinking recording indicator (VOIC-03)
- All 5 events emitted correctly: start, stop, error, transcriptionUpdate, languageChange (VOIC-04)
- Error state: shake animation with error message display (VOIC-05)
- Mode indicator: globe (browser) or robot (AI) icon (VOIC-06)
</success_criteria>

<output>
After completion, create `.planning/phases/10-language-voice/10-02-SUMMARY.md`
</output>
