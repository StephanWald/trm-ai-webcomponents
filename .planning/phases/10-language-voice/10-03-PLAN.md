---
phase: 10-language-voice
plan: 03
type: execute
wave: 3
depends_on: [10-01, 10-02]
files_modified:
  - src/components/sp-language-selector/utils/languages.spec.ts
  - src/components/sp-language-list/sp-language-list.spec.ts
  - src/components/sp-language-selector/sp-language-selector.spec.ts
  - src/components/sp-voice-input-button/sp-voice-input-button.spec.ts
  - src/components/sp-language-selector/sp-language-selector.e2e.ts
  - src/components/sp-voice-input-button/sp-voice-input-button.e2e.ts
autonomous: true
requirements: [LANG-01, LANG-02, LANG-03, LANG-04, LANG-05, LANG-06, VOIC-01, VOIC-02, VOIC-03, VOIC-04, VOIC-05, VOIC-06]

must_haves:
  truths:
    - "Unit tests for language data utility verify browser language detection and language lookup"
    - "Spec tests for sp-language-list verify rendering, preferred section, selection, checkmark, and event emission"
    - "Spec tests for sp-language-selector verify button rendering, popover wiring, language change handling, and auto-hide timer"
    - "Spec tests for sp-voice-input-button verify all visual states, hover cue progress, animations, mode indicator, and event emission"
    - "E2E tests verify real browser interactions for language selection flow and voice button hover/click behavior"
    - "All tests pass and coverage meets 70% threshold"
  artifacts:
    - path: "src/components/sp-language-selector/utils/languages.spec.ts"
      provides: "Unit tests for LANGUAGES data, getBrowserPreferredLanguages, getLanguageByCode"
    - path: "src/components/sp-language-list/sp-language-list.spec.ts"
      provides: "Component spec tests for sp-language-list rendering, props, events"
    - path: "src/components/sp-language-selector/sp-language-selector.spec.ts"
      provides: "Component spec tests for sp-language-selector rendering, dropdown toggle, language change"
    - path: "src/components/sp-voice-input-button/sp-voice-input-button.spec.ts"
      provides: "Component spec tests for sp-voice-input-button states, animations, events, methods"
    - path: "src/components/sp-language-selector/sp-language-selector.e2e.ts"
      provides: "E2E tests for language selector browser interactions"
    - path: "src/components/sp-voice-input-button/sp-voice-input-button.e2e.ts"
      provides: "E2E tests for voice input button browser interactions"
  key_links:
    - from: "spec tests"
      to: "component implementations"
      via: "newSpecPage rendering and prop/event/method testing"
      pattern: "newSpecPage"
    - from: "e2e tests"
      to: "dev server"
      via: "Playwright page.goto('http://localhost:3333') with shadow DOM piercing"
      pattern: "page.goto"
---

<objective>
Write comprehensive spec and E2E tests for all Phase 10 components: sp-language-list, sp-language-selector, sp-voice-input-button, and the languages utility.

Purpose: Validate all LANG and VOIC requirements with automated tests, ensuring the 70% coverage threshold is met for the new components.

Output: 4 spec test files, 2 E2E test files, all passing with coverage meeting the global 70% threshold.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-language-voice/10-01-SUMMARY.md
@.planning/phases/10-language-voice/10-02-SUMMARY.md
@src/components/sp-popover/sp-popover.spec.ts
@src/components/sp-popover/sp-popover.e2e.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write unit tests for language utility and spec tests for sp-language-list and sp-language-selector</name>
  <files>
    src/components/sp-language-selector/utils/languages.spec.ts
    src/components/sp-language-list/sp-language-list.spec.ts
    src/components/sp-language-selector/sp-language-selector.spec.ts
  </files>
  <action>
**languages.spec.ts** — Unit tests for language data utility:

Test LANGUAGES array:
- Has at least 20 language entries
- Each entry has code, name, and nativeName strings
- All codes are 2-letter lowercase ISO 639-1
- No duplicate codes
- Contains known languages: en (English), es (Spanish/Espanol), fr (French/Francais), de (German/Deutsch), ja (Japanese)

Test getBrowserPreferredLanguages():
- Mock `navigator.languages` as ['en-US', 'fr-FR', 'de'] → returns ['en', 'fr', 'de']
- Mock `navigator.languages` as ['zh-CN', 'en'] → returns ['zh', 'en']
- Mock `navigator.languages` as [] with `navigator.language` = 'es' → returns ['es']
- Returns only codes that exist in LANGUAGES array
- Deduplicates (e.g., ['en-US', 'en-GB'] → ['en'])
- Handles missing navigator gracefully (returns [])

Test getLanguageByCode():
- Returns correct LanguageInfo for known code ('en' → English)
- Returns undefined for unknown code ('xx')
- Case sensitive ('EN' returns undefined if codes are lowercase)

**sp-language-list.spec.ts** — Component spec tests using `newSpecPage`:

Rendering tests:
- Renders a language list container with language items
- Renders all languages from the languages prop
- Default languages prop uses the full LANGUAGES array

Preferred section tests (LANG-02):
- When preferredLanguages=['en', 'fr'], renders a "Preferred" section header, then preferred items, then separator, then "All Languages" header, then remaining sorted alphabetically
- When preferredLanguages=[], renders only the alphabetical list without section headers
- Preferred items appear in the order specified by preferredLanguages array

Selection tests (LANG-03, LANG-04):
- Selected language item has `.selected` class
- Selected item renders visible check icon
- Non-selected items have hidden check icon (visibility: hidden via CSS, but check element present)
- Clicking a language item emits languageChange event with correct { code, name } detail

Interaction tests:
- Each language item is clickable (has cursor: pointer via CSS)
- Language items display nativeName and English name

Prop tests (LANG-06):
- Compact mode adds `.compact` class to container
- Theme prop sets host class (theme-light, theme-dark)

**sp-language-selector.spec.ts** — Component spec tests using `newSpecPage`:

Note: Since sp-language-selector renders child Stencil components (sp-popover, sp-language-list), use `components: [SpLanguageSelector]` only in newSpecPage (child components render as their tags). Test the selector component's own logic, not children.

Rendering tests (LANG-01):
- Renders a button with `.selector-button` class
- Button contains globe icon SVG, language code text span, and chevron icon SVG
- Language code text displays the selectedLanguage prop in uppercase
- Default selectedLanguage is 'en' → shows "EN"

Props tests:
- Changing selectedLanguage updates the displayed code text
- Disabled prop adds disabled attribute to button
- Compact mode adds `.compact` class
- Theme prop sets host class

State tests:
- isOpen state controls `.open` class on button and chevron rotation class
- Renders sp-popover element in shadow DOM
- Renders sp-language-list element inside the popover

Event handling:
- When a languageChange event bubbles from the language list, the component updates selectedLanguage and re-emits languageChange
- Test by dispatching a CustomEvent on the sp-language-list element

Auto-hide timer (LANG-05):
- Mouse leave starts a timer (use jest.spyOn on setTimeout)
- Mouse enter clears the timer (use jest.spyOn on clearTimeout)
- disconnectedCallback clears any active timer

Use the established Stencil spec testing patterns:
- jest.useFakeTimers() only inside individual tests AFTER newSpecPage (per Phase 05 decision)
- Test event emissions via jest.fn() spy on addEventListener
- Access rootInstance for private state verification where needed
  </action>
  <verify>
Run: `npx stencil test --spec -- --testPathPattern="(languages\\.spec|sp-language-list\\.spec|sp-language-selector\\.spec)"`. All tests pass. No test failures or TypeScript errors.
  </verify>
  <done>
Language utility unit tests verify data integrity, browser detection, and lookup. sp-language-list spec tests verify rendering, preferred sections, selection, checkmark, and events. sp-language-selector spec tests verify button rendering, dropdown wiring, language change handling, auto-hide, and prop reactivity. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write spec tests for sp-voice-input-button and E2E tests for all components</name>
  <files>
    src/components/sp-voice-input-button/sp-voice-input-button.spec.ts
    src/components/sp-language-selector/sp-language-selector.e2e.ts
    src/components/sp-voice-input-button/sp-voice-input-button.e2e.ts
  </files>
  <action>
**sp-voice-input-button.spec.ts** — Component spec tests using `newSpecPage`:

Install sync rAF shim at module level (same pattern as sp-popover.spec.ts — `global.requestAnimationFrame = (cb) => { cb(0); return 0; }`).

Rendering tests (VOIC-01):
- Renders a `.voice-button` element
- Button is 44px circle (has the voice-button class — CSS handles sizing)
- Contains microphone SVG icon
- Renders mode indicator with globe icon by default (mode='browser')
- Renders mode indicator with robot icon when mode='ai' (VOIC-06)

Props tests:
- Disabled prop adds disabled attribute to button
- Compact mode adds `.compact` class
- Theme prop sets host class
- Mode prop changes mode indicator icon

State machine tests:
- Default state is 'idle'
- Calling startListening() sets currentState to 'listening' and emits voiceStart event (VOIC-04)
- Calling stopListening() sets currentState to 'idle' and emits voiceStop event (VOIC-04)
- Calling setError('msg') sets currentState to 'error', sets errorMessage, and emits voiceError event (VOIC-04, VOIC-05)
- Calling emitTranscription('hello', false) emits transcriptionUpdate with correct detail (VOIC-04)

Hover cue tests (VOIC-02):
- Mouse enter on idle button starts hover progress
- Mouse leave during hover-cue resets progress to 0 and state to idle
- Use jest.useFakeTimers() inside test (after newSpecPage), then jest.advanceTimersByTime() to simulate the 2-second progress fill
- After hoverCueDuration, state transitions to language-select

Visual state tests (VOIC-03, VOIC-05):
- Listening state: button has `.listening` class (triggers pulse animation via CSS)
- Recording indicator div has `.visible` class during listening state
- Error state: button has `.error` class (triggers shake animation via CSS)
- Error message div has `.visible` class and contains the error text
- Error auto-clears after 3 seconds (use fake timers to advance 3000ms)

Event tests:
- voiceStart event detail includes { language, mode }
- voiceStop event detail includes { language, mode }
- voiceError event detail includes { message, language, mode }
- transcriptionUpdate event detail includes { text, isFinal, language, mode }
- languageChange event fires when language list selection bubbles up

Cleanup test:
- disconnectedCallback clears hoverTimer

**sp-language-selector.e2e.ts** — E2E tests using Playwright + @stencil/playwright:

Follow the same pattern as sp-popover.e2e.ts: `page.goto('http://localhost:3333')`, shadow DOM access via `page.evaluate()`.

Tests:
1. Renders language selector button with globe icon and language code text
2. Clicking button opens language dropdown (check sp-popover has .open class inside sp-language-selector shadow DOM)
3. Language list shows preferred section and alphabetical list
4. Clicking a language in the list updates the selector button text and closes the dropdown
5. languageChange event fires on selection (use page.evaluate to add event listener, then click)
6. Disabled selector does not open dropdown on click

**sp-voice-input-button.e2e.ts** — E2E tests using Playwright:

Tests:
1. Renders 44px circular button with microphone icon
2. Button shows mode indicator (globe for browser mode, robot for AI mode)
3. Hovering button shows progress bar that fills over 2 seconds (hover, wait 1s, verify progress bar visible; wait 2s more, verify language dropdown opens)
4. Calling startListening() via evaluate changes button appearance (listening class)
5. Calling setError('Test error') shows error message below button
6. Calling stopListening() returns button to idle state

Note for E2E tests: The index.html demo page must have the voice-input-button with an id="voiceDemo" for targeting. Use `page.evaluate()` to call methods on the component element, matching sp-popover E2E patterns.
  </action>
  <verify>
Run spec tests: `npx stencil test --spec -- --testPathPattern="sp-voice-input-button\\.spec"`. All pass.
Run E2E tests: `npx stencil test --e2e -- --testPathPattern="(sp-language-selector\\.e2e|sp-voice-input-button\\.e2e)"`. All pass.
Run full test suite with coverage: `npx stencil test --spec --coverage`. Verify global 70% threshold is met. New component files should have 70%+ coverage.
  </verify>
  <done>
sp-voice-input-button spec tests cover all visual states, hover cue progress, animations, mode indicator, event emissions, and cleanup. E2E tests verify real browser interactions for both language selector flow and voice button behavior. All tests pass and coverage meets the 70% global threshold.
  </done>
</task>

</tasks>

<verification>
1. `npx stencil test --spec` — all spec tests pass (language utility, sp-language-list, sp-language-selector, sp-voice-input-button)
2. `npx stencil test --e2e` — all E2E tests pass (language selector, voice input button)
3. `npx stencil test --spec --coverage` — global 70% threshold met across branches, functions, lines, statements
4. New component files (sp-language-list, sp-language-selector, sp-voice-input-button) each have 70%+ coverage
5. No test file touches files owned by other plans (spec/e2e files only)
</verification>

<success_criteria>
- Language utility unit tests verify data integrity and browser detection
- sp-language-list spec tests cover rendering, preferred sections, selection, events
- sp-language-selector spec tests cover button rendering, dropdown, language change, auto-hide
- sp-voice-input-button spec tests cover all 5 states, hover cue, animations, events, methods
- E2E tests cover real browser interactions for language selection and voice button flows
- Full test suite passes with 70% coverage threshold met
</success_criteria>

<output>
After completion, create `.planning/phases/10-language-voice/10-03-SUMMARY.md`
</output>
