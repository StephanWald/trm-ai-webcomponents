---
phase: 10-language-voice
plan: 02
subsystem: ui
tags: [stencil, web-components, voice-input, microphone, animations, dwc-tokens, svg-icons, state-machine]

# Dependency graph
requires:
  - phase: 10-language-voice plan 01
    provides: sp-language-list, sp-popover, LanguageChangeEventDetail, getBrowserPreferredLanguages, renderMicrophoneIcon, renderGlobeIcon
  - phase: 09-popover-utility
    provides: sp-popover Stencil component with showPopover/hidePopover methods
provides:
  - sp-voice-input-button Stencil web component (44px circular mic button)
  - VoiceInputMode and VoiceInputState types in types.ts
  - VoiceStartEventDetail, VoiceStopEventDetail, VoiceErrorEventDetail, TranscriptionUpdateEventDetail interfaces
  - renderRobotIcon() SVG helper in sp-language-selector/utils/icons.tsx
  - sp-voice-pulse, sp-voice-shake, sp-voice-blink CSS animations
affects:
  - Any future component needing a voice input trigger or mode indicator

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Hover-cue progress via setInterval at 50ms steps — increments hoverProgress from 0 to 100 over hoverCueDuration ms
    - State machine with 5 states (idle, hover-cue, language-select, listening, error) driving CSS class application
    - Public method API (startListening, stopListening, setError, emitTranscription) for parent-driven state transitions
    - CSS-only animations via @keyframes: sp-voice-pulse (box-shadow expand), sp-voice-shake (translateX oscillation), sp-voice-blink (opacity cycle)
    - Mode indicator badge (18px circle, bottom-right) with globe/robot SVG icon driven by mode prop

key-files:
  created:
    - src/components/sp-voice-input-button/types.ts
    - src/components/sp-voice-input-button/sp-voice-input-button.tsx
    - src/components/sp-voice-input-button/sp-voice-input-button.css
  modified:
    - src/components/sp-language-selector/utils/icons.tsx (renderRobotIcon added)
    - src/index.html (voice input button demo section with 4 variants + test buttons)
    - docs.json (auto-generated by Stencil build)
    - src/components.d.ts (auto-generated by Stencil build)

key-decisions:
  - "State machine drives all CSS class application — no imperative DOM manipulation; currentState is the single source of truth"
  - "Hover progress uses setInterval at 50ms steps (not requestAnimationFrame) for simplicity and consistent timing across hoverCueDuration values"
  - "popoverRef?.showPopover() called when hoverProgress reaches 100 — popover open/close events handled by handlePopoverClose to sync state"
  - "Error auto-clear uses setTimeout 3000ms; clearErrorTimer() called from disconnectedCallback to prevent state mutation after unmount"
  - "languageChange event name kept despite Stencil warning — consistent with sp-language-selector and sp-language-list patterns (informational only)"
  - "renderRobotIcon added to shared icons.tsx rather than inline in voice button — follows established pattern from Plan 01"

requirements-completed: [VOIC-01, VOIC-02, VOIC-03, VOIC-04, VOIC-05, VOIC-06]

# Metrics
duration: 3min
completed: 2026-02-22
---

# Phase 10 Plan 02: sp-voice-input-button Summary

**Circular 44px microphone button with hover-triggered language selection, red pulse listening state, shake error animation, blinking recording indicator, and globe/robot mode indicator badge — all driven by a 5-state machine using DWC tokens**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-22T06:33:36Z
- **Completed:** 2026-02-22T06:36:05Z
- **Tasks:** 2
- **Files modified:** 3 created + 2 modified + 2 auto-generated

## Accomplishments

- `types.ts`: 6 type/interface definitions (VoiceInputMode, VoiceInputState, VoiceStartEventDetail, VoiceStopEventDetail, VoiceErrorEventDetail, TranscriptionUpdateEventDetail)
- `renderRobotIcon()`: Tabler robot SVG (rounded-rect head, circular eyes, antenna) added to shared icons.tsx
- `sp-voice-input-button`: 6 props, 5 events, 4 public methods; shadow DOM with host-level theme/compact classes
- Hover cue: setInterval at 50ms steps filling progress bar over `hoverCueDuration` ms, then opens sp-popover with sp-language-list
- Listening: `sp-voice-pulse` box-shadow expand animation + blinking `recording-indicator` dot
- Error: `sp-voice-shake` translateX oscillation + positioned `error-message` div; auto-clears after 3 seconds
- Mode indicator: 18px badge at bottom-right showing renderGlobeIcon(12) or renderRobotIcon(12)
- All VOIC-01 through VOIC-06 requirements satisfied; build passes cleanly

## Task Commits

Each task was committed atomically:

1. **Task 1: Create voice input types and robot icon helper** - `96e8e8e` (feat)
2. **Task 2: Build sp-voice-input-button component with all visual states and animations** - `5bd8462` (feat)

## Files Created/Modified

- `src/components/sp-voice-input-button/types.ts` — VoiceInputMode, VoiceInputState, 4 event detail interfaces
- `src/components/sp-voice-input-button/sp-voice-input-button.tsx` — Full SpVoiceInputButton: 6 props, 5 events, 4 public methods, 5-state machine, popover wiring
- `src/components/sp-voice-input-button/sp-voice-input-button.css` — 44px circle, sp-voice-pulse, sp-voice-shake, sp-voice-blink animations, progress bar, recording indicator, mode indicator, compact mode, theme overrides
- `src/components/sp-language-selector/utils/icons.tsx` — renderRobotIcon() added (5 icon helpers total)
- `src/index.html` — Voice Input Button demo section with 4 variants (browser, AI, compact, disabled) and test buttons

## Decisions Made

- State machine (5 states) is the single source of truth — all CSS classes derive from `currentState`
- Hover progress uses setInterval at 50ms steps for simplicity over requestAnimationFrame
- popoverRef?.showPopover() triggered when hoverProgress reaches 100; handlePopoverClose syncs state back to idle
- Error auto-clear with 3-second setTimeout; cleared in disconnectedCallback to prevent post-unmount updates
- languageChange event name kept despite Stencil warning — consistent with established Plan 01 pattern

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

- Stencil warns that `languageChange` conflicts with a native DOM event name. Same informational warning as Plan 01 — build succeeds, event fires correctly.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- sp-voice-input-button ready for integration into chat interfaces and search bars
- All 6 VOIC requirements satisfied
- Component appears in docs.json with correct props, events, and methods
- Phase 10 complete — all language and voice components delivered

---
*Phase: 10-language-voice*
*Completed: 2026-02-22*

## Self-Check: PASSED

All 3 created files exist on disk. Both task commits (96e8e8e, 5bd8462) verified in git log.
