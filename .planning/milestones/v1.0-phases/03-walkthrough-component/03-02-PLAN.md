---
phase: 03-walkthrough-component
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/sp-walkthrough/sp-walkthrough.tsx
  - src/components/sp-walkthrough/sp-walkthrough.css
  - src/components/sp-walkthrough/utils/selector-generator.ts
  - src/index.html
autonomous: true

must_haves:
  truths:
    - "Author can toggle author mode on the walkthrough component"
    - "Author can activate pointer tool and click any DOM element to select it for highlighting"
    - "Author can create new scenes with title, description, timestamp, and highlight selector"
    - "Author can edit existing scenes (modify title, description, timestamp, highlight selector)"
    - "Author can delete scenes from the timeline"
    - "Component emits timeline-updated event with full timeline and change type on every author action"
    - "Pointer tool generates stable CSS selectors (ID > class > nth-child fallback)"
    - "Author mode UI is only visible when authorMode prop is true"
  artifacts:
    - path: "src/components/sp-walkthrough/utils/selector-generator.ts"
      provides: "CSS selector generation from DOM element with ID > class > nth-child strategy"
      exports: ["generateSelector"]
    - path: "src/components/sp-walkthrough/sp-walkthrough.tsx"
      provides: "Author mode state, pointer tool, scene CRUD, editor panel rendering"
      contains: "authorMode"
    - path: "src/components/sp-walkthrough/sp-walkthrough.css"
      provides: "Author mode UI styles (editor panel, pointer tool cursor, scene form)"
      contains: ".author-mode"
  key_links:
    - from: "sp-walkthrough.tsx"
      to: "utils/selector-generator.ts"
      via: "import { generateSelector }"
      pattern: "import.*selector-generator"
    - from: "sp-walkthrough.tsx"
      to: "timelineUpdated event"
      via: "this.timelineUpdated.emit()"
      pattern: "timelineUpdated\\.emit"
---

<objective>
Add author mode to the sp-walkthrough component, enabling real-time editing of walkthrough content including scene creation/editing/deletion, pointer tool for DOM element selection, and event-based persistence.

Purpose: Implements WALK-07, WALK-08, and WALK-09 — the authoring capabilities that allow walkthrough creators to visually build and modify scene timelines. This completes all 15 WALK requirements.

Output: Complete sp-walkthrough component with author mode, ready for comprehensive testing in Plan 03.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-walkthrough-component/03-RESEARCH.md
@.planning/phases/03-walkthrough-component/03-01-SUMMARY.md
@src/components/sp-walkthrough/sp-walkthrough.tsx
@src/components/sp-walkthrough/sp-walkthrough.css
@src/components/sp-walkthrough/types/walkthrough.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create selector generator utility and add author mode state/logic to component</name>
  <files>
    src/components/sp-walkthrough/utils/selector-generator.ts
    src/components/sp-walkthrough/sp-walkthrough.tsx
  </files>
  <action>
    Create the CSS selector generator utility and wire author mode logic into the existing component.

    **Selector Generator (selector-generator.ts):**
    Pure function `generateSelector(element: HTMLElement): string` that creates a CSS selector for a DOM element, preferring stability:

    1. **ID selector (most stable):** If element.id exists and is non-empty, return `#${CSS.escape(element.id)}`. Validate uniqueness with document.querySelectorAll — if not unique (unlikely but possible), fall through.
    2. **Data attribute:** If element has `data-walkthrough-id` attribute, return `[data-walkthrough-id="${element.dataset.walkthroughId}"]`.
    3. **Class selector (if unique):** If element.className is non-empty, build selector from all classes: `.${classes.join('.')}`. Test with document.querySelectorAll — if exactly 1 match, return it.
    4. **Tag + class combination:** Try `tagName.className` selector. Test uniqueness.
    5. **Nth-child path (fallback):** Build path from element up to body: `tag:nth-child(N)` at each level joined with ` > `. This is fragile but always unique.

    Also export `validateSelector(selector: string): { valid: boolean; matchCount: number }` — test selector with querySelectorAll, return match count. Used by author mode to warn about non-unique selectors.

    **Component modifications (sp-walkthrough.tsx):**

    Add new state properties for author mode:
    - `@State() pointerToolActive: boolean = false` — Pointer tool is active (crosshair cursor)
    - `@State() editingScene: Scene | null = null` — Scene currently being edited (null = creating new)
    - `@State() showSceneEditor: boolean = false` — Scene editor form visible
    - `@State() selectorPreview: string = ''` — CSS selector preview during pointer tool use

    Add new private members:
    - `pointerToolClickHandler: (ev: MouseEvent) => void` — Global click handler for pointer tool
    - `pointerToolMoveHandler: (ev: MouseEvent) => void` — Global mousemove handler for hover preview
    - `pointerToolAbortController: AbortController | null` — For cleanup of pointer tool listeners

    **Pointer tool logic (WALK-08):**
    - `activatePointerTool()`: Set pointerToolActive=true, create new AbortController. Add document-level click handler (capture: true, signal from controller) that:
      1. Prevents default and stops propagation
      2. Ignores clicks on sp-walkthrough elements (target.closest('sp-walkthrough'))
      3. Generates selector via generateSelector(target)
      4. Validates selector via validateSelector
      5. Sets selectorPreview to generated selector
      6. If showSceneEditor is true and editingScene exists, update editingScene.highlightSelector
      7. Calls overlayManager.highlightElement(selector) for visual preview
      8. Deactivates pointer tool
    - Add mousemove handler that shows hover outline on potential targets (add/remove a temporary CSS class on hovered elements, skip sp-walkthrough elements)
    - `deactivatePointerTool()`: Set pointerToolActive=false, abort controller, remove hover outlines

    **Scene CRUD logic (WALK-07):**
    - `createScene()`: Open scene editor with empty Scene template (generate UUID for id, set timestamp to current video time or 0). Set editingScene to new template, showSceneEditor=true.
    - `editScene(sceneIndex: number)`: Load scene into editor. Set editingScene to clone of scenes[sceneIndex], showSceneEditor=true.
    - `deleteScene(sceneIndex: number)`: Remove scene from scenes array (create new array without that scene). Update timelineEngine. Emit timelineUpdated with changeType 'delete'. If currentSceneIndex was the deleted scene, adjust.
    - `saveScene()`: If editingScene is new (not in scenes array), add to scenes array sorted by timestamp. If existing, replace at original index. Update timelineEngine. Emit timelineUpdated with changeType 'create' or 'update'. Close editor.
    - `cancelEdit()`: Clear editingScene, close editor, deactivate pointer tool if active, clear overlay preview.

    **Event emission (WALK-09):**
    - Every scene CRUD operation emits `timelineUpdated` event with:
      - `scenes`: Full updated scenes array (for parent to persist)
      - `changeType`: 'create' | 'update' | 'delete'
      - `affectedSceneId`: ID of the created/updated/deleted scene

    **UUID generation for scene IDs:**
    Use `crypto.randomUUID()` if available, otherwise fall back to simple random string: `'scene-' + Math.random().toString(36).substring(2, 11)`.

    **Update disconnectedCallback:**
    Add pointer tool cleanup (abort controller, remove hover classes).

    **Update render method:**
    Add author mode toolbar and scene editor conditionally rendered when authorMode prop is true:
    - Author toolbar (below controls bar): "Add Scene" button, "Pointer Tool" toggle button
    - Scene list in author mode: Each scene shows edit/delete buttons alongside title
    - Scene editor panel (overlay within walkthrough panel): Form with fields for title (text input), description (textarea), timestamp (number input, step=0.1), highlightSelector (text input + "Pick Element" button that activates pointer tool). Save and Cancel buttons.
    - Pointer tool indicator: When active, show "Click an element to select it" message in the panel
  </action>
  <verify>
    Run `npx tsc --noEmit` — no TypeScript compilation errors.
    Run `npm run build` — build succeeds.
    Verify generateSelector produces ID selectors for elements with IDs.
    Verify validateSelector returns correct match counts.
  </verify>
  <done>
    generateSelector creates stable CSS selectors with ID > data-attr > class > nth-child priority.
    validateSelector checks selector uniqueness.
    Pointer tool activates crosshair cursor and captures DOM element clicks outside walkthrough.
    Scene editor form allows creating new scenes with title/description/timestamp/selector.
    Existing scenes can be edited (load into form) and deleted (remove from array).
    Every CRUD operation emits timelineUpdated event with full timeline for parent persistence.
    Author mode UI only renders when authorMode prop is true.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add author mode CSS styles and update demo</name>
  <files>
    src/components/sp-walkthrough/sp-walkthrough.css
    src/index.html
  </files>
  <action>
    Add CSS styles for author mode UI elements and update the demo page to showcase author mode.

    **CSS additions (sp-walkthrough.css):**

    - `.author-toolbar` — padding 8px 12px, display flex, gap 8px, border-top 1px solid var(--dwc-color-border), background var(--dwc-color-surface-alt, #f8f9fa)
    - `.author-toolbar button` — padding 4px 10px, border 1px solid var(--dwc-color-border), border-radius var(--dwc-border-radius, 4px), background var(--dwc-color-surface), cursor pointer, font-size var(--dwc-font-size-sm), font-family var(--dwc-font-family), color var(--dwc-color-text)
    - `.author-toolbar button:hover` — border-color var(--dwc-color-primary), background var(--dwc-color-surface-alt)
    - `.author-toolbar button.active` — background var(--dwc-color-primary), color white, border-color var(--dwc-color-primary)
    - `.pointer-tool-indicator` — padding 8px 12px, background var(--dwc-color-warning, #f59e0b)1a (10% opacity), border 1px solid var(--dwc-color-warning, #f59e0b), border-radius var(--dwc-border-radius, 4px), margin 8px 12px, font-size var(--dwc-font-size-sm), color var(--dwc-color-text), text-align center
    - `.scene-list` — padding 8px 12px, max-height 200px, overflow-y auto, display flex, flex-direction column, gap 4px
    - `.scene-list-item` — display flex, align-items center, gap 8px, padding 6px 8px, border-radius var(--dwc-border-radius, 4px), background var(--dwc-color-surface), border 1px solid var(--dwc-color-border), font-size var(--dwc-font-size-sm)
    - `.scene-list-item.active` — border-color var(--dwc-color-primary), background var(--dwc-color-primary)0d (5% opacity)
    - `.scene-list-item .scene-title` — flex 1, overflow hidden, text-overflow ellipsis, white-space nowrap
    - `.scene-list-item .scene-timestamp` — color var(--dwc-color-text-secondary), font-size var(--dwc-font-size-xs), font-variant-numeric tabular-nums
    - `.scene-list-item .scene-actions` — display flex, gap 2px
    - `.scene-list-item .scene-actions button` — background none, border none, cursor pointer, padding 2px 4px, font-size 12px, color var(--dwc-color-text-secondary), border-radius 2px
    - `.scene-list-item .scene-actions button:hover` — color var(--dwc-color-text), background var(--dwc-color-surface-alt)
    - `.scene-list-item .scene-actions button.delete-btn:hover` — color var(--dwc-color-danger, #ef4444)
    - `.scene-editor` — padding 12px, border-top 1px solid var(--dwc-color-border), background var(--dwc-color-surface)
    - `.scene-editor .form-group` — margin-bottom 8px
    - `.scene-editor label` — display block, font-size var(--dwc-font-size-xs), color var(--dwc-color-text-secondary), margin-bottom 2px, font-weight var(--dwc-font-weight-semibold)
    - `.scene-editor input, .scene-editor textarea` — width 100%, padding 6px 8px, border 1px solid var(--dwc-color-border), border-radius var(--dwc-border-radius, 4px), font-size var(--dwc-font-size-sm), font-family var(--dwc-font-family), background var(--dwc-color-surface), color var(--dwc-color-text), box-sizing border-box
    - `.scene-editor input:focus, .scene-editor textarea:focus` — outline none, border-color var(--dwc-color-primary), box-shadow 0 0 0 2px var(--dwc-color-primary)33
    - `.scene-editor textarea` — resize vertical, min-height 50px
    - `.scene-editor .selector-row` — display flex, gap 4px, align-items center
    - `.scene-editor .selector-row input` — flex 1
    - `.scene-editor .selector-row button` — white-space nowrap, padding 6px 10px, border 1px solid var(--dwc-color-border), border-radius var(--dwc-border-radius, 4px), background var(--dwc-color-surface), cursor pointer, font-size var(--dwc-font-size-sm), color var(--dwc-color-text)
    - `.scene-editor .selector-row button:hover` — border-color var(--dwc-color-primary)
    - `.scene-editor .selector-validation` — font-size var(--dwc-font-size-xs), margin-top 2px
    - `.scene-editor .selector-validation.valid` — color var(--dwc-color-success, #22c55e)
    - `.scene-editor .selector-validation.invalid` — color var(--dwc-color-danger, #ef4444)
    - `.scene-editor .editor-actions` — display flex, gap 8px, justify-content flex-end, margin-top 12px
    - `.scene-editor .editor-actions button` — padding 6px 16px, border-radius var(--dwc-border-radius, 4px), cursor pointer, font-size var(--dwc-font-size-sm), font-family var(--dwc-font-family)
    - `.scene-editor .btn-save` — background var(--dwc-color-primary, #0066cc), color white, border 1px solid var(--dwc-color-primary, #0066cc)
    - `.scene-editor .btn-save:hover` — filter brightness(1.1)
    - `.scene-editor .btn-cancel` — background var(--dwc-color-surface), color var(--dwc-color-text), border 1px solid var(--dwc-color-border)
    - `.scene-editor .btn-cancel:hover` — background var(--dwc-color-surface-alt)

    Global hover style for pointer tool (injected as style tag to document.head when active):
    - The pointer tool should add a temporary `<style>` element to document.head with: `*:not(sp-walkthrough):not(sp-walkthrough *) { cursor: crosshair !important; }` and `*.sp-walkthrough-hover-outline { outline: 2px dashed var(--dwc-color-primary, #0066cc) !important; outline-offset: 2px !important; }`. Remove this style element when pointer tool deactivated.

    **Demo update (src/index.html):**
    Update the walkthrough demo section:
    - Add a toggle button for author mode: "Toggle Author Mode" that sets walkthroughEl.authorMode = !walkthroughEl.authorMode
    - Add event listener for 'timeline-updated' event that logs the updated timeline to console and displays it in a pre/code block below the walkthrough for visibility
    - Add some target elements on the page with IDs (e.g., `<div id="target-1">Target Element 1</div>`) that can be selected with the pointer tool during author mode demo
  </action>
  <verify>
    Run `npm run build` — build succeeds without errors.
    Run `npm start` and verify:
    1. Author mode toolbar appears when authorMode=true
    2. "Add Scene" opens editor form
    3. Pointer tool activates crosshair cursor and selects elements
    4. Scene list shows edit/delete buttons per scene
    5. timeline-updated event fires on create/edit/delete
    6. Author mode hidden when authorMode=false
    7. No console errors
  </verify>
  <done>
    Author mode CSS styles match DWC theming (form inputs, buttons, scene list, editor panel).
    Pointer tool shows crosshair cursor and hover outlines on potential targets.
    Scene editor form is properly styled with input fields, validation indicators, and action buttons.
    Scene list displays with edit/delete actions per item.
    Demo page showcases author mode with timeline-updated event logging.
    WALK-07, WALK-08, WALK-09 fully implemented. All 15 WALK requirements complete.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Author mode toolbar/editor only visible when authorMode=true
3. Pointer tool selects DOM elements and generates CSS selectors
4. Scene CRUD (create, edit, delete) works through editor form
5. timeline-updated event emits with correct detail on each operation
6. Generated selectors are stable (prefer ID > class > nth-child)
7. Selector validation shows match count warning for non-unique selectors
8. All DWC tokens consumed in author mode styles
</verification>

<success_criteria>
- Requirements WALK-07, WALK-08, WALK-09 implemented (author mode complete)
- All 15 WALK requirements now satisfied (combined with Plan 01)
- Author mode UI follows DWC theming patterns
- Pointer tool provides familiar DevTools-like element selection
- Event-based persistence allows parent app to save timeline
- Component is ready for comprehensive test suite (Plan 03)
</success_criteria>

<output>
After completion, create `.planning/phases/03-walkthrough-component/03-02-SUMMARY.md`
</output>
