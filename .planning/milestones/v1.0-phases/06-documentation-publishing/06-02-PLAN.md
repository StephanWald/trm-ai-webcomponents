---
phase: 06-documentation-publishing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/release.yml
  - .github/workflows/docs-deploy.yml
autonomous: true
requirements:
  - INFRA-07
  - DOCS-01

must_haves:
  truths:
    - "Release workflow publishes to npm with provenance when changesets action runs"
    - "Docs deployment workflow builds Stencil then Docusaurus and deploys to GitHub Pages on push to master"
  artifacts:
    - path: ".github/workflows/release.yml"
      provides: "Updated release workflow with npm provenance"
      contains: "NPM_CONFIG_PROVENANCE"
    - path: ".github/workflows/docs-deploy.yml"
      provides: "GitHub Pages deployment workflow for Docusaurus site"
      contains: "deploy-pages"
  key_links:
    - from: ".github/workflows/release.yml"
      to: "npm registry"
      via: "changesets/action with provenance"
      pattern: "NPM_CONFIG_PROVENANCE"
    - from: ".github/workflows/docs-deploy.yml"
      to: "GitHub Pages"
      via: "actions/deploy-pages@v4"
      pattern: "deploy-pages"
---

<objective>
Update the release workflow for npm provenance publishing and create a new GitHub Actions workflow for deploying the Docusaurus documentation site to GitHub Pages.

Purpose: INFRA-07 requires automated npm publishing with provenance on release. DOCS-01 requires the docs site to deploy to GitHub Pages automatically. These are independent CI/CD infrastructure tasks that can run in parallel with docs-json annotation work.

Output: Updated release.yml with provenance support; new docs-deploy.yml for GitHub Pages deployment.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-documentation-publishing/06-RESEARCH.md
@.github/workflows/release.yml
@.github/workflows/ci.yml
@.changeset/config.json
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update release.yml for npm provenance</name>
  <files>.github/workflows/release.yml</files>
  <action>
    Update the existing release.yml to add npm provenance support:

    1. Add `NPM_CONFIG_PROVENANCE: 'true'` to the env block of the "Create Release Pull Request or Publish" step (the changesets/action step). This goes alongside the existing GITHUB_TOKEN and NODE_AUTH_TOKEN env vars.

    2. Verify the existing workflow already has `id-token: write` in the permissions block (it does â€” confirmed in research). This is required for OIDC-based provenance attestation.

    3. Add `createGithubReleases: true` to the changesets/action `with` block if not already present. This enables automatic GitHub Release creation when publishing.

    Do NOT change:
    - The trigger (push to master)
    - The build/test steps
    - The node version (24.x)
    - The existing changesets/action configuration (publish, version, title, commit)
  </action>
  <verify>
    Validate YAML syntax: `node -e "require('fs').readFileSync('.github/workflows/release.yml', 'utf8')" && echo "YAML readable"`
    Verify NPM_CONFIG_PROVENANCE is present: `grep -c "NPM_CONFIG_PROVENANCE" .github/workflows/release.yml` returns 1
    Verify id-token permission is present: `grep -c "id-token" .github/workflows/release.yml` returns 1
  </verify>
  <done>
    release.yml has NPM_CONFIG_PROVENANCE: 'true' in the changesets action env block; id-token: write permission is confirmed; workflow structure is otherwise unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create docs-deploy.yml for GitHub Pages deployment</name>
  <files>.github/workflows/docs-deploy.yml</files>
  <action>
    Create a new GitHub Actions workflow file at `.github/workflows/docs-deploy.yml` for deploying the Docusaurus documentation site to GitHub Pages.

    Workflow specification:
    - **Name:** "Deploy Docs to GitHub Pages"
    - **Trigger:** push to master branch + workflow_dispatch (manual trigger)
    - **Permissions:** contents: read, pages: write, id-token: write
    - **Concurrency:** group "pages", cancel-in-progress: false (don't cancel running deployments)

    **Build job:**
    1. Checkout with fetch-depth: 0
    2. Setup Node.js 20 with npm cache
    3. `npm ci` (install root Stencil dependencies)
    4. `npm run build` (builds Stencil components AND generates docs.json)
    5. `cd docs && npm ci` (install Docusaurus dependencies)
    6. `cd docs && npm run build` (build Docusaurus static site)
    7. Upload `docs/build` directory using `actions/upload-pages-artifact@v3`

    **Deploy job:**
    1. Depends on build job (`needs: build`)
    2. Uses `actions/deploy-pages@v4` to deploy to GitHub Pages
    3. Sets environment name "github-pages" with output URL

    Use `working-directory: docs` for the Docusaurus steps instead of `cd docs &&` prefix where possible.

    Note: This workflow will not run successfully until the Docusaurus site is scaffolded (Plan 03), but the workflow file itself should be correct and ready.
  </action>
  <verify>
    Validate YAML syntax: `node -e "const y = require('fs').readFileSync('.github/workflows/docs-deploy.yml', 'utf8'); console.log('Valid file,', y.length, 'bytes')" && echo "OK"`
    Verify key elements are present:
    - `grep -c "deploy-pages" .github/workflows/docs-deploy.yml` returns at least 1
    - `grep -c "upload-pages-artifact" .github/workflows/docs-deploy.yml` returns at least 1
    - `grep -c "npm run build" .github/workflows/docs-deploy.yml` returns at least 2 (Stencil + Docusaurus)
  </verify>
  <done>
    docs-deploy.yml exists with correct build-then-deploy pipeline; builds Stencil first (for docs.json) then Docusaurus; deploys to GitHub Pages via native actions/deploy-pages@v4.
  </done>
</task>

</tasks>

<verification>
1. `.github/workflows/release.yml` has NPM_CONFIG_PROVENANCE in changesets action env
2. `.github/workflows/docs-deploy.yml` exists with build and deploy jobs
3. Both YAML files are syntactically valid
4. docs-deploy.yml runs Stencil build before Docusaurus build (correct ordering)
5. No changes to existing CI workflow (ci.yml)
</verification>

<success_criteria>
- release.yml updated with provenance support (INFRA-07)
- docs-deploy.yml created for GitHub Pages deployment (DOCS-01 infrastructure)
- Both workflows use correct GitHub Actions versions (v4 for checkout/deploy-pages, v3 for upload-pages-artifact)
- Workflow ordering ensures docs.json exists before Docusaurus build
</success_criteria>

<output>
After completion, create `.planning/phases/06-documentation-publishing/06-02-SUMMARY.md`
</output>
