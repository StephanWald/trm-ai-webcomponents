---
phase: 05-testing-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - stencil.config.ts
  - .github/workflows/ci.yml
  - src/components/sp-org-chart/sp-org-chart.spec.ts
autonomous: true

must_haves:
  truths:
    - "Running npm test -- --coverage enforces 70% minimum across lines, branches, functions, statements"
    - "CI workflow runs tests with --coverage flag so builds fail below threshold"
    - "sp-org-chart has sufficient spec test coverage for uncovered interaction handlers, drag-and-drop, long-press, and filter logic"
    - "sp-org-chart renders with readable defaults when DWC theme is not loaded"
  artifacts:
    - path: "stencil.config.ts"
      provides: "Coverage threshold configuration"
      contains: "coverageThreshold"
    - path: ".github/workflows/ci.yml"
      provides: "CI coverage enforcement"
      contains: "--coverage"
    - path: "src/components/sp-org-chart/sp-org-chart.spec.ts"
      provides: "Expanded org-chart tests covering interaction handlers and fallback rendering"
  key_links:
    - from: "stencil.config.ts"
      to: "npm test -- --coverage"
      via: "testing.coverageThreshold config"
      pattern: "coverageThreshold.*global.*branches.*70"
    - from: ".github/workflows/ci.yml"
      to: "stencil.config.ts"
      via: "npm test -- --coverage triggers threshold check"
      pattern: "npm test.*--coverage"
---

<objective>
Configure Jest coverage thresholds in stencil.config.ts to enforce 70% minimum across all metrics, update CI to run with --coverage flag, and add targeted spec tests for sp-org-chart to close coverage gaps and validate fallback rendering.

Purpose: Establish the coverage enforcement infrastructure and bring sp-org-chart from 39.7% to 70%+ statement coverage. The stencil.config.ts threshold config combined with CI --coverage flag ensures builds fail below 70%.
Output: Updated stencil.config.ts with coverage config, updated ci.yml, expanded sp-org-chart.spec.ts with interaction and fallback tests.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-testing-quality/05-RESEARCH.md
@stencil.config.ts
@.github/workflows/ci.yml
@src/components/sp-org-chart/sp-org-chart.tsx
@src/components/sp-org-chart/sp-org-chart.spec.ts
@src/components/sp-org-chart/sp-org-chart.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure coverage thresholds in stencil.config.ts and update CI workflow</name>
  <files>stencil.config.ts, .github/workflows/ci.yml</files>
  <action>
  Update stencil.config.ts to add a `testing` property with Jest coverage configuration:

  1. Add `testing` object to the Config export with:
     - `collectCoverageFrom`: ['src/**/*.{ts,tsx}', '!src/**/*.d.ts', '!src/**/*.e2e.ts', '!src/components.d.ts']
     - `coverageDirectory`: 'coverage'
     - `coverageReporters`: ['text', 'lcov', 'json-summary']
     - `coveragePathIgnorePatterns`: ['/node_modules/', '\\.e2e\\.ts$', '/dist/', '/www/', 'components\\.d\\.ts$']
     - `coverageThreshold`: { global: { branches: 70, functions: 70, lines: 70, statements: 70 } }

  2. Update `.github/workflows/ci.yml`:
     - Change `npm test` to `npm test -- --coverage` so Jest enforces the coverage threshold configured in stencil.config.ts
     - This is the ONLY change needed in CI -- Jest exits non-zero when thresholds fail, which automatically fails the build step

  IMPORTANT: Configure in stencil.config.ts under `testing` property, NOT in a separate jest.config.js (Stencil ignores jest.config.js when using `stencil test`).
  </action>
  <verify>
  Run `npx stencil test --spec --coverage 2>&1 | tail -5` and verify the coverage threshold configuration is recognized (you will see threshold failure messages since we haven't added all gap tests yet -- that's expected at this point). The important thing is the threshold IS configured and being checked.
  </verify>
  <done>stencil.config.ts contains testing.coverageThreshold with 70% global minimum across all 4 metrics. CI workflow runs `npm test -- --coverage`.</done>
</task>

<task type="auto">
  <name>Task 2: Add sp-org-chart coverage gap tests and fallback rendering tests</name>
  <files>src/components/sp-org-chart/sp-org-chart.spec.ts</files>
  <action>
  Add targeted spec tests to sp-org-chart.spec.ts to cover uncovered lines. The current coverage is 39.7% statements. Key uncovered areas (from coverage report lines):

  **Interaction handlers to test (lines 96-101, 118, 142-166, 177-179, 198-200, 206-253, 257-296, 302-344, 351-354, 367-370, 412-419, 450-463):**

  1. **Filter input handling** - Test filterText state updates when typing in filter input. Simulate input event on `.filter-input` element.

  2. **User selection (single click)** - Test that clicking a `.user-tile` sets selectedUserId state and emits `user-selected` event.

  3. **User double-click** - Test that double-clicking a `.user-tile` emits `user-action` event with user detail.

  4. **Long-press delete flow** - Test the long-press timer: simulate pointerdown on a tile with editable=true, verify `longPressUserId` state is set, then simulate pointerup before 4s to cancel. Also test successful long-press that triggers deletion event.

  5. **Drag-and-drop** - With editable=true, test dragstart on a user tile sets `draggedUserId`, dragover on another tile shows drop zone, drop triggers `hierarchy-change` event with updated reportsTo.

  6. **Tree rendering with multiple levels** - Test 3+ level deep tree renders correct parent-child relationships with connector lines.

  7. **Watch handler for users prop** - Test that changing users prop rebuilds the tree.

  8. **Highlighted user** - Test that setting highlightedUserId via method adds highlight CSS class.

  **Fallback rendering tests (new describe block):**

  9. Add `describe('fallback rendering without DWC theme', () => { ... })` block that verifies:
     - Component renders without errors when no DWC tokens are loaded
     - User tiles are present and contain text content
     - Filter input is visible and functional
     - No-data message renders when users is empty
     - The component structure is intact (tree-container exists with children when data provided)

  Target: Bring sp-org-chart.tsx from ~39.7% to 70%+ statement coverage. Focus on testing the PUBLIC behavior through the component's rendered output and events, not internal implementation details.

  Mock any browser APIs as needed (PointerEvent for long-press, DragEvent for drag-and-drop). Use `page.rootInstance` to access component methods and `page.root.shadowRoot.querySelector` to inspect rendered DOM.
  </action>
  <verify>
  Run `npx stencil test --spec src/components/sp-org-chart/sp-org-chart.spec.ts -- --coverage 2>&1 | grep "sp-org-chart.tsx"` and verify statement coverage is at or above 70%.
  </verify>
  <done>sp-org-chart.spec.ts contains tests for interaction handlers (click, double-click, long-press, drag-and-drop, filter), tree rendering, and fallback rendering. sp-org-chart.tsx statement coverage >= 70%.</done>
</task>

</tasks>

<verification>
1. `npx stencil test --spec -- --coverage 2>&1 | grep "coverageThreshold"` shows threshold config is active
2. sp-org-chart.tsx coverage >= 70% across all metrics
3. All existing 335+ tests still pass (no regressions)
4. `.github/workflows/ci.yml` contains `npm test -- --coverage`
</verification>

<success_criteria>
- stencil.config.ts has testing.coverageThreshold enforcing 70% global minimum
- CI workflow uses --coverage flag
- sp-org-chart.tsx statement coverage >= 70%
- sp-org-chart fallback rendering tests verify component renders without DWC theme
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-testing-quality/05-01-SUMMARY.md`
</output>
