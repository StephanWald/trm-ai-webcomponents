---
phase: 05-testing-quality
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/sp-walkthrough/sp-walkthrough.spec.ts
  - src/components/sp-walkthrough/utils/draggable-mixin.spec.ts
  - src/components/sp-walkthrough/utils/youtube-wrapper.spec.ts
  - src/components/sp-walkthrough/utils/overlay-manager.spec.ts
autonomous: true

must_haves:
  truths:
    - "sp-walkthrough has sufficient spec test coverage for uncovered lifecycle methods, navigation, author mode, and video control logic"
    - "draggable-mixin.ts has spec tests covering pointer event drag flow"
    - "youtube-wrapper.ts has spec tests covering YouTubePlayerWrapper methods with mocked YT API"
    - "sp-walkthrough renders with readable defaults when DWC theme is not loaded"
  artifacts:
    - path: "src/components/sp-walkthrough/sp-walkthrough.spec.ts"
      provides: "Expanded walkthrough tests covering navigation, author mode, and fallback rendering"
    - path: "src/components/sp-walkthrough/utils/draggable-mixin.spec.ts"
      provides: "Tests for makeDraggable function"
    - path: "src/components/sp-walkthrough/utils/youtube-wrapper.spec.ts"
      provides: "Expanded YouTube wrapper tests with mocked YT API"
  key_links:
    - from: "src/components/sp-walkthrough/sp-walkthrough.spec.ts"
      to: "src/components/sp-walkthrough/sp-walkthrough.tsx"
      via: "newSpecPage component testing"
      pattern: "newSpecPage.*SpWalkthrough"
    - from: "src/components/sp-walkthrough/utils/youtube-wrapper.spec.ts"
      to: "src/components/sp-walkthrough/utils/youtube-wrapper.ts"
      via: "mocked YT.Player testing"
      pattern: "YouTubePlayerWrapper"
---

<objective>
Add targeted spec tests for sp-walkthrough, draggable-mixin, youtube-wrapper, and overlay-manager to close coverage gaps and validate fallback rendering without DWC theme.

Purpose: Bring sp-walkthrough.tsx from 40.95% to 70%+ and its utilities (draggable-mixin at 2.08%, youtube-wrapper at 14.58%) to 70%+ statement coverage.
Output: Expanded spec test files with comprehensive tests covering uncovered branches and interaction handlers.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-testing-quality/05-RESEARCH.md
@src/components/sp-walkthrough/sp-walkthrough.tsx
@src/components/sp-walkthrough/sp-walkthrough.spec.ts
@src/components/sp-walkthrough/sp-walkthrough.css
@src/components/sp-walkthrough/utils/draggable-mixin.ts
@src/components/sp-walkthrough/utils/youtube-wrapper.ts
@src/components/sp-walkthrough/utils/overlay-manager.ts
@src/components/sp-walkthrough/utils/overlay-manager.spec.ts
@src/components/sp-walkthrough/utils/youtube-wrapper.spec.ts
@src/components/sp-walkthrough/utils/draggable-mixin.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add draggable-mixin and youtube-wrapper coverage tests</name>
  <files>src/components/sp-walkthrough/utils/draggable-mixin.spec.ts, src/components/sp-walkthrough/utils/youtube-wrapper.spec.ts, src/components/sp-walkthrough/utils/overlay-manager.spec.ts</files>
  <action>
  **draggable-mixin.spec.ts** (currently 2.08% - nearly untested):
  Create or expand the spec file to test the `makeDraggable` function:

  1. Test basic setup: calling makeDraggable returns a cleanup function and sets cursor to 'grab' on handle element.
  2. Test pointer down: simulate pointerdown event, verify document.body cursor changes to 'grabbing'. Mock `setPointerCapture` on the handle element.
  3. Test drag movement: simulate pointerdown then pointermove, verify element.style.left and element.style.top are updated. Mock `getBoundingClientRect` on the element to return initial position.
  4. Test viewport constraint: simulate drag that would move element outside viewport bounds (negative coordinates or beyond window.innerWidth/Height), verify clamping to 0 and max bounds.
  5. Test pointer up: simulate pointerdown then pointerup, verify isDragging resets (body cursor cleared). Mock `releasePointerCapture`.
  6. Test cleanup: call the returned cleanup function, verify abort controller cancels listeners and cursors are reset.
  7. Test handle selector fallback: when handleSelector doesn't match any child element, the element itself becomes the handle.

  Mock PointerEvent with clientX/clientY. Mock element.getBoundingClientRect, setPointerCapture, releasePointerCapture. Set window.innerWidth/innerHeight for viewport tests.

  **youtube-wrapper.spec.ts** (currently 14.58% - mostly untested):
  Expand the existing spec file to test YouTubePlayerWrapper class with a fully mocked window.YT object:

  1. Mock window.YT with Player constructor that accepts containerElement, videoId, config and provides mock methods (playVideo, pauseVideo, getCurrentTime, getDuration, seekTo, setVolume, isMuted, mute, unMute, destroy).
  2. Test constructor: when YT is loaded, calls createPlayer immediately. When YT is not loaded, creates a script tag.
  3. Test play/pause: verify they call player.playVideo/pauseVideo after ready.
  4. Test command queue: call play() before ready, trigger handlePlayerReady, verify playVideo was called.
  5. Test getCurrentTime/getDuration: return player values when ready, return 0 when not ready.
  6. Test seekTo/setVolume: verify correct arguments passed (setVolume converts 0-1 to 0-100 scale).
  7. Test isMuted/setMuted: verify mute/unMute delegation.
  8. Test on/off event listeners: register callback, trigger emit, verify callback called. Remove callback with off, verify no longer called.
  9. Test state change handling: simulate PLAYING/PAUSED/ENDED states, verify corresponding events emitted and time tracking starts/stops.
  10. Test time tracking: verify setInterval is created on PLAYING state, cleared on PAUSED/ENDED.
  11. Test destroy: verify cleanup of interval, listeners, queue, and player.

  **overlay-manager.spec.ts** (currently 78.57% - add missing tests):
  Add tests for uncovered lines 97-101, 109-113, 123-124:
  1. Test removeAllOverlays when overlays exist (cleanup path).
  2. Test highlightElement with a positioned element that has specific dimensions.
  3. Test edge cases: calling methods when manager is already destroyed.
  </action>
  <verify>
  Run `npx stencil test --spec src/components/sp-walkthrough/utils/ -- --coverage 2>&1 | grep -E "(draggable|youtube|overlay)"` and verify all three utility files show >= 70% statement coverage.
  </verify>
  <done>draggable-mixin.ts, youtube-wrapper.ts, and overlay-manager.ts all have >= 70% statement coverage with tests covering core functionality.</done>
</task>

<task type="auto">
  <name>Task 2: Add sp-walkthrough component coverage gap tests and fallback rendering tests</name>
  <files>src/components/sp-walkthrough/sp-walkthrough.spec.ts</files>
  <action>
  Add targeted spec tests to sp-walkthrough.spec.ts to cover uncovered lines. Current coverage is 40.95%. Key uncovered areas (lines 117-118, 127, 140-141, 162, 184-203, 215-262, 277-330, 340-416, 424-522, 533-604, 611-638, 658, 804-888, 926):

  **Component lifecycle and show/hide (lines 117-118, 127, 140-162):**
  1. Test show() method: sets visible state, calls advanceToScene. Provide scenes data via prop.
  2. Test hide() method: sets visible to false, cleans up overlays.
  3. Test componentDidLoad / componentDidUnload lifecycle hooks.

  **Navigation methods (lines 184-262):**
  4. Test nextScene() and previousScene(): verify scene index advances/decrements, emits scene-change event.
  5. Test goToScene(index): jump to specific scene index, verify current scene updates.
  6. Test advanceToScene: verify it calls highlightElement with the correct selector from current scene.

  **Video control methods (lines 277-330):**
  7. Test play/pause toggle with mock video player.
  8. Test volume control: setVolume, toggleMute.
  9. Test caption toggle.

  **Author mode (lines 340-522):**
  10. Test toggleAuthorMode: sets authorMode state, shows/hides author toolbar.
  11. Test addScene: creates new scene, emits timeline-update event.
  12. Test updateScene: modifies existing scene properties.
  13. Test deleteScene: removes scene at index, emits timeline-update event.
  14. Test startPointerTool / stopPointerTool: activates/deactivates element selection mode.

  **Keyboard and event handlers (lines 533-638):**
  15. Test ESC key press: triggers hide() and emits walkthrough-abort event.
  16. Test keyboard navigation: arrow keys for prev/next scene.

  **Render paths (lines 804-888, 926):**
  17. Test render with video source (MP4/WebM): verify video element is created.
  18. Test render with YouTube source: verify YouTube container is created.
  19. Test render without video: verify manual navigation controls (prev/next buttons) appear.

  **Fallback rendering tests (new describe block):**
  20. Add `describe('fallback rendering without DWC theme', () => { ... })` that verifies:
      - Component renders without errors when no DWC tokens are loaded
      - Panel container structure is intact
      - Scene content area renders
      - Navigation controls are present and clickable
      - The component doesn't collapse or show invisible text

  Mock external dependencies: create mock VideoPlayer object for video tests, mock document.querySelector for element highlighting, mock OverlayManager methods.
  </action>
  <verify>
  Run `npx stencil test --spec src/components/sp-walkthrough/sp-walkthrough.spec.ts -- --coverage 2>&1 | grep "sp-walkthrough.tsx"` and verify statement coverage >= 70%.
  </verify>
  <done>sp-walkthrough.spec.ts contains tests covering show/hide, navigation, video controls, author mode, keyboard handlers, render paths, and fallback rendering. sp-walkthrough.tsx statement coverage >= 70%.</done>
</task>

</tasks>

<verification>
1. draggable-mixin.ts coverage >= 70% statements
2. youtube-wrapper.ts coverage >= 70% statements
3. overlay-manager.ts coverage >= 70% statements
4. sp-walkthrough.tsx coverage >= 70% statements
5. All existing tests still pass (no regressions)
6. Fallback rendering test block exists for sp-walkthrough
</verification>

<success_criteria>
- All sp-walkthrough utilities (draggable-mixin, youtube-wrapper, overlay-manager) have >= 70% coverage
- sp-walkthrough.tsx has >= 70% statement coverage
- Fallback rendering tests verify walkthrough renders without DWC theme
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-testing-quality/05-02-SUMMARY.md`
</output>
