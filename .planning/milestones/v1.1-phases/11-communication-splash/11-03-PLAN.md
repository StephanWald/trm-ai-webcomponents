---
phase: 11-communication-splash
plan: 03
type: execute
wave: 2
depends_on: ["11-01", "11-02"]
files_modified:
  - src/components/sp-communication-preferences/sp-communication-preferences.spec.ts
  - src/components/sp-communication-list/sp-communication-list.spec.ts
  - src/components/sp-communication-preferences/sp-communication-preferences.e2e.ts
  - src/components/sp-splash/sp-splash.spec.ts
  - src/components/sp-splash/sp-splash.e2e.ts
autonomous: true
requirements: [COMM-01, COMM-02, COMM-03, COMM-04, COMM-05, SPLS-01, SPLS-02, SPLS-03, SPLS-04, SPLS-05, SPLS-06]

must_haves:
  truths:
    - "Spec tests validate rendering, props, state, events, and methods for all Phase 11 components"
    - "E2E tests validate browser interactions for sp-communication-preferences and sp-splash"
    - "All tests pass and coverage meets the 70% threshold"
  artifacts:
    - path: "src/components/sp-communication-preferences/sp-communication-preferences.spec.ts"
      provides: "Spec tests for sp-communication-preferences selector component"
    - path: "src/components/sp-communication-list/sp-communication-list.spec.ts"
      provides: "Spec tests for sp-communication-list dropdown component"
    - path: "src/components/sp-communication-preferences/sp-communication-preferences.e2e.ts"
      provides: "E2E tests for sp-communication-preferences browser interactions"
    - path: "src/components/sp-splash/sp-splash.spec.ts"
      provides: "Spec tests for sp-splash modal overlay component"
    - path: "src/components/sp-splash/sp-splash.e2e.ts"
      provides: "E2E tests for sp-splash browser interactions"
  key_links:
    - from: "src/components/sp-communication-preferences/sp-communication-preferences.spec.ts"
      to: "src/components/sp-communication-preferences/sp-communication-preferences.tsx"
      via: "imports SpCommunicationPreferences class for newSpecPage"
      pattern: "import.*SpCommunicationPreferences"
    - from: "src/components/sp-splash/sp-splash.spec.ts"
      to: "src/components/sp-splash/sp-splash.tsx"
      via: "imports SpSplash class for newSpecPage"
      pattern: "import.*SpSplash"
---

<objective>
Write comprehensive spec and E2E tests for all Phase 11 components: sp-communication-preferences, sp-communication-list, and sp-splash.

Purpose: Validate all COMM and SPLS requirements with automated tests. Ensure components render correctly, handle user interactions, emit events, and support all prop variations.

Output: 5 test files covering spec tests (3 components) and E2E tests (2 component groups), targeting 70% coverage threshold.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-communication-splash/11-01-SUMMARY.md
@.planning/phases/11-communication-splash/11-02-SUMMARY.md

# Test pattern reference — follow these files exactly
@src/components/sp-language-selector/sp-language-selector.spec.ts
@src/components/sp-language-selector/sp-language-selector.e2e.ts
@src/components/sp-language-list/sp-language-list.spec.ts
@src/components/sp-popover/sp-popover.spec.ts
@src/components/sp-popover/sp-popover.e2e.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write spec tests for sp-communication-list and sp-communication-preferences</name>
  <files>
    src/components/sp-communication-list/sp-communication-list.spec.ts
    src/components/sp-communication-preferences/sp-communication-preferences.spec.ts
  </files>
  <action>
Follow the sp-language-list.spec.ts and sp-language-selector.spec.ts patterns exactly.

**sp-communication-list.spec.ts** — import SpCommunicationList, use newSpecPage:

describe('sp-communication-list'):

Rendering tests (COMM-02):
- renders a container with .channel-list class and role="listbox"
- renders 6 channel items by default (one per CHANNELS entry)
- each channel item has .channel-item class
- each channel item contains an icon SVG element
- each channel item contains the channel label text (check for "Application", "Email", etc.)

Props tests:
- selectedChannel defaults to 'APPLICATION'
- changing selectedChannel marks the correct item as .selected
- theme="dark" sets theme-dark class on host
- theme="light" sets theme-light class on host
- compact mode adds .compact class to the list container

Selection tests (COMM-03, COMM-04):
- selected channel item has .selected class
- selected channel check-icon is visible (via .selected parent)
- non-selected items do not have .selected class
- clicking a channel item emits preferenceChange event with correct channel and label
- event detail contains { channel: 'EMAIL', label: 'Email' } when Email is clicked

**sp-communication-preferences.spec.ts** — import SpCommunicationPreferences, use newSpecPage:

describe('sp-communication-preferences'):

Rendering tests (COMM-01):
- renders a button with .selector-button class
- button contains an SVG icon (channel icon)
- button contains a .channel-label span with the channel display name
- button contains a .chevron span
- renders sp-popover element in shadow DOM
- renders sp-communication-list inside the popover
- default selectedChannel is 'APPLICATION'
- button has aria-haspopup="listbox"

Props tests:
- changing selectedChannel updates the displayed label and icon
- disabled prop adds disabled attribute to button
- compact mode adds .compact class to button
- theme="dark"/"light" sets host class

State tests:
- isOpen defaults to false
- button does not have .open class when closed
- button has .open class when isOpen=true
- chevron has .open class when isOpen=true
- aria-expanded matches isOpen state

Event handling tests:
- disabled button does not toggle popover on click (same pattern as language selector: call handleButtonClick, verify isOpen stays false)
- handleChannelSelected updates selectedChannel and re-emits preferenceChange event (stub popoverRef as { hidePopover: jest.fn() })
- handlePopoverOpen sets isOpen to true
- handlePopoverClose sets isOpen to false

IMPORTANT testing patterns to follow:
- Only include SpCommunicationPreferences in the components array — child components render as tags without being inflated
- Set props via HTML attributes in newSpecPage HTML (e.g., `selected-channel="EMAIL"`, `compact`, `disabled`, `theme="dark"`) to avoid @Prop immutability warnings
- Stub popoverRef with `page.rootInstance['popoverRef'] = { hidePopover: jest.fn() } as any` before testing handleChannelSelected
- NO jest.useFakeTimers() before await page.waitForChanges() — this component has no timers anyway
  </action>
  <verify>Run `npx stencil test --spec -- --testPathPattern="sp-communication"` — all spec tests pass.</verify>
  <done>All spec tests pass for sp-communication-list (rendering, props, selection, events) and sp-communication-preferences (rendering, props, state, event handling). No test failures.</done>
</task>

<task type="auto">
  <name>Task 2: Write spec tests for sp-splash and E2E tests for both component groups</name>
  <files>
    src/components/sp-splash/sp-splash.spec.ts
    src/components/sp-communication-preferences/sp-communication-preferences.e2e.ts
    src/components/sp-splash/sp-splash.e2e.ts
  </files>
  <action>
**sp-splash.spec.ts** — import SpSplash, use newSpecPage:

describe('sp-splash'):

Rendering tests (SPLS-01, SPLS-02, SPLS-06):
- renders a .splash-overlay div with role="dialog" and aria-modal="true"
- renders a .splash-container inside the overlay
- renders a .close-button button with aria-label="Close"
- renders .splash-header, .splash-body, .splash-footer sections
- renders named slots: slot="logo", slot="title", slot="subtitle", slot="body", slot="footer"
- overlay has aria-hidden="true" when closed

Props tests:
- open defaults to false
- isVisible defaults to false
- theme="dark" sets theme-dark class on host
- closeOnEscape defaults to true
- closeOnBackdrop defaults to true

State tests (SPLS-04):
- when open is set to true via rootInstance, isVisible becomes true after waitForChanges
- overlay has .open class when isVisible=true
- overlay does not have .open class when isVisible=false
- aria-hidden="false" when open

Methods tests (SPLS-04):
- show() sets open to true
- hide() sets open to false

Dismiss tests (SPLS-03, SPLS-05):
- handleCloseClick emits splashClose with reason 'button' and sets open to false
- handleKeydown with Escape key emits splashClose with reason 'escape' (when closeOnEscape=true)
- handleKeydown with Escape key does NOT emit when closeOnEscape=false
- handleBackdropClick emits splashClose with reason 'backdrop' when clicking overlay (when closeOnBackdrop=true)
- handleBackdropClick does NOT emit when closeOnBackdrop=false

Cleanup tests:
- disconnectedCallback does not throw (cleanup runs cleanly)

IMPORTANT testing patterns:
- For dismiss handler tests, call the handler directly on rootInstance (e.g., `page.rootInstance['handleCloseClick']()`)
- For handleBackdropClick, create a mock MouseEvent where target === currentTarget (use the overlay div as both)
- For handleKeydown, create `new KeyboardEvent('keydown', { key: 'Escape' })`
- Watch for the Stencil @Watch not firing on initial values pattern — test that componentDidLoad syncs initial open=true

**sp-communication-preferences.e2e.ts** — Follow sp-language-selector.e2e.ts pattern:

test.describe('sp-communication-preferences E2E'):
1. Renders selector button with channel icon and label text — verify .selector-button exists, has SVG icon and text content
2. Clicking button opens channel dropdown — click button, check aria-expanded="true"
3. Channel list renders all 6 channels — open dropdown, verify sp-communication-list exists
4. Setting selectedChannel prop updates the displayed channel — set el.selectedChannel = 'EMAIL', verify label text changes
5. preferenceChange event fires when a channel is selected — dispatch synthetic event from sp-communication-list, verify event fires
6. Disabled selector does not open dropdown on click — click disabled variant, verify aria-expanded="false"

Use page.goto('http://localhost:3333') pattern. Use IDs from index.html: commPrefsDemo, commPrefsDisabled. Shadow DOM access via page.evaluate with el.shadowRoot.querySelector.

**sp-splash.e2e.ts** — Follow sp-popover.e2e.ts pattern:

test.describe('sp-splash E2E'):
1. Splash is hidden by default — verify #splashDemo is not visually open (overlay does not have .open class)
2. Calling show() opens the splash — call el.show(), wait, verify overlay has .open class
3. Close button dismisses the splash — open splash, click close button, verify overlay loses .open class
4. Escape key dismisses the splash — open splash, press Escape via keyboard, verify closed
5. Backdrop click dismisses the splash — open splash, click on overlay (not container), verify closed
6. splashClose event fires with correct reason — open splash, click close button, verify event.detail.reason === 'button'
7. Named slots render custom content — open splash, verify slotted content is visible (e.g., check for "Welcome to Skillspilot" text in the DOM)

Use page.goto('http://localhost:3333') pattern. Use ID: splashDemo. Shadow DOM access via page.evaluate.
  </action>
  <verify>Run `npx stencil test --spec -- --testPathPattern="sp-splash"` for spec tests. Run `npx stencil test --e2e -- --testPathPattern="(sp-communication|sp-splash)"` for E2E tests. All tests pass. Run `npx stencil test --spec --coverage` to verify 70% threshold is met.</verify>
  <done>All spec and E2E tests pass for sp-splash and sp-communication-preferences. Coverage meets the 70% threshold across statements, branches, functions, and lines for both component groups.</done>
</task>

</tasks>

<verification>
1. `npx stencil test --spec` — all spec tests pass (sp-communication-list, sp-communication-preferences, sp-splash)
2. `npx stencil test --e2e` — all E2E tests pass (sp-communication-preferences, sp-splash)
3. `npx stencil test --spec --coverage` — coverage meets 70% threshold for all Phase 11 components
4. No regressions in existing test suite
</verification>

<success_criteria>
- Spec tests cover rendering, props, state, events, and methods for all 3 components
- E2E tests cover browser interactions for both component groups
- All COMM and SPLS requirements are validated by at least one test
- Coverage meets 70% threshold
- No test failures or regressions
</success_criteria>

<output>
After completion, create `.planning/phases/11-communication-splash/11-03-SUMMARY.md`
</output>
