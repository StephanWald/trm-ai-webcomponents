---
phase: 09-popover-utility
plan: 02
type: execute
wave: 2
depends_on:
  - 09-01
files_modified:
  - src/components/sp-popover/utils/position.spec.ts
  - src/components/sp-popover/sp-popover.spec.ts
  - src/components/sp-popover/sp-popover.e2e.ts
autonomous: true
requirements:
  - POPV-01
  - POPV-02
  - POPV-03
  - POPV-04
  - POPV-05
  - POPV-06

must_haves:
  truths:
    - "Positioning utility is tested for all 6 placements and viewport flip logic"
    - "Component spec tests verify props, open/close state, events, and methods"
    - "E2E tests confirm real browser positioning, dismiss behaviors, and animation"
    - "All tests pass and build succeeds"
  artifacts:
    - path: "src/components/sp-popover/utils/position.spec.ts"
      provides: "Unit tests for calculatePosition and getFlippedPlacement"
      min_lines: 60
    - path: "src/components/sp-popover/sp-popover.spec.ts"
      provides: "Component spec tests for rendering, props, state, events, methods"
      min_lines: 80
    - path: "src/components/sp-popover/sp-popover.e2e.ts"
      provides: "E2E tests for browser interactions"
      min_lines: 40
  key_links:
    - from: "src/components/sp-popover/utils/position.spec.ts"
      to: "src/components/sp-popover/utils/position.ts"
      via: "import calculatePosition, getFlippedPlacement"
      pattern: "calculatePosition|getFlippedPlacement"
    - from: "src/components/sp-popover/sp-popover.spec.ts"
      to: "src/components/sp-popover/sp-popover.tsx"
      via: "newSpecPage with sp-popover tag"
      pattern: "newSpecPage"
    - from: "src/components/sp-popover/sp-popover.e2e.ts"
      to: "sp-popover component"
      via: "Playwright page.setContent"
      pattern: "sp-popover"
---

<objective>
Add comprehensive test coverage for the sp-popover component -- unit tests for the positioning utility, spec tests for the Stencil component, and E2E tests for real browser interactions.

Purpose: Ensure the positioning algorithm, dismiss behaviors, and public API work correctly before Phases 10 and 11 build on top of sp-popover. Tests also contribute toward the Phase 12 coverage threshold.

Output: Three test files covering utility logic, component behavior, and browser interactions.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-popover-utility/09-01-SUMMARY.md
@src/components/sp-popover/sp-popover.tsx
@src/components/sp-popover/utils/position.ts
@src/components/sp-popover/types.ts
@src/components/sp-example/sp-example.spec.ts
@src/components/sp-example/sp-example.e2e.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unit tests for positioning utility and component spec tests</name>
  <files>
    src/components/sp-popover/utils/position.spec.ts
    src/components/sp-popover/sp-popover.spec.ts
  </files>
  <action>
**position.spec.ts** -- Pure function unit tests for the positioning algorithm:

Test `calculatePosition()`:
- Test all 6 placements with a mock anchor rect (e.g., `{ top: 200, left: 200, bottom: 240, right: 320, width: 120, height: 40 }`) and popover dimensions (e.g., `{ width: 200, height: 150 }`):
  - `bottom-start`: top should be anchor.bottom + gap, left should be anchor.left
  - `bottom-end`: top should be anchor.bottom + gap, left should be anchor.right - popoverWidth
  - `top-start`: top should be anchor.top - popoverHeight - gap, left should be anchor.left
  - `top-end`: top should be anchor.top - popoverHeight - gap, left should be anchor.right - popoverWidth
  - `right-start`: top should be anchor.top, left should be anchor.right + gap
  - `left-start`: top should be anchor.top, left should be anchor.left - popoverWidth - gap
- Test viewport flip -- bottom overflow: anchor near bottom of viewport (e.g., `top: 700` in an 800px viewport), `bottom-start` should flip to `top-start` (actualPlacement = 'top-start')
- Test viewport flip -- right overflow: anchor near right edge, `bottom-start` should flip to `bottom-end`
- Test viewport flip -- top overflow: anchor near top edge, `top-start` should flip to `bottom-start`
- Test viewport flip -- left overflow: anchor near left edge, `left-start` should flip to `right-start`
- Test 10px margin clamping: position should never result in values < 10 or > viewport - 10

Test `getFlippedPlacement()`:
- Vertical flip: `bottom-start` -> `top-start`, `top-end` -> `bottom-end`
- Horizontal flip: `bottom-start` -> `bottom-end`, `top-end` -> `top-start`
- Left/right flip: `right-start` -> `left-start`, `left-start` -> `right-start`

Mock `window.innerWidth` and `window.innerHeight` using `Object.defineProperty` for viewport tests. Restore in afterEach.

**sp-popover.spec.ts** -- Component spec tests using Stencil's `newSpecPage`:

Rendering tests:
- Renders with default props (popover-container exists, is not open)
- Renders with `open={true}` (popover-container has `.open` class)
- Applies theme class when `theme="dark"` is set
- Slot content is projected into `.popover-content`

Prop tests:
- `placement` prop defaults to 'bottom-start'
- `closeOnClick` prop defaults to true
- `closeOnEscape` prop defaults to true
- `open` prop change triggers state update (watch handler)

Method tests -- call methods on `page.rootInstance`:
- `showPopover()` sets `isOpen = true` and emits `popoverOpen` event
- `hidePopover()` sets `isOpen = false` and emits `popoverClose` event
- `togglePopover()` toggles between open and closed states
- `updatePosition()` does not change open state

Event tests:
- Opening emits `popoverOpen` event
- Closing emits `popoverClose` event

ARIA tests:
- `aria-hidden="true"` when closed
- `aria-hidden="false"` when open
- `role="dialog"` on the container

Follow established Stencil spec patterns from the project:
- Use `newSpecPage({ components: [SpPopover], html: '<sp-popover>content</sp-popover>' })`
- Access root instance via `page.rootInstance`
- Use `page.waitForChanges()` after state changes
- Do NOT use `jest.useFakeTimers()` before `newSpecPage()` (project decision from Phase 05)
  </action>
  <verify>
- `npx stencil test --spec -- --testPathPattern="sp-popover"` passes all tests
- position.spec.ts covers all 6 placements, viewport flips, and margin clamping
- sp-popover.spec.ts covers rendering, props, methods, events, and ARIA
  </verify>
  <done>
Position utility has comprehensive unit tests for all 6 placements, viewport boundary flipping, and margin clamping. Component spec tests verify rendering, default props, open/close state management, all 4 public methods, event emission, and ARIA attributes. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: E2E tests for browser interactions</name>
  <files>
    src/components/sp-popover/sp-popover.e2e.ts
  </files>
  <action>
**sp-popover.e2e.ts** -- Playwright E2E tests for real browser behavior:

Follow the project's E2E pattern: use `@stencil/playwright` with `page.setContent()` and shadow DOM piercing via `page.evaluate()`.

Test setup HTML pattern:
```html
<button id="anchor">Click me</button>
<sp-popover anchor="#anchor" placement="bottom-start">
  <div>Popover content</div>
</sp-popover>
```

Tests:

1. **Renders hidden by default**: Popover container exists in shadow DOM but is not visible (no `.open` class)

2. **Opens via method**: Call `showPopover()` via `page.evaluate`, verify `.open` class is added and content is visible

3. **Closes via method**: Open then call `hidePopover()`, verify `.open` class is removed

4. **Toggle method**: Call `togglePopover()` twice, verify it opens then closes

5. **Close on outside click** (POPV-03): Open the popover, click somewhere outside both the anchor and popover, verify it closes

6. **Close on Escape key** (POPV-03): Open the popover, press Escape, verify it closes

7. **Disable close on click**: Set `close-on-click="false"`, open popover, click outside, verify it stays open

8. **Disable close on Escape**: Set `close-on-escape="false"`, open popover, press Escape, verify it stays open

9. **Events emitted**: Listen for `popover-open` and `popover-close` events via `page.evaluate`, verify they fire on open/close

10. **Positioned near anchor**: Open popover, verify its computed position is near the anchor element (top > anchor.bottom, left near anchor.left for bottom-start)

Use `page.waitForTimeout()` sparingly -- prefer `page.waitForChanges()` or `waitForSelector` patterns.

For shadow DOM access, use `page.evaluate()` to access `document.querySelector('sp-popover').shadowRoot.querySelector('.popover-container')`.

For method calls, use `page.evaluate(() => document.querySelector('sp-popover').showPopover())`.
  </action>
  <verify>
- `npx stencil test --e2e -- --testPathPattern="sp-popover"` passes all tests
- Tests cover: rendering, open/close methods, toggle, outside-click dismiss, escape dismiss, disable dismiss, events, and positioning
  </verify>
  <done>
E2E tests verify real browser behavior: popover renders hidden, opens/closes via methods, toggles, dismisses on outside-click and Escape (with independent disable), emits events, and positions near its anchor. All E2E tests pass.
  </done>
</task>

</tasks>

<verification>
1. `npx stencil test --spec -- --testPathPattern="sp-popover"` -- all spec tests pass
2. `npx stencil test --e2e -- --testPathPattern="sp-popover"` -- all E2E tests pass
3. `npx stencil build` -- build still succeeds with test files present
4. Test files exist: position.spec.ts, sp-popover.spec.ts, sp-popover.e2e.ts
</verification>

<success_criteria>
- All positioning utility tests pass (6 placements, viewport flips, margin clamping)
- All component spec tests pass (rendering, props, methods, events, ARIA)
- All E2E tests pass (browser interactions, dismiss behaviors, positioning)
- No test failures in the full test suite (`npx stencil test --spec --e2e`)
</success_criteria>

<output>
After completion, create `.planning/phases/09-popover-utility/09-02-SUMMARY.md`
</output>
