---
phase: 07-org-chart-parity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/sp-org-chart/types/org-chart.types.ts
  - src/components/sp-org-chart/utils/tree-builder.ts
  - src/components/sp-org-chart/utils/tree-builder.spec.ts
  - src/components/sp-org-chart/utils/tree-filter.ts
  - src/components/sp-org-chart/utils/tree-filter.spec.ts
  - src/components/sp-org-chart/utils/tree-sorter.ts
  - src/components/sp-org-chart/utils/tree-sorter.spec.ts
autonomous: true
requirements:
  - ORGC-02
  - ORGC-04

must_haves:
  truths:
    - "User data model supports firstName, lastName, email, phone, branchId, branchName, branchLogo, avatar, role, reportsTo fields"
    - "Branch entities (users without lastName) are distinguishable from regular users via a helper or type guard"
    - "Tree builder constructs hierarchical trees from the expanded User model"
    - "Tree filter supports branch-based filtering (by branchId) in addition to text-based filtering"
    - "All utility spec tests pass with the new data model"
  artifacts:
    - path: "src/components/sp-org-chart/types/org-chart.types.ts"
      provides: "Expanded User interface, TreeNode, FilterResult, event detail types, branch helper"
      contains: "firstName"
    - path: "src/components/sp-org-chart/utils/tree-builder.ts"
      provides: "buildTree function compatible with expanded User model"
      exports: ["buildTree"]
    - path: "src/components/sp-org-chart/utils/tree-filter.ts"
      provides: "filterTree function and new filterByBranch function"
      exports: ["filterTree", "filterByBranch"]
    - path: "src/components/sp-org-chart/utils/tree-sorter.ts"
      provides: "sortTree function using firstName+lastName for sorting"
      exports: ["sortTree"]
  key_links:
    - from: "src/components/sp-org-chart/utils/tree-builder.ts"
      to: "src/components/sp-org-chart/types/org-chart.types.ts"
      via: "imports User and TreeNode types"
      pattern: "import.*User.*TreeNode.*from.*types"
    - from: "src/components/sp-org-chart/utils/tree-filter.ts"
      to: "src/components/sp-org-chart/types/org-chart.types.ts"
      via: "imports TreeNode and FilterResult types"
      pattern: "import.*TreeNode.*FilterResult.*from.*types"
---

<objective>
Rewrite the sp-org-chart data model and tree utilities to support the expanded user/branch schema required for prototype parity.

Purpose: The current User interface only has (id, name, role, reportsTo, avatar). The prototype requires (firstName, lastName, email, phone, branchId, branchName, branchLogo, avatar, role, reportsTo). Branch entities need distinct handling. Tree utilities must work with the new model and support branch-based filtering.

Output: Updated types, tree-builder, tree-filter, tree-sorter, and their passing spec tests.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-org-chart-parity/07-CONTEXT.md
@src/components/sp-org-chart/types/org-chart.types.ts
@src/components/sp-org-chart/utils/tree-builder.ts
@src/components/sp-org-chart/utils/tree-filter.ts
@src/components/sp-org-chart/utils/tree-sorter.ts
@src/components/sp-org-chart/utils/tree-builder.spec.ts
@src/components/sp-org-chart/utils/tree-filter.spec.ts
@src/components/sp-org-chart/utils/tree-sorter.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite types and add branch helper</name>
  <files>src/components/sp-org-chart/types/org-chart.types.ts</files>
  <action>
Rewrite the User interface to match the prototype's expanded data model:

```typescript
export interface User {
  id: string;
  firstName: string;
  lastName?: string;        // Absent for branch entities
  email?: string;
  phone?: string;
  role: string;
  avatar?: string;
  reportsTo?: string;
  branchId?: string;
  branchName?: string;
  branchLogo?: string;      // URL for branch square logo
}
```

Keep backward compatibility by adding a computed display name helper:

```typescript
/** Get display name: "firstName lastName" or just "firstName" for branches */
export function getDisplayName(user: User): string {
  return user.lastName ? `${user.firstName} ${user.lastName}` : user.firstName;
}

/** Check if a user entry represents a branch entity (no lastName) */
export function isBranch(user: User): boolean {
  return !user.lastName;
}
```

Update TreeNode to extend the new User (children and level stay the same).

Update UserEventDetail to use the new User type (no structural change needed since it references User).

Add a BranchFilterMode type:
```typescript
export type BranchFilterMode = 'none' | 'highlight' | 'isolate';
```

Keep HierarchyChangeDetail and FilterResult unchanged structurally (they still work).
  </action>
  <verify>TypeScript compiles without errors: `npx stencil build --dev 2>&1 | head -20` (expect warnings about unused imports in sp-org-chart.tsx since the component hasn't been updated yet, but no type errors in the types file itself)</verify>
  <done>User interface has all 11 fields (id, firstName, lastName, email, phone, role, avatar, reportsTo, branchId, branchName, branchLogo). getDisplayName and isBranch helper functions exported. BranchFilterMode type exported. TreeNode extends the new User.</done>
</task>

<task type="auto">
  <name>Task 2: Update tree utilities for expanded data model</name>
  <files>
    src/components/sp-org-chart/utils/tree-builder.ts
    src/components/sp-org-chart/utils/tree-filter.ts
    src/components/sp-org-chart/utils/tree-sorter.ts
  </files>
  <action>
**tree-builder.ts**: The buildTree function works on User.id and User.reportsTo which haven't changed structurally, so the algorithm stays the same. Update the import to use the new User type. The spread `...user` will carry all new fields into TreeNode. No logic changes needed — just verify the import path and types align.

**tree-filter.ts**: Add a new `filterByBranch` export function alongside the existing `filterTree`:

```typescript
/**
 * Filter tree by branch ID. Returns a Map of FilterResult entries.
 * - mode 'highlight': dims non-matching users, keeps all branches visible
 * - mode 'isolate': hides unrelated branches entirely, dims non-matching users
 */
export function filterByBranch(
  roots: TreeNode[],
  branchId: string,
  mode: 'highlight' | 'isolate'
): Map<string, FilterResult> {
  // Use existing filterTree with a predicate that checks user.branchId === branchId
  // For 'highlight' mode: predicate matches users with matching branchId
  // For 'isolate' mode: same predicate, but the component will use the results
  //   to hide (display:none) branches that have zero matching users
  return filterTree(roots, (node) => {
    // Branch entities match if their branchId or id matches
    if (isBranch(node)) {
      return node.id === branchId || node.branchId === branchId;
    }
    // Regular users match if their branchId matches
    return node.branchId === branchId;
  });
}
```

Import `isBranch` from the types file.

**tree-sorter.ts**: Update sorting to use `getDisplayName(node)` instead of `node.name` (which no longer exists). Import `getDisplayName` from the types file.

```typescript
import { TreeNode } from '../types/org-chart.types';
import { getDisplayName } from '../types/org-chart.types';

export function sortTree(nodes: TreeNode[]): TreeNode[] {
  const sorted = [...nodes].sort((a, b) =>
    getDisplayName(a).localeCompare(getDisplayName(b), undefined, { sensitivity: 'base' })
  );
  sorted.forEach(node => {
    if (node.children.length > 0) {
      node.children = sortTree(node.children);
    }
  });
  return sorted;
}
```
  </action>
  <verify>`npx stencil build --dev 2>&1 | head -30` compiles without errors in the utility files (component TSX will have errors since it still references old `name` field — that's expected and fixed in Plan 02)</verify>
  <done>tree-builder.ts imports new User type. tree-filter.ts exports filterByBranch alongside filterTree. tree-sorter.ts uses getDisplayName for sorting. All three utilities are compatible with the expanded data model.</done>
</task>

<task type="auto">
  <name>Task 3: Rewrite utility spec tests for expanded data model</name>
  <files>
    src/components/sp-org-chart/utils/tree-builder.spec.ts
    src/components/sp-org-chart/utils/tree-filter.spec.ts
    src/components/sp-org-chart/utils/tree-sorter.spec.ts
  </files>
  <action>
Update ALL test data to use the new User interface (firstName instead of name, add lastName where appropriate).

**tree-builder.spec.ts**: Update all User test objects from `{ id, name, role, reportsTo, avatar }` to `{ id, firstName, lastName, role, reportsTo, avatar }`. Example:
- Before: `{ id: '1', name: 'Alice Johnson', role: 'CEO' }`
- After: `{ id: '1', firstName: 'Alice', lastName: 'Johnson', role: 'CEO' }`

Add test cases for:
- Building tree with branch entities (users without lastName, with branchId, branchName, branchLogo)
- Mixed tree with both regular users and branch entities
- Branch entity as root node

**tree-filter.spec.ts**: Update all User test objects to new format. Update filter predicates that reference `node.name` to use `getDisplayName(node)`. Add test cases for:
- `filterByBranch` in 'highlight' mode (dims non-matching, keeps structure)
- `filterByBranch` in 'isolate' mode (same filter results, component handles hiding)
- Filtering with mixed user and branch entities

**tree-sorter.spec.ts**: Update all User test objects to new format. Sorting assertions should use getDisplayName output. Add test case for:
- Sorting with branch entities mixed in (branches sorted by firstName only since no lastName)

Run tests with: `npx stencil test --spec -- --testPathPattern="utils/(tree-builder|tree-filter|tree-sorter)"`
  </action>
  <verify>`npx stencil test --spec -- --testPathPattern="utils/(tree-builder|tree-filter|tree-sorter)"` — all utility spec tests pass</verify>
  <done>All tree-builder, tree-filter, and tree-sorter spec tests pass. Tests use expanded User model with firstName/lastName. filterByBranch tests cover highlight and isolate modes. Branch entity test cases present in all three test files.</done>
</task>

</tasks>

<verification>
1. `npx stencil test --spec -- --testPathPattern="utils/(tree-builder|tree-filter|tree-sorter)"` — all utility tests pass
2. Types file exports: User (with all 11 fields), TreeNode, FilterResult, HierarchyChangeDetail, UserEventDetail, BranchFilterMode, getDisplayName, isBranch
3. tree-filter.ts exports both filterTree and filterByBranch
4. tree-sorter.ts uses getDisplayName for sorting
</verification>

<success_criteria>
- All 11 User fields defined in the interface
- getDisplayName and isBranch helper functions work correctly
- filterByBranch function filters by branch ID
- sortTree uses display names for alphabetical ordering
- All utility spec tests pass (existing tests updated + new branch entity tests)
- No regressions in tree-builder cycle detection or orphan handling
</success_criteria>

<output>
After completion, create `.planning/phases/07-org-chart-parity/07-01-SUMMARY.md`
</output>
