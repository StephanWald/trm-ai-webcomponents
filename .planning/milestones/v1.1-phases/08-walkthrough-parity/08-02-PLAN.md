---
phase: 08-walkthrough-parity
plan: 02
type: execute
wave: 2
depends_on:
  - "08-01"
files_modified:
  - src/components/sp-walkthrough/sp-walkthrough.tsx
  - src/components/sp-walkthrough/sp-walkthrough.css
  - src/components/sp-walkthrough/utils/overlay-manager.ts
  - src/components/sp-walkthrough/sp-walkthrough.spec.ts
  - src/components/sp-walkthrough/sp-walkthrough.e2e.ts
  - src/components/sp-walkthrough/utils/overlay-manager.spec.ts
autonomous: true
requirements:
  - WALK-05
  - WALK-06
  - WALK-07
  - WALK-08
  - WALK-09

must_haves:
  truths:
    - "Scene list opens as a custom popup (not a native select) showing title and timestamp per scene"
    - "Volume control opens as a vertical popup slider with custom thumb/track styling"
    - "Captions render as a styled overlay (dark background, white text) not native browser captions"
    - "Scene descriptions support markdown rendering (h1-h3, p, ul, ol, code, pre) in the text bubble"
    - "Highlighted elements animate with reddish-brown border and dual glow; active highlights use green state with 1.5s breathing animation"
  artifacts:
    - path: "src/components/sp-walkthrough/sp-walkthrough.tsx"
      provides: "Scene list popup, volume popup, custom caption overlay, markdown text bubble rendering"
      contains: "renderSceneListPopup|renderVolumePopup|renderCaptionOverlay|renderMarkdownDescription"
    - path: "src/components/sp-walkthrough/sp-walkthrough.css"
      provides: "Popup styles, caption overlay, breathing animation keyframes, volume slider vertical styling"
      contains: "scene-list-popup|volume-popup|caption-overlay|@keyframes.*breathe|highlight.*glow"
    - path: "src/components/sp-walkthrough/utils/overlay-manager.ts"
      provides: "Enhanced highlight animations with reddish-brown/green states and breathing glow"
      contains: "breathing|glow|reddish|green|animation"
  key_links:
    - from: "sp-walkthrough.tsx renderSceneListPopup()"
      to: "handleSceneSelect"
      via: "onClick on popup item to select scene and close popup"
      pattern: "sceneListOpen|handleSceneSelect"
    - from: "sp-walkthrough.tsx renderVolumePopup()"
      to: "handleVolumeChange"
      via: "onInput on vertical range slider"
      pattern: "volumePopupOpen|handleVolumeChange"
    - from: "sp-walkthrough.tsx renderCaptionOverlay()"
      to: "activeCueText state"
      via: "textTracks oncuechange event updates activeCueText which renders in overlay"
      pattern: "activeCueText|oncuechange|caption-overlay"
    - from: "sp-walkthrough.tsx renderMarkdownDescription()"
      to: "MarkdownRenderer from sp-markdown-editor"
      via: "import and instantiate MarkdownRenderer, call render() on scene.description"
      pattern: "MarkdownRenderer|innerHTML.*render"
    - from: "overlay-manager.ts createOverlay()"
      to: "CSS animations on highlight overlays"
      via: "CSS class application and animation property setting"
      pattern: "sp-walkthrough-highlight.*animation|breathing"
---

<objective>
Add custom scene list popup, vertical volume slider popup, custom caption overlay rendering, markdown support in scene description text bubbles, and enhanced highlight animations with reddish-brown/green glow effects and breathing animation.

Purpose: Complete visual/behavioral parity for sp-walkthrough popups, captions, markdown, and highlight effects that match the original prototype.
Output: Scene list and volume render as custom popups, captions display as styled overlays, scene descriptions render markdown, and highlights animate with the correct color scheme and breathing effect.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-walkthrough-parity/08-CONTEXT.md
@.planning/phases/08-walkthrough-parity/08-01-SUMMARY.md

Key reference files:
@src/components/sp-walkthrough/sp-walkthrough.tsx
@src/components/sp-walkthrough/sp-walkthrough.css
@src/components/sp-walkthrough/utils/overlay-manager.ts
@src/components/sp-markdown-editor/utils/markdown-renderer.ts (reuse pattern for markdown rendering)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scene list popup, volume vertical popup, custom caption overlay, and markdown text bubble</name>
  <files>
    src/components/sp-walkthrough/sp-walkthrough.tsx
    src/components/sp-walkthrough/sp-walkthrough.css
  </files>
  <action>
    **Scene list custom popup (WALK-05):**
    Replace the native `<select class="scene-selector">` with a custom popup:
    - Add `@State() sceneListOpen: boolean = false` toggle state
    - The scene list button in the controls row (from Plan 01) toggles `sceneListOpen`
    - Render `renderSceneListPopup()` method when `sceneListOpen` is true:
      - Popup positioned above/below the scene list trigger button (absolute positioning relative to controls row)
      - List of scenes, each item showing: scene title (bold) and timestamp (formatted as mm:ss, using formatTime from Plan 01)
      - Current scene is highlighted (different background color)
      - Clicking a scene item calls `handleSceneSelect` (modified to accept index directly instead of event), then closes the popup
      - Clicking outside the popup closes it (add a document click listener when open, remove when closed)
    - CSS for `.scene-list-popup`: absolute position, background surface, border, border-radius, box-shadow, max-height with overflow-y auto, z-index above controls
    - CSS for `.scene-list-popup__item`: padding, hover state, cursor pointer
    - CSS for `.scene-list-popup__item--active`: highlighted background (primary color light variant)
    - CSS for `.scene-list-popup__title` and `.scene-list-popup__time`: title bold, time secondary color

    **Volume vertical popup (WALK-06):**
    Replace the inline horizontal volume slider with a vertical popup:
    - Add `@State() volumePopupOpen: boolean = false` toggle state
    - The volume button in the controls row toggles `volumePopupOpen` (left-click toggles popup, or separate mute behavior: clicking the icon itself toggles mute, a separate hover or long-press opens popup — simplest approach: click opens popup, popup contains both slider and mute toggle)
    - Render `renderVolumePopup()` method when `volumePopupOpen` is true:
      - Popup positioned above the volume button, oriented vertically
      - Contains a vertical range input (CSS transform: rotate(-90deg) or writing-mode approach for vertical orientation)
      - Custom thumb/track styling via CSS pseudo-elements (-webkit-slider-thumb, -webkit-slider-runnable-track)
      - Mute toggle button inside the popup (optional — or keep mute on the main volume icon)
    - Clicking outside closes the popup
    - CSS for `.volume-popup`: absolute position, vertical layout, background surface, border, border-radius, padding
    - CSS for `.volume-popup__slider`: rotated 90deg for vertical orientation, custom thumb (round, primary color), custom track (thin, surface-secondary)

    **Custom caption overlay (WALK-07):**
    Replace native `<track>` captions with a custom rendered overlay:
    - Add `@State() activeCueText: string = ''` state for current caption text
    - In `setupStandardVideo`, listen for `textTracks` cuechange events. When captions are enabled and a cue is active, extract the cue text and set `activeCueText`. When no cue is active, clear it.
    - Keep the `<track>` element but set its mode to `'hidden'` always (never `'showing'`) — we render our own overlay instead
    - When `captionsEnabled` is true, the `handleCaptionsToggle` should toggle `captionsEnabled` state. The track mode stays `'hidden'` — we read cues programmatically.
    - Render `renderCaptionOverlay()`:
      - Only renders when `captionsEnabled && activeCueText`
      - Positioned at the bottom of the video area (absolute within video container)
      - Dark semi-transparent background (`rgba(0,0,0,0.75)`), white text, text-shadow for readability
      - Padding, centered text, border-radius for rounded appearance
    - CSS for `.caption-overlay`: position absolute bottom of video, background, color, font-size, text-shadow, padding, z-index above video, max-width 80%, margin auto

    **Markdown text bubble (WALK-08):**
    Enhance scene description rendering to support markdown:
    - Import `MarkdownRenderer` from `../sp-markdown-editor/utils/markdown-renderer` (reuse existing utility per user decision). NOTE: If this import causes issues with Stencil bundling (different component package), instead copy the MarkdownRenderer class into `src/components/sp-walkthrough/utils/markdown-renderer.ts` with the same implementation.
    - Instantiate `markdownRenderer` in `componentWillLoad()`
    - In `renderSceneInfo()` (the text bubble area), when `scene.description` exists:
      - Call `markdownRenderer.render(scene.description)` to get HTML
      - Render with `innerHTML` (Stencil JSX supports this) inside a `.scene-description-markdown` container
    - CSS for `.scene-description-markdown`: styled as a "text bubble" — background, border-radius, padding, with styles for h1-h3 (font sizes), p (margins), ul/ol (list styles), code (inline code background), pre (code block background with overflow)
    - Ensure text bubble has appropriate DWC-themed colors

    **Popup dismiss pattern:**
    For both scene list and volume popups, implement a shared dismiss pattern:
    - When a popup opens, attach a `document.addEventListener('click', closeHandler, true)` (capture phase)
    - The closeHandler checks if the click target is inside the popup — if not, close it
    - Detach the listener when the popup closes
    - Also close popups when a scene is selected or ESC is pressed
    - Clean up all listeners in `disconnectedCallback`
  </action>
  <verify>
    Run `npx stencil build` — build completes without errors.
    Verify scene list popup renders when scene list button is clicked (not a native select).
    Verify volume popup renders vertically when volume button is clicked.
    Verify caption text appears as a styled overlay when captions are enabled and a cue is active.
    Verify markdown content (headings, lists, code) renders in scene description.
  </verify>
  <done>
    Scene list opens as custom popup with title and timestamp per scene. Volume control opens as vertical popup slider. Captions render as styled dark overlay (not native). Scene descriptions render markdown (h1-h3, p, ul, ol, code, pre). All popups dismiss on outside click. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Highlight animation enhancement and test updates</name>
  <files>
    src/components/sp-walkthrough/utils/overlay-manager.ts
    src/components/sp-walkthrough/utils/overlay-manager.spec.ts
    src/components/sp-walkthrough/sp-walkthrough.spec.ts
    src/components/sp-walkthrough/sp-walkthrough.e2e.ts
    src/components/sp-walkthrough/sp-walkthrough.css
  </files>
  <action>
    **Highlight animations (WALK-09):**
    Update `overlay-manager.ts` `createOverlay()` to apply the correct highlight animation styles:

    1. **Default highlight (reddish-brown border with dual glow):**
       - Border: `3px solid #8B4513` (reddish-brown / saddle brown)
       - Box-shadow: `0 0 10px rgba(139, 69, 19, 0.5), 0 0 20px rgba(139, 69, 19, 0.3)` (dual glow — inner bright, outer subtle)
       - The existing `boxShadow: '0 0 0 9999px rgba(0, 0, 0, 0.5)'` spotlight effect should be combined with the glow: use multiple box-shadows
       - Transition for smooth appearance

    2. **Active highlight (green state with breathing animation):**
       - Add a method `setActiveHighlight(selector: string)` or modify `highlightElement` to accept an options object `{ active?: boolean }`
       - When active: border color `#28a745` (green), box-shadow with green glow
       - Apply CSS animation for breathing effect: the overlay border and glow pulse in/out over 1.5s
       - Since overlays are appended to `document.body` (outside shadow DOM), inject a `<style>` element once into `document.head` containing the `@keyframes sp-walkthrough-breathe` animation:
         ```
         @keyframes sp-walkthrough-breathe {
           0%, 100% { box-shadow: 0 0 10px rgba(40, 167, 69, 0.5), 0 0 20px rgba(40, 167, 69, 0.3), 0 0 0 9999px rgba(0,0,0,0.5); }
           50% { box-shadow: 0 0 20px rgba(40, 167, 69, 0.8), 0 0 40px rgba(40, 167, 69, 0.5), 0 0 0 9999px rgba(0,0,0,0.5); }
         }
         ```
       - Set `overlay.style.animation = 'sp-walkthrough-breathe 1.5s ease-in-out infinite'` for active highlights
       - Style injection: check if `document.getElementById('sp-walkthrough-highlight-styles')` exists before injecting

    3. **Update `highlightElement` signature:**
       - Change to `highlightElement(selector: string, options?: { active?: boolean }): void`
       - Default behavior (no options or `active: false`) = reddish-brown static glow
       - With `active: true` = green breathing glow

    4. **Update component integration:**
       - In `sp-walkthrough.tsx advanceToScene()`, call `this.overlayManager.highlightElement(scene.highlightSelector)` (default reddish-brown) for normal scene transitions
       - If the scene has an `active` property or is the currently playing scene, optionally pass `{ active: true }` — use discretion on when "active" state applies (reasonable default: active when the scene is actively playing and the highlighted element is the current focus)

    **Overlay manager spec tests:**
    Update `overlay-manager.spec.ts`:
    - Test that `highlightElement(selector)` creates overlay with reddish-brown border color (`#8B4513` or equivalent)
    - Test that `highlightElement(selector, { active: true })` creates overlay with green border and animation property set
    - Test that style injection adds `@keyframes sp-walkthrough-breathe` to document head
    - Test that style injection is idempotent (second call doesn't add duplicate)
    - Test that `clearHighlights()` removes overlays but leaves the injected styles (they're lightweight and reusable)

    **Component spec test updates:**
    Update `sp-walkthrough.spec.ts`:
    - Add tests for scene list popup: toggle state, scene item rendering, scene selection via popup
    - Add tests for volume popup: toggle state, vertical slider presence
    - Add tests for custom caption overlay: verify `activeCueText` state drives overlay rendering
    - Add tests for markdown rendering: verify scene description renders HTML when markdown content provided
    - Update any existing tests that reference the old native `<select>` scene selector
    - Follow established patterns: `page.rootInstance.methodName()`, no `jest.useFakeTimers()` before `waitForChanges()`

    **E2E test updates:**
    Update `sp-walkthrough.e2e.ts`:
    - Verify scene list popup opens/closes
    - Verify volume popup renders vertically
    - Verify caption overlay appears with correct styling when captions enabled
    - Verify highlight overlays have correct colors (reddish-brown border check)
  </action>
  <verify>
    Run `npx stencil test --spec --e2e` — all tests pass.
    Run `npx stencil test --spec --coverage` — sp-walkthrough and overlay-manager coverage meets 70% threshold.
    Run `npx stencil build` — build succeeds.
  </verify>
  <done>
    Highlight overlays use reddish-brown border with dual glow by default. Active highlights use green state with 1.5s breathing animation. Overlay manager tests cover both highlight modes and style injection. Component tests cover scene list popup, volume popup, custom captions, and markdown rendering. All tests pass, coverage meets 70% threshold.
  </done>
</task>

</tasks>

<verification>
1. `npx stencil build` completes without errors
2. `npx stencil test --spec --e2e` — all tests pass
3. Scene list renders as custom popup (no native `<select>`) with title and timestamp per scene
4. Volume control renders as vertical popup slider (not inline horizontal)
5. Captions render as styled dark overlay, not native browser captions
6. Scene descriptions with markdown content render h1-h3, p, ul, ol, code, pre correctly
7. Highlight overlays show reddish-brown border with dual glow (default state)
8. Active highlights show green border with 1.5s breathing animation
9. All popup dismiss behaviors work (outside click, ESC, selection)
</verification>

<success_criteria>
- All 5 requirements (WALK-05, WALK-06, WALK-07, WALK-08, WALK-09) are satisfied
- Build passes, all tests pass, coverage at or above 70%
- Popups, captions, markdown, and highlights match expected prototype behaviors
</success_criteria>

<output>
After completion, create `.planning/phases/08-walkthrough-parity/08-02-SUMMARY.md`
</output>
